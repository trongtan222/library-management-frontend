<div class="container mt-4">
  <div
    class="search-box mb-4 p-4 rounded shadow-sm border border-secondary bg-dark text-light"
  >
    <h2 class="mb-3 text-info">
      <i class="fa-solid fa-book-open"></i> Đăng Ký Mượn Sách
    </h2>

    <div class="row g-3">
      <div class="col-md-5">
        <div class="input-group">
          <span class="input-group-text bg-secondary text-light"
            ><i class="fa-solid fa-search"></i
          ></span>
          <input
            type="text"
            class="form-control bg-dark text-light border-secondary"
            placeholder="Tìm theo tên sách, tác giả..."
            [(ngModel)]="searchTerm"
            (input)="onFilterChange()"
          />
        </div>
      </div>
      <div class="col-md-3">
        <select
          class="form-select bg-dark text-light border-secondary"
          [(ngModel)]="selectedGenre"
          (change)="onGenreChange()"
        >
          <option value="">-- Tất cả thể loại --</option>
          <option *ngFor="let genre of genres" [value]="genre">
            {{ genre }}
          </option>
        </select>
      </div>
      <div class="col-md-2">
        <button class="btn btn-secondary w-100" (click)="resetFilters()">
          <i class="fa-solid fa-rotate-right"></i> Đặt lại
        </button>
      </div>
      <div class="col-md-1">
        <button
          class="btn btn-info w-100 text-dark fw-bold"
          (click)="toggleScanner()"
        >
          <i class="fa-solid fa-qrcode"></i>
        </button>
      </div>
      <div class="col-md-1">
        <button
          class="btn btn-warning position-relative w-100 text-dark fw-bold"
          (click)="toggleCartModal()"
        >
          <i class="fa-solid fa-shopping-cart"></i>
          <span
            *ngIf="cartCount > 0"
            class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
          >
            {{ cartCount }}
          </span>
        </button>
      </div>
    </div>
  </div>

  <!-- Skeleton Loading -->
  <div *ngIf="isLoadingPage" class="row g-4">
    <div class="col-md-3 col-sm-6" *ngFor="let item of skeletonArray">
      <div class="card h-100 book-card border-secondary bg-dark">
        <div class="skeleton skeleton-cover" style="height: 300px"></div>
        <div class="card-body">
          <div class="skeleton skeleton-title mb-2"></div>
          <div class="skeleton skeleton-text mb-3" style="width: 70%"></div>
          <div class="skeleton skeleton-button"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4" *ngIf="!isLoadingPage">
    <div
      class="col-12 text-center py-5 text-muted"
      *ngIf="filteredBooks?.length === 0"
    >
      <i class="fa-solid fa-box-open fa-3x mb-3 d-block opacity-50"></i>
      Không tìm thấy sách nào phù hợp.
    </div>

    <div class="col-md-3 col-sm-6" *ngFor="let book of filteredBooks">
      <div class="card h-100 book-card border-secondary bg-dark text-light">
        <div class="position-relative overflow-hidden rounded-top">
          <a
            [routerLink]="['/books', book.id]"
            style="cursor: pointer"
            title="Xem chi tiết"
          >
            <img
              [src]="book.coverUrl || 'assets/images/placeholder.png'"
              class="card-img-top book-cover"
              style="height: 300px; object-fit: cover"
              alt="{{ book.name }}"
            />
          </a>

          <span
            class="badge position-absolute top-0 end-0 m-2 shadow-sm"
            [ngClass]="
              book.numberOfCopiesAvailable > 0 ? 'bg-success' : 'bg-danger'
            "
          >
            {{
              book.numberOfCopiesAvailable > 0
                ? "Sẵn: " + book.numberOfCopiesAvailable
                : "Hết hàng"
            }}
          </span>
        </div>

        <div class="card-body d-flex flex-column">
          <h6 class="card-title mb-1 text-truncate" title="{{ book.name }}">
            <a
              [routerLink]="['/books', book.id]"
              class="text-decoration-none text-info fw-bold hover-underline"
            >
              {{ book.name }}
            </a>
          </h6>

          <div class="small text-muted mb-2">
            <span *ngIf="book.authors && book.authors.length > 0">
              <i class="fa-solid fa-pen-nib me-1"></i>
              {{ book.authors[0].name }}
            </span>
            <span *ngIf="!book.authors || book.authors.length === 0">
              <i class="fa-solid fa-pen-nib me-1"></i> Đang cập nhật
            </span>
          </div>

          <div class="mt-auto d-flex gap-2">
            <button
              class="btn btn-primary grow btn-sm"
              [disabled]="
                book.numberOfCopiesAvailable <= 0 || isInCart(book.id)
              "
              (click)="addToCart(book)"
            >
              <i
                [ngClass]="
                  isInCart(book.id)
                    ? 'fa-solid fa-check'
                    : 'fa-solid fa-cart-plus'
                "
                class="me-1"
              ></i>
              {{ isInCart(book.id) ? "Đã thêm" : "Thêm vào giỏ" }}
            </button>
            <button
              class="btn btn-outline-info btn-sm"
              (click)="openBorrowForm(book)"
              title="Mượn ngay"
            >
              <i class="fa-solid fa-bolt"></i>
            </button>
            <button
              class="btn btn-outline-warning btn-sm"
              (click)="openReserveModal(book)"
              title="Đặt trước sách"
            >
              <i class="fa-solid fa-clock"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div
    class="d-flex flex-wrap align-items-center justify-content-between mt-4 px-3 py-3 border-top border-secondary"
    *ngIf="!isLoadingPage"
  >
    <div class="d-flex align-items-center gap-2">
      <label class="form-label me-2 mb-0">Hiển thị</label>
      <select
        class="form-select form-select-sm w-auto bg-dark text-light border-secondary"
        [value]="pageSize"
        (change)="changePageSize($event)"
      >
        <option *ngFor="let size of pageSizes" [value]="size">
          {{ size }}
        </option>
      </select>
    </div>
    <div class="d-flex align-items-center gap-2">
      <button
        class="btn btn-sm btn-outline-light"
        (click)="goToPage(currentPage - 1)"
        [disabled]="currentPage <= 1"
      >
        <i class="fa-solid fa-chevron-left"></i> Trước
      </button>
      <button
        class="btn btn-sm btn-outline-light"
        (click)="goToPage(currentPage + 1)"
        [disabled]="currentPage >= totalPages"
      >
        Sau <i class="fa-solid fa-chevron-right"></i>
      </button>
      <span class="text-muted small"
        >Trang {{ currentPage }} / {{ totalPages }} ·
        {{ totalElements }} sách</span
      >
    </div>
  </div>
</div>

<div
  class="modal-backdrop fade show"
  *ngIf="enableScanner"
  style="z-index: 1050"
></div>
<div
  class="modal fade show d-block"
  *ngIf="enableScanner"
  tabindex="-1"
  style="z-index: 1060"
>
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content bg-black border-secondary text-white">
      <div class="modal-header border-secondary">
        <h5 class="modal-title">
          <i class="fa-solid fa-qrcode me-2"></i>Quét Mã Sách
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          (click)="toggleScanner()"
        ></button>
      </div>
      <div
        class="modal-body p-0 text-center position-relative"
        style="min-height: 300px; background: #000"
      >
        <div *ngIf="!hasPermission && enableScanner" class="p-5 text-warning">
          <h4><i class="fa-solid fa-triangle-exclamation"></i></h4>
          <p>Vui lòng cấp quyền truy cập Camera cho trình duyệt.</p>
        </div>

        <zxing-scanner
          *ngIf="enableScanner"
          [formats]="allowedFormats"
          (permissionResponse)="onPermissionResponse($event)"
          (scanSuccess)="onCodeResult($event)"
          style="width: 100%; height: 100%; object-fit: contain"
        >
        </zxing-scanner>

        <div
          *ngIf="hasPermission"
          class="scanner-overlay"
          style="
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
          "
        >
          <div
            style="
              width: 250px;
              height: 250px;
              border: 2px solid #0dcaf0;
              box-shadow: 0 0 0 100vmax rgba(0, 0, 0, 0.5);
            "
          ></div>
        </div>

        <p
          class="text-white mt-2 position-absolute bottom-0 w-100 pb-3"
          style="z-index: 1070"
        >
          <i class="fa-solid fa-qrcode me-2"></i>Quét liên tục - Đã thêm:
          <span class="badge bg-warning text-dark">{{ cartCount }}</span>
        </p>
      </div>
    </div>
  </div>
</div>

<!-- Cart Modal -->
<div
  class="modal-backdrop fade show"
  *ngIf="showCartModal"
  style="z-index: 1055"
></div>
<div
  class="modal fade show d-block"
  *ngIf="showCartModal"
  tabindex="-1"
  style="z-index: 1065"
>
  <div
    class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable"
  >
    <div class="modal-content bg-dark text-light border-secondary">
      <div class="modal-header border-secondary bg-warning">
        <h5 class="modal-title text-dark fw-bold">
          <i class="fa-solid fa-shopping-cart me-2"></i>Giỏ Sách ({{
            cartCount
          }})
        </h5>
        <button
          type="button"
          class="btn-close"
          (click)="toggleCartModal()"
        ></button>
      </div>

      <div class="modal-body p-4" style="max-height: 500px; overflow-y: auto">
        <div *ngIf="cartItems.length === 0" class="text-center py-5 text-muted">
          <i class="fa-solid fa-cart-shopping fa-3x mb-3 opacity-50"></i>
          <p>Giỏ sách trống. Thêm sách để mượn hàng loạt!</p>
        </div>

        <div class="list-group" *ngIf="cartItems.length > 0">
          <div
            *ngFor="let item of cartItems; let i = index"
            class="list-group-item bg-secondary bg-opacity-10 border-secondary mb-2 rounded"
          >
            <div class="d-flex align-items-start">
              <span class="badge bg-primary me-3 mt-1">{{ i + 1 }}</span>
              <img
                [src]="item.book.coverUrl || 'assets/images/placeholder.png'"
                style="width: 50px; height: 75px; object-fit: cover"
                class="me-3 rounded"
              />
              <div class="grow">
                <h6 class="mb-1 fw-bold text-info">{{ item.book.name }}</h6>
                <div class="small text-muted">
                  <span
                    *ngIf="item.book.authors && item.book.authors.length > 0"
                  >
                    {{ item.book.authors[0].name }}
                  </span>
                  <span class="mx-2">·</span>
                  <span class="badge bg-success"
                    >Còn {{ item.book.numberOfCopiesAvailable }}</span
                  >
                </div>
              </div>
              <button
                class="btn btn-sm btn-outline-danger"
                (click)="removeFromCart(item.book.id)"
              >
                <i class="fa-solid fa-trash"></i>
              </button>
            </div>
          </div>
        </div>

        <div
          class="mt-4 p-3 bg-secondary bg-opacity-25 rounded"
          *ngIf="cartItems.length > 0"
        >
          <h6 class="mb-3">Thông tin người mượn:</h6>
          <div class="mb-3">
            <label class="form-label"
              >Họ tên <span class="text-danger">*</span></label
            >
            <input
              type="text"
              class="form-control bg-dark text-light border-secondary"
              [(ngModel)]="borrowData.studentName"
              placeholder="Nhập họ tên..."
            />
          </div>
          <div class="mb-3">
            <label class="form-label"
              >Lớp / Chi Đội <span class="text-danger">*</span></label
            >
            <input
              type="text"
              class="form-control bg-dark text-light border-secondary"
              [(ngModel)]="borrowData.studentClass"
              placeholder="Ví dụ: 9A1"
            />
          </div>
          <div class="mb-3">
            <label class="form-label">Thời hạn</label>
            <select
              class="form-select bg-dark text-light border-secondary"
              [(ngModel)]="borrowData.loanDays"
            >
              <option [ngValue]="7">7 ngày</option>
              <option [ngValue]="14">14 ngày</option>
              <option [ngValue]="30">30 ngày</option>
            </select>
          </div>
        </div>
      </div>

      <div class="modal-footer border-secondary">
        <button
          type="button"
          class="btn btn-outline-danger"
          (click)="clearCart()"
          *ngIf="cartItems.length > 0"
        >
          <i class="fa-solid fa-trash me-1"></i> Xóa tất cả
        </button>
        <button
          type="button"
          class="btn btn-secondary"
          (click)="toggleCartModal()"
        >
          Đóng
        </button>
        <button
          type="button"
          class="btn btn-warning text-dark fw-bold px-4"
          (click)="borrowAllFromCart()"
          [disabled]="cartItems.length === 0"
        >
          <i class="fa-solid fa-check me-1"></i> Mượn tất cả ({{ cartCount }})
        </button>
      </div>
    </div>
  </div>
</div>

<div
  class="modal-backdrop fade show"
  *ngIf="showConfirmModal && !enableScanner"
></div>
<div
  class="modal fade show d-block"
  *ngIf="showConfirmModal && !enableScanner"
  tabindex="-1"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-light border-secondary">
      <div class="modal-header border-secondary bg-primary">
        <h5 class="modal-title text-white fw-bold">
          <i class="fa-solid fa-pen-to-square me-2"></i>Xác nhận Mượn Sách
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          (click)="closeModal()"
        ></button>
      </div>

      <div class="modal-body p-4">
        <div
          class="d-flex align-items-start mb-4 p-3 rounded border border-secondary bg-secondary bg-opacity-25"
        >
          <img
            [src]="selectedBook?.coverUrl || 'assets/images/placeholder.png'"
            style="width: 60px; height: 90px; object-fit: cover"
            class="me-3 rounded border border-secondary"
          />
          <div>
            <h5 class="mb-1 fw-bold text-info">{{ selectedBook?.name }}</h5>
            <div
              class="small text-light opacity-75 mb-1"
              *ngIf="selectedBook?.authors && selectedBook!.authors!.length > 0"
            >
              {{ selectedBook!.authors![0].name }}
            </div>
            <span class="badge bg-success"
              >Còn {{ selectedBook!.numberOfCopiesAvailable }} bản</span
            >
          </div>
        </div>

        <form>
          <div class="mb-3">
            <label class="form-label"
              >Họ tên người mượn <span class="text-danger">*</span></label
            >
            <input
              type="text"
              class="form-control bg-dark text-light border-secondary"
              [(ngModel)]="borrowData.studentName"
              name="sName"
              placeholder="Nhập họ tên..."
            />
          </div>

          <div class="mb-3">
            <label class="form-label"
              >Lớp / Chi Đội <span class="text-danger">*</span></label
            >
            <input
              type="text"
              class="form-control bg-dark text-light border-secondary"
              [(ngModel)]="borrowData.studentClass"
              name="sClass"
              placeholder="Ví dụ: 9A1"
            />
          </div>

          <div class="row">
            <div class="col-6 mb-3">
              <label class="form-label">Thời hạn</label>
              <select
                class="form-select bg-dark text-light border-secondary"
                [(ngModel)]="borrowData.loanDays"
                name="days"
              >
                <option [ngValue]="7">7 ngày</option>
                <option [ngValue]="14">14 ngày</option>
                <option [ngValue]="30">30 ngày</option>
              </select>
            </div>
            <div class="col-6 mb-3">
              <label class="form-label">Số lượng</label>
              <input
                type="number"
                class="form-control bg-dark text-light border-secondary"
                value="1"
                readonly
                disabled
              />
            </div>
          </div>
        </form>
      </div>

      <div class="modal-footer border-secondary">
        <button type="button" class="btn btn-secondary" (click)="closeModal()">
          Hủy
        </button>
        <button
          type="button"
          class="btn btn-primary px-4"
          (click)="confirmBorrow()"
          [disabled]="loading.has(selectedBook?.id || 0)"
        >
          <span
            *ngIf="loading.has(selectedBook?.id || 0)"
            class="spinner-border spinner-border-sm me-1"
          ></span>
          Xác Nhận
        </button>
      </div>
    </div>
  </div>
</div>

<div
  class="modal-backdrop fade show"
  *ngIf="showReserveModal && !enableScanner"
></div>
<div
  class="modal fade show d-block"
  *ngIf="showReserveModal && !enableScanner"
  tabindex="-1"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-light border-secondary">
      <div class="modal-header border-secondary bg-warning">
        <h5 class="modal-title text-dark fw-bold">
          <i class="fa-solid fa-clock me-2"></i>Đăng Ký Đặt Trước
        </h5>
        <button
          type="button"
          class="btn-close"
          (click)="closeReserveModal()"
        ></button>
      </div>
      <div class="modal-body p-4">
        <p>
          Bạn muốn đặt trước cuốn sách <strong>{{ selectedBook?.name }}</strong
          >?
        </p>
        <p class="small text-muted">
          Chúng tôi sẽ giữ sách cho bạn trong 24h khi có người trả.
        </p>

        <form>
          <div class="mb-3">
            <label class="form-label">Họ tên</label>
            <input
              type="text"
              class="form-control bg-dark text-light border-secondary"
              [(ngModel)]="borrowData.studentName"
              name="resName"
            />
          </div>
          <div class="mb-3">
            <label class="form-label">Lớp</label>
            <input
              type="text"
              class="form-control bg-dark text-light border-secondary"
              [(ngModel)]="borrowData.studentClass"
              name="resClass"
            />
          </div>
        </form>
      </div>
      <div class="modal-footer border-secondary">
        <button
          type="button"
          class="btn btn-secondary"
          (click)="closeReserveModal()"
        >
          Hủy
        </button>
        <button
          type="button"
          class="btn btn-warning text-dark fw-bold px-4"
          (click)="confirmReserve()"
        >
          Xác Nhận Đặt
        </button>
      </div>
    </div>
  </div>
</div>
