<main class="auth">
  <div class="auth-bg" aria-hidden="true"></div>

  <section class="auth-card card">
    <!-- Header -->
    <div class="card-header">
      <i class="fas fa-shield-alt"></i>
      <h1>Đặt lại mật khẩu</h1>
    </div>
    <p class="subtitle">Tạo mật khẩu mới mạnh mẽ để bảo vệ tài khoản của bạn</p>

    <!-- Success State -->
    <div *ngIf="resetSuccess" class="success-container">
      <div class="success-icon">
        <i class="fas fa-check-circle"></i>
      </div>
      <h3>Mật khẩu đã được đặt lại thành công!</h3>
      <p class="success-message">
        Bạn có thể đăng nhập với mật khẩu mới ngay bây giờ.
      </p>
      <div class="redirect-countdown">
        <i class="fas fa-clock"></i>
        Đang chuyển hướng đến trang đăng nhập trong
        <strong>{{ redirectCountdown }}</strong> giây...
      </div>
      <button type="button" class="btn btn-primary" (click)="navigateToLogin()">
        <i class="fas fa-sign-in-alt"></i>
        Đăng nhập ngay
      </button>
    </div>

    <!-- Reset Form -->
    <form
      *ngIf="!resetSuccess && tokenValid"
      [formGroup]="resetForm"
      (ngSubmit)="onSubmit()"
      novalidate
    >
      <!-- Security Notice -->
      <div class="security-notice">
        <i class="fas fa-info-circle"></i>
        <div>
          <strong>Lưu ý bảo mật:</strong> Mật khẩu mạnh nên có ít nhất 8 ký tự,
          bao gồm chữ hoa, chữ thường, số và ký tự đặc biệt.
        </div>
      </div>

      <!-- New Password Field -->
      <div class="field">
        <label for="newPassword">
          <i class="fas fa-key"></i>
          Mật khẩu mới
        </label>
        <div class="password-input-wrapper">
          <input
            id="newPassword"
            formControlName="newPassword"
            [type]="showPassword ? 'text' : 'password'"
            class="form-control"
            [class.is-invalid]="
              resetForm.get('newPassword')?.invalid &&
              resetForm.get('newPassword')?.touched
            "
            placeholder="Nhập mật khẩu mới"
            autocomplete="new-password"
          />
          <button
            type="button"
            class="toggle-password"
            (click)="togglePasswordVisibility()"
            [attr.aria-label]="showPassword ? 'Ẩn mật khẩu' : 'Hiện mật khẩu'"
          >
            <i [class]="showPassword ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
          </button>
        </div>

        <!-- Password Strength Meter -->
        <div
          class="password-strength-meter"
          *ngIf="resetForm.get('newPassword')?.value"
        >
          <div class="strength-bar">
            <div
              class="strength-fill"
              [style.width.%]="passwordStrength"
              [class.strength-danger]="passwordStrengthColor === 'danger'"
              [class.strength-warning]="passwordStrengthColor === 'warning'"
              [class.strength-success]="passwordStrengthColor === 'success'"
            ></div>
          </div>
          <span
            class="strength-label"
            [class]="'text-' + passwordStrengthColor"
          >
            Độ mạnh: {{ passwordStrengthLabel }}
          </span>
        </div>

        <!-- Password Requirements -->
        <div
          class="password-requirements"
          *ngIf="resetForm.get('newPassword')?.value"
        >
          <div class="requirement" [class.met]="hasUpperCase">
            <i
              [class]="hasUpperCase ? 'fas fa-check-circle' : 'fas fa-circle'"
            ></i>
            Có chữ hoa (A-Z)
          </div>
          <div class="requirement" [class.met]="hasLowerCase">
            <i
              [class]="hasLowerCase ? 'fas fa-check-circle' : 'fas fa-circle'"
            ></i>
            Có chữ thường (a-z)
          </div>
          <div class="requirement" [class.met]="hasNumber">
            <i
              [class]="hasNumber ? 'fas fa-check-circle' : 'fas fa-circle'"
            ></i>
            Có số (0-9)
          </div>
          <div class="requirement" [class.met]="hasSpecialChar">
            <i
              [class]="hasSpecialChar ? 'fas fa-check-circle' : 'fas fa-circle'"
            ></i>
            Có ký tự đặc biệt (!@#$%...)
          </div>
          <div class="requirement" [class.met]="isLongEnough">
            <i
              [class]="isLongEnough ? 'fas fa-check-circle' : 'fas fa-circle'"
            ></i>
            Tối thiểu 8 ký tự
          </div>
        </div>

        <div
          *ngIf="
            resetForm.get('newPassword')?.invalid &&
            resetForm.get('newPassword')?.touched
          "
          class="invalid-feedback"
        >
          <div *ngIf="resetForm.get('newPassword')?.hasError('required')">
            Vui lòng nhập mật khẩu mới
          </div>
          <div *ngIf="resetForm.get('newPassword')?.hasError('minlength')">
            Mật khẩu phải có ít nhất 6 ký tự
          </div>
          <div *ngIf="resetForm.get('newPassword')?.hasError('weakPassword')">
            Mật khẩu quá yếu. Vui lòng thêm chữ hoa, số hoặc ký tự đặc biệt
          </div>
        </div>
      </div>

      <!-- Confirm Password Field (with paste blocking) -->
      <div class="field">
        <label for="confirmPassword">
          <i class="fas fa-lock"></i>
          Xác nhận mật khẩu
        </label>
        <div class="password-input-wrapper">
          <input
            id="confirmPassword"
            formControlName="confirmPassword"
            [type]="showConfirmPassword ? 'text' : 'password'"
            class="form-control"
            [class.is-invalid]="
              (resetForm.get('confirmPassword')?.invalid ||
                resetForm.hasError('passwordMismatch')) &&
              resetForm.get('confirmPassword')?.touched
            "
            placeholder="Nhập lại mật khẩu mới"
            autocomplete="new-password"
            (paste)="preventPaste($event)"
          />
          <button
            type="button"
            class="toggle-password"
            (click)="toggleConfirmPasswordVisibility()"
            [attr.aria-label]="
              showConfirmPassword ? 'Ẩn mật khẩu' : 'Hiện mật khẩu'
            "
          >
            <i
              [class]="showConfirmPassword ? 'fas fa-eye-slash' : 'fas fa-eye'"
            ></i>
          </button>
        </div>

        <!-- Paste Blocked Notice -->
        <div class="paste-notice">
          <i class="fas fa-ban"></i>
          <small>Không thể dán - Vui lòng gõ lại để xác nhận</small>
        </div>

        <div
          *ngIf="
            resetForm.hasError('passwordMismatch') &&
            resetForm.get('confirmPassword')?.touched
          "
          class="invalid-feedback"
        >
          Mật khẩu xác nhận không khớp
        </div>
      </div>

      <!-- Submit Button -->
      <button
        class="btn btn-primary btn-block"
        type="submit"
        [disabled]="resetForm.invalid || loading"
      >
        <span *ngIf="loading" class="spinner-border spinner-border-sm"></span>
        <i *ngIf="!loading" class="fas fa-check"></i>
        {{ loading ? "Đang cập nhật..." : "Đặt lại mật khẩu" }}
      </button>

      <!-- Back to Login Link -->
      <div class="text-center mt-4">
        <a routerLink="/login" class="link">
          <i class="fas fa-arrow-left"></i>
          Quay lại đăng nhập
        </a>
      </div>
    </form>

    <!-- Invalid Token State -->
    <div *ngIf="!resetSuccess && !tokenValid" class="error-container">
      <div class="error-icon">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
      <h3>Token không hợp lệ</h3>
      <p>
        Vui lòng kiểm tra lại liên kết trong email hoặc yêu cầu đặt lại mật khẩu
        mới.
      </p>
      <div class="action-buttons">
        <a routerLink="/forgot-password" class="btn btn-primary">
          <i class="fas fa-envelope"></i>
          Gửi lại email
        </a>
        <a routerLink="/" class="btn btn-secondary">
          <i class="fas fa-home"></i>
          Về trang chủ
        </a>
      </div>
    </div>
  </section>
</main>
