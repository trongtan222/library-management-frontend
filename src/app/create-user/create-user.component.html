<div class="container col-md-8 offset-md-2 mt-5">
  <div class="header-section">
    <h3 class="text-center">T·∫°o Ng∆∞·ªùi D√πng M·ªõi</h3>
    <button class="btn btn-outline-info btn-sm" (click)="goToBulkImport()">
      <i class="fas fa-file-excel"></i> Import h√†ng lo·∫°t t·ª´ Excel
    </button>
  </div>

  <form (ngSubmit)="onSubmit()" #userForm="ngForm">
    <!-- Avatar Upload -->
    <div class="avatar-section mb-4">
      <label class="form-label">·∫¢nh ƒë·∫°i di·ªán (kh√¥ng b·∫Øt bu·ªôc)</label>
      <div class="avatar-upload-container">
        <div class="avatar-preview" *ngIf="avatarPreview; else noAvatar">
          <img [src]="avatarPreview" alt="Avatar preview" />
          <button
            type="button"
            class="btn-remove-avatar"
            (click)="removeAvatar()"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
        <ng-template #noAvatar>
          <div class="avatar-placeholder">
            <i class="fas fa-user fa-3x"></i>
            <p>Ch·ªçn ·∫£nh</p>
          </div>
        </ng-template>
        <input
          type="file"
          id="avatarInput"
          accept="image/*"
          (change)="onAvatarSelected($event)"
          hidden
        />
        <label for="avatarInput" class="btn btn-secondary btn-sm mt-2">
          <i class="fas fa-upload"></i> Ch·ªçn ·∫£nh (Max 2MB)
        </label>
      </div>
    </div>

    <div class="row">
      <div class="col-md-6">
        <div class="form-group mb-3">
          <label class="form-label">T√™n <span class="required">*</span></label>
          <input
            type="text"
            class="form-control"
            [(ngModel)]="user.name"
            name="name"
            required
          />
        </div>
      </div>

      <div class="col-md-6">
        <div class="form-group mb-3">
          <label class="form-label"
            >Email <span class="required">*</span></label
          >
          <div class="input-with-icon">
            <input
              type="email"
              class="form-control"
              [(ngModel)]="user.email"
              name="email"
              required
              email
              #email="ngModel"
              (ngModelChange)="onEmailChange($event)"
              [class.is-invalid]="
                (email.invalid && email.touched) || emailExists
              "
              [class.is-valid]="emailValid && !emailExists && !emailChecking"
            />
            <i class="fas fa-spinner fa-spin" *ngIf="emailChecking"></i>
            <i
              class="fas fa-check-circle text-success"
              *ngIf="emailValid && !emailExists && !emailChecking"
            ></i>
          </div>
          <div *ngIf="email.invalid && email.touched" class="invalid-feedback">
            <span *ngIf="email.errors?.['required']">Vui l√≤ng nh·∫≠p email.</span>
            <span *ngIf="email.errors?.['email']"
              >Vui l√≤ng nh·∫≠p m·ªôt ƒë·ªãa ch·ªâ email h·ª£p l·ªá.</span
            >
          </div>
          <div *ngIf="emailExists" class="invalid-feedback">
            Email n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng trong h·ªá th·ªëng.
          </div>
        </div>
      </div>
    </div>

    <div class="form-group mb-3">
      <label class="form-label"
        >T√™n ƒêƒÉng Nh·∫≠p <span class="required">*</span></label
      >
      <input
        type="text"
        class="form-control"
        [(ngModel)]="user.username"
        name="username"
        required
      />
    </div>

    <div class="row">
      <div class="col-md-6">
        <div class="form-group mb-3">
          <label class="form-label">
            M·∫≠t Kh·∫©u <span class="required">*</span>
            <button
              type="button"
              class="btn-generate"
              (click)="generatePassword()"
              title="T·∫°o m·∫≠t kh·∫©u m·∫°nh"
            >
              üé≤ T·∫°o t·ª± ƒë·ªông
            </button>
          </label>
          <div class="password-input-group">
            <input
              [type]="showPassword ? 'text' : 'password'"
              class="form-control"
              [(ngModel)]="user.password"
              name="password"
              required
              (ngModelChange)="checkPasswordStrength($event)"
            />
            <button
              type="button"
              class="btn-toggle-password"
              (click)="togglePasswordVisibility()"
            >
              <i
                class="fas"
                [ngClass]="showPassword ? 'fa-eye-slash' : 'fa-eye'"
              ></i>
            </button>
          </div>
          <div class="password-strength" *ngIf="passwordStrength">
            <div class="strength-bar" [ngClass]="passwordStrength">
              <div class="strength-fill"></div>
            </div>
            <small class="strength-text" [ngClass]="passwordStrength">
              <span *ngIf="passwordStrength === 'weak'">‚ö†Ô∏è Y·∫øu</span>
              <span *ngIf="passwordStrength === 'medium'">‚úì Trung b√¨nh</span>
              <span *ngIf="passwordStrength === 'strong'">‚úì‚úì M·∫°nh</span>
            </small>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="form-group mb-3">
          <label class="form-label"
            >X√°c Nh·∫≠n M·∫≠t Kh·∫©u <span class="required">*</span></label
          >
          <input
            [type]="showPassword ? 'text' : 'password'"
            class="form-control"
            [(ngModel)]="confirmPassword"
            name="confirmPassword"
            required
            [class.is-invalid]="
              confirmPassword && user.password !== confirmPassword
            "
            [class.is-valid]="
              confirmPassword && user.password === confirmPassword
            "
          />
          <div
            *ngIf="confirmPassword && user.password !== confirmPassword"
            class="invalid-feedback"
          >
            M·∫≠t kh·∫©u kh√¥ng kh·ªõp
          </div>
        </div>
      </div>
    </div>

    <div class="form-group mb-3">
      <label class="form-label">Vai Tr√≤ <span class="required">*</span></label>
      <select
        class="form-select"
        [(ngModel)]="selectedRole"
        name="role"
        required
      >
        <option *ngFor="let role of rolesOptions" [ngValue]="role">
          {{ role === "ROLE_USER" ? "üë§ Ng∆∞·ªùi d√πng" : "üëë Qu·∫£n tr·ªã vi√™n" }}
        </option>
      </select>
    </div>

    <div class="form-check mb-4">
      <input
        class="form-check-input"
        type="checkbox"
        [(ngModel)]="sendInvitation"
        name="sendInvitation"
        id="sendInvitation"
      />
      <label class="form-check-label" for="sendInvitation">
        üìß G·ª≠i email m·ªùi v·ªõi th√¥ng tin ƒëƒÉng nh·∫≠p cho ng∆∞·ªùi d√πng
      </label>
      <div class="form-text">
        Ng∆∞·ªùi d√πng s·∫Ω nh·∫≠n ƒë∆∞·ª£c email ch√†o m·ª´ng k√®m username v√† m·∫≠t kh·∫©u.
      </div>
    </div>

    <div class="action-buttons">
      <button
        class="btn btn-success"
        type="submit"
        [disabled]="
          isLoading || userForm.invalid || emailExists || emailChecking
        "
      >
        <span *ngIf="isLoading" class="spinner-border spinner-border-sm"></span>
        <i class="fas fa-user-plus" *ngIf="!isLoading"></i>
        {{ isLoading ? "ƒêang T·∫°o..." : "T·∫°o Ng∆∞·ªùi D√πng" }}
      </button>
      <button
        class="btn btn-outline-secondary"
        type="button"
        routerLink="/users"
      >
        <i class="fas fa-times"></i> H·ªßy
      </button>
    </div>
  </form>
</div>
