<div class="container py-5">
  <div *ngIf="isLoading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status"></div>
    <p class="mt-2 text-muted">ƒêang t·∫£i h·ªì s∆°...</p>
  </div>

  <div class="row g-4" *ngIf="!isLoading && userProfile">
    <!-- LEFT SIDEBAR: User Info & Navigation -->
    <div class="col-lg-4">
      <!-- Member Card -->
      <div class="card member-card text-white mb-4 shadow-lg border-0">
        <div class="card-body p-4 position-relative overflow-hidden">
          <div class="member-badge">THCS PHUONG TU</div>
          <div class="d-flex align-items-center mb-4 mt-2">
            <div class="avatar-placeholder me-3">
              {{ userProfile.name.charAt(0) || "?" | uppercase }}
            </div>
            <div>
              <h5 class="mb-0 fw-bold text-truncate" style="max-width: 200px">
                {{ userProfile.name }}
              </h5>
              <small class="opacity-75">ID: {{ userProfile.userId }}</small>
            </div>
          </div>
          <div class="member-details">
            <div class="d-flex justify-content-between mb-1">
              <span>Vai tr√≤</span>
              <span class="fw-bold">{{ userProfile.roles.join(", ") }}</span>
            </div>
            <div class="d-flex justify-content-between">
              <span>Tr·∫°ng th√°i</span>
              <span class="badge bg-success">Ho·∫°t ƒë·ªông</span>
            </div>
          </div>

          <!-- Level Progress Bar (Gamification) -->
          <div class="level-progress-section mt-4" *ngIf="gamificationStats">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div>
                <span
                  class="badge"
                  [style.background-color]="currentLevelInfo.color"
                  >{{ currentLevelInfo.name }}</span
                >
                <small class="ms-2 opacity-75"
                  >C·∫•p {{ currentLevelInfo.level }}</small
                >
              </div>
              <small class="opacity-75"
                >{{ gamificationStats.totalPoints }} ƒëi·ªÉm</small
              >
            </div>
            <div
              class="progress"
              style="height: 8px; background-color: rgba(255, 255, 255, 0.2)"
            >
              <div
                class="progress-bar progress-bar-animated"
                role="progressbar"
                [style.width.%]="levelProgressPercent"
                [style.background-color]="currentLevelInfo.color"
              ></div>
            </div>
            <small class="opacity-75 d-block mt-1" *ngIf="nextLevelInfo">
              C·∫ßn th√™m {{ pointsToNextLevel }} ƒëi·ªÉm ƒë·ªÉ l√™n
              {{ nextLevelInfo.name }}
            </small>
            <small class="opacity-75 d-block mt-1" *ngIf="!nextLevelInfo">
              üéâ B·∫°n ƒë√£ ƒë·∫°t c·∫•p ƒë·ªô cao nh·∫•t!
            </small>
          </div>

          <!-- Decor circle -->
          <div class="circle-decor"></div>
        </div>
      </div>

      <!-- Navigation Menu -->
      <div class="list-group shadow-sm rounded-3 overflow-hidden border-0">
        <button
          class="list-group-item list-group-item-action p-3 d-flex align-items-center"
          [class.active-menu]="currentTab === 'PROFILE'"
          (click)="changeTab('PROFILE')"
        >
          <i class="fa-solid fa-id-card me-3 width-20"></i> H·ªì S∆° C√° Nh√¢n
        </button>
        <button
          class="list-group-item list-group-item-action p-3 d-flex align-items-center"
          [class.active-menu]="currentTab === 'ACTIVE'"
          (click)="changeTab('ACTIVE')"
        >
          <i class="fa-solid fa-book-open-reader me-3 width-20"></i> S√°ch ƒêang
          M∆∞·ª£n
          <span
            class="badge bg-primary rounded-pill ms-auto"
            *ngIf="activeLoans.length"
            >{{ activeLoans.length }}</span
          >
        </button>
        <button
          class="list-group-item list-group-item-action p-3 d-flex align-items-center"
          [class.active-menu]="currentTab === 'HISTORY'"
          (click)="changeTab('HISTORY')"
        >
          <i class="fa-solid fa-clock-rotate-left me-3 width-20"></i> L·ªãch S·ª≠
          Tr·∫£
        </button>
        <button
          class="list-group-item list-group-item-action p-3 d-flex align-items-center"
          [class.active-menu]="currentTab === 'FINES'"
          (click)="changeTab('FINES')"
        >
          <i class="fa-solid fa-file-invoice-dollar me-3 width-20"></i> Ph√≠ Ph·∫°t
          <span
            class="badge bg-danger rounded-pill ms-auto"
            *ngIf="myFines.length"
            >{{ myFines.length }}</span
          >
        </button>
        <button
          class="list-group-item list-group-item-action p-3 d-flex align-items-center"
          [class.active-menu]="currentTab === 'REVIEWS'"
          (click)="changeTab('REVIEWS')"
        >
          <i class="fa-solid fa-comments me-3 width-20"></i> ƒê√°nh Gi√° C·ªßa T√¥i
          <span
            class="badge bg-secondary rounded-pill ms-auto"
            *ngIf="myReviews.length"
            >{{ myReviews.length }}</span
          >
        </button>
        <button
          class="list-group-item list-group-item-action p-3 d-flex align-items-center"
          [class.active-menu]="currentTab === 'STATS'"
          (click)="changeTab('STATS')"
        >
          <i class="fa-solid fa-chart-line me-3 width-20"></i> Th·ªëng K√™ ƒê·ªçc S√°ch
        </button>
        <button
          class="list-group-item list-group-item-action p-3 d-flex align-items-center"
          [class.active-menu]="currentTab === 'BADGES'"
          (click)="changeTab('BADGES')"
        >
          <i class="fa-solid fa-trophy me-3 width-20"></i> Huy Hi·ªáu
          <span
            class="badge bg-warning rounded-pill ms-auto"
            *ngIf="myBadges.length"
            >{{ myBadges.length }}</span
          >
        </button>
        <button
          class="list-group-item list-group-item-action p-3 d-flex align-items-center"
          [class.active-menu]="currentTab === 'SETTINGS'"
          (click)="changeTab('SETTINGS')"
        >
          <i class="fa-solid fa-gear me-3 width-20"></i> C√†i ƒê·∫∑t
        </button>
      </div>
    </div>

    <!-- RIGHT CONTENT -->
    <div class="col-lg-8">
      <!-- 1. PROFILE TAB -->
      <div *ngIf="currentTab === 'PROFILE'" class="animate-fade-in">
        <h3 class="mb-4 fw-bold">T·ªïng Quan</h3>

        <!-- Stats Row -->
        <div class="row g-3 mb-4">
          <div class="col-md-4">
            <div class="stat-box bg-dark border-secondary p-3 rounded">
              <div class="small text-uppercase">ƒê√£ M∆∞·ª£n</div>
              <div class="h2 mb-0 text-info">
                {{ totalBorrowed }} <small class="fs-6">cu·ªën</small>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="stat-box bg-dark border-secondary p-3 rounded">
              <div class="small text-uppercase">ƒêang Gi·ªØ</div>
              <div class="h2 mb-0 text-info">
                {{ activeLoans.length }} <small class="fs-6">cu·ªën</small>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="stat-box bg-dark border-secondary p-3 rounded">
              <div class="small text-uppercase">N·ª£ Ph·∫°t</div>
              <div class="h2 mb-0 text-danger">
                {{ totalFinesAmount | currency: "VND" : "symbol" : "1.0-0" }}
              </div>
            </div>
          </div>
        </div>

        <div class="card bg-dark border-secondary text-light">
          <div class="card-header border-secondary fw-bold">
            Th√¥ng Tin Chi Ti·∫øt
          </div>
          <div class="card-body">
            <div class="row mb-3">
              <div class="col-sm-4">H·ªç v√† t√™n</div>
              <div class="col-sm-8 fw-bold">{{ userProfile.name }}</div>
            </div>
            <div class="row mb-3">
              <div class="col-sm-4">T√™n ƒëƒÉng nh·∫≠p</div>
              <div class="col-sm-8">{{ userProfile.username }}</div>
            </div>
            <div class="row mb-3">
              <div class="col-sm-4">Email</div>
              <div class="col-sm-8">
                {{ userProfile.email || "Ch∆∞a c·∫≠p nh·∫≠t" }}
              </div>
            </div>
            <div class="row">
              <div class="col-sm-4">Nh√≥m quy·ªÅn</div>
              <div class="col-sm-8">
                <span class="badge bg-secondary">{{
                  userProfile.roles.join(", ")
                }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 2. ACTIVE LOANS TAB -->
      <div *ngIf="currentTab === 'ACTIVE'" class="animate-fade-in">
        <h3 class="mb-4 fw-bold text-white">S√°ch ƒêang M∆∞·ª£n</h3>

        <div
          *ngIf="activeLoans.length === 0"
          class="alert alert-dark border-secondary text-center py-4"
        >
          <i class="fa-solid fa-book-open mb-3 fa-2x text-muted"></i>
          <p class="mb-0 text-muted">B·∫°n kh√¥ng m∆∞·ª£n cu·ªën s√°ch n√†o hi·ªán t·∫°i.</p>
          <a routerLink="/borrow-book" class="btn btn-primary mt-3 btn-sm"
            >ƒêi M∆∞·ª£n S√°ch Ngay</a
          >
        </div>

        <div
          class="card bg-dark border-secondary mb-3"
          *ngFor="let loan of activeLoans"
        >
          <div
            class="card-body d-flex justify-content-between align-items-center flex-wrap gap-3"
          >
            <div>
              <h5 class="card-title text-info mb-1">{{ loan.bookName }}</h5>
              <div class="text-muted small mb-2">
                <i class="fa-regular fa-calendar me-1"></i> M∆∞·ª£n:
                {{ loan.loanDate | date: "dd/MM/yyyy" }} &bull;
                <i class="fa-regular fa-calendar-xmark me-1"></i> H·∫°n:
                {{ loan.dueDate | date: "dd/MM/yyyy" }}
              </div>
              <span
                class="badge"
                [ngClass]="
                  loan.status === 'OVERDUE' ? 'bg-danger' : 'bg-success'
                "
              >
                {{ loan.status === "OVERDUE" ? "QU√Å H·∫†N" : "ƒêANG M∆Ø·ª¢N" }}
              </span>
              <ng-container *ngIf="isRenewalStatus(loan.loanId, 'PENDING')">
                <span class="badge bg-warning ms-2">ƒêang ch·ªù gia h·∫°n</span>
              </ng-container>
              <ng-container *ngIf="isRenewalStatus(loan.loanId, 'REJECTED')">
                <span class="badge bg-danger ms-2">Y√™u c·∫ßu b·ªã t·ª´ ch·ªëi</span>
              </ng-container>
              <ng-container *ngIf="isRenewalStatus(loan.loanId, 'APPROVED')">
                <span class="badge bg-info ms-2">Gia h·∫°n ƒë√£ duy·ªát</span>
              </ng-container>
            </div>
            <button
              class="btn btn-outline-warning btn-sm"
              (click)="renewLoan(loan.loanId)"
              [disabled]="isPendingRenewal(loan.loanId)"
            >
              <i class="fa-solid fa-rotate-right me-1"></i>
              {{ isPendingRenewal(loan.loanId) ? "ƒêang Ch·ªù" : "Gia H·∫°n" }}
            </button>
          </div>
        </div>
      </div>

      <!-- 3. HISTORY TAB -->
      <div *ngIf="currentTab === 'HISTORY'" class="animate-fade-in">
        <h3 class="mb-4 fw-bold">L·ªãch S·ª≠ Tr·∫£ S√°ch</h3>
        <div class="table-responsive">
          <table
            class="table table-dark table-hover border-secondary rounded overflow-hidden"
          >
            <thead>
              <tr>
                <th>S√°ch</th>
                <th>Ng√†y M∆∞·ª£n</th>
                <th>Ng√†y Tr·∫£</th>
                <th>Tr·∫°ng Th√°i</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let loan of pagedHistoryLoans">
                <td>{{ loan.bookName }}</td>
                <td>{{ loan.loanDate | date: "dd/MM/yyyy" }}</td>
                <td>{{ loan.returnDate | date: "dd/MM/yyyy" }}</td>
                <td><span class="badge bg-secondary">ƒê√£ Tr·∫£</span></td>
              </tr>
              <tr *ngIf="historyLoans.length === 0">
                <td colspan="4" class="text-center py-4">
                  Ch∆∞a c√≥ l·ªãch s·ª≠ tr·∫£ s√°ch.
                </td>
              </tr>
            </tbody>
          </table>
          <div
            class="d-flex flex-wrap align-items-center justify-content-between px-3 py-3 border-top border-secondary"
            *ngIf="historyLoans.length > 0"
          >
            <div class="d-flex align-items-center gap-2">
              <label class="form-label me-2 mb-0">Hi·ªÉn th·ªã</label>
              <select
                class="form-select form-select-sm w-auto bg-dark text-light border-secondary"
                [value]="historyPageSize"
                (change)="changeHistoryPageSize($event)"
              >
                <option *ngFor="let size of historyPageSizes" [value]="size">
                  {{ size }}
                </option>
              </select>
            </div>
            <div class="d-flex align-items-center gap-2">
              <button
                class="btn btn-sm btn-outline-secondary"
                (click)="prevHistoryPage()"
                [disabled]="historyPage <= 1"
              >
                Tr∆∞·ªõc
              </button>
              <button
                class="btn btn-sm btn-outline-secondary"
                (click)="nextHistoryPage()"
                [disabled]="historyPage >= historyTotalPages"
              >
                Ti·∫øp
              </button>
              <span class="text-muted small"
                >Trang {{ historyPage }} / {{ historyTotalPages }} ¬∑
                {{ historyLoans.length }} d√≤ng</span
              >
            </div>
          </div>
        </div>
      </div>

      <!-- 4. FINES TAB -->
      <div *ngIf="currentTab === 'FINES'" class="animate-fade-in">
        <h3 class="mb-4 fw-bold">Danh S√°ch Ph√≠ Ph·∫°t</h3>

        <div
          *ngIf="myFines.length === 0"
          class="alert alert-success bg-opacity-25 border-success text-success"
        >
          <i class="fa-solid fa-check-circle me-2"></i> Tuy·ªát v·ªùi! B·∫°n kh√¥ng c√≥
          kho·∫£n ph·∫°t n√†o.
        </div>

        <div
          class="card bg-dark border-danger mb-3"
          *ngFor="let fine of myFines"
        >
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <h5 class="text-info">{{ fine.bookName }}</h5>
                <p class="text-muted small mb-0">
                  Qu√° h·∫°n {{ fine.overdueDays }} ng√†y
                </p>
                <small class="text-muted"
                  >H·∫°n tr·∫£: {{ fine.dueDate | date: "dd/MM/yyyy" }}</small
                >
              </div>
              <div class="text-end">
                <div class="h4 text-danger mb-0">
                  {{ fine.fineAmount | currency: "VND" : "symbol" : "1.0-0" }}
                </div>
                <small class="text-warning">Ch∆∞a thanh to√°n</small>
              </div>
            </div>
          </div>
          <div
            class="card-footer bg-danger bg-opacity-10 border-danger text-white small"
          >
            Vui l√≤ng li√™n h·ªá th·ªß th∆∞ ƒë·ªÉ thanh to√°n kho·∫£n ph·∫°t n√†y.
          </div>
        </div>
      </div>

      <!-- 5. MY REVIEWS TAB -->
      <div *ngIf="currentTab === 'REVIEWS'" class="animate-fade-in">
        <h3 class="mb-4 fw-bold">ƒê√°nh Gi√° C·ªßa T√¥i</h3>

        <div
          *ngIf="myReviews.length === 0"
          class="alert alert-dark border-secondary text-center py-4"
        >
          <i class="fa-solid fa-comments mb-3 fa-2x text-muted"></i>
          <p class="mb-0 text-muted">B·∫°n ch∆∞a c√≥ ƒë√°nh gi√° n√†o.</p>
        </div>

        <div
          class="card bg-dark border-secondary mb-3"
          *ngFor="let r of myReviews"
        >
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <h5 class="text-info mb-1">{{ r.bookName }}</h5>
                <div class="text-muted small mb-2">
                  <i class="fa-regular fa-calendar me-1"></i>
                  {{ r.createdAt | date: "dd/MM/yyyy HH:mm" }}
                  <span
                    class="badge ms-2"
                    [ngClass]="r.approved ? 'bg-success' : 'bg-warning'"
                  >
                    {{ r.approved ? "ƒê√£ duy·ªát" : "Ch·ªù duy·ªát" }}
                  </span>
                </div>
                <div
                  *ngIf="
                    !editingReview || editingReview.id !== r.id;
                    else editReviewTpl
                  "
                >
                  <div class="mb-2">
                    <span class="badge bg-primary">{{ r.rating }}/5 ‚≠ê</span>
                  </div>
                  <p class="mb-0">{{ r.comment || "‚Äî" }}</p>
                </div>
              </div>
              <div class="text-end">
                <button
                  class="btn btn-sm btn-outline-primary me-2"
                  (click)="startEditReview(r)"
                  *ngIf="!editingReview || editingReview.id !== r.id"
                >
                  <i class="fa-solid fa-pen"></i> S·ª≠a
                </button>
                <button
                  class="btn btn-sm btn-outline-danger"
                  (click)="deleteMyReview(r)"
                >
                  <i class="fa-solid fa-trash"></i> X√≥a
                </button>
              </div>
            </div>

            <ng-template #editReviewTpl>
              <div class="row g-2 mt-2">
                <div class="col-sm-3">
                  <label class="form-label">ƒêi·ªÉm (1-5)</label>
                  <input
                    type="number"
                    min="1"
                    max="5"
                    class="form-control bg-dark text-light border-secondary"
                    [(ngModel)]="editingReview!.rating"
                  />
                </div>
                <div class="col-sm-9">
                  <label class="form-label">B√¨nh lu·∫≠n</label>
                  <textarea
                    rows="2"
                    class="form-control bg-dark text-light border-secondary"
                    [(ngModel)]="editingReview!.comment"
                  ></textarea>
                </div>
              </div>
              <div class="mt-2">
                <button
                  class="btn btn-sm btn-primary me-2"
                  [disabled]="savingReview"
                  (click)="saveMyReview()"
                >
                  <i class="fa-solid fa-save"></i>
                  {{ savingReview ? "ƒêang l∆∞u..." : "L∆∞u" }}
                </button>
                <button
                  class="btn btn-sm btn-secondary"
                  (click)="cancelEditReview()"
                >
                  H·ªßy
                </button>
              </div>
            </ng-template>
          </div>
        </div>
      </div>

      <!-- 6. STATS TAB -->
      <div *ngIf="currentTab === 'STATS'" class="animate-fade-in">
        <h3 class="mb-4 fw-bold">üìä Th·ªëng K√™ ƒê·ªçc S√°ch</h3>

        <!-- Stats Summary Cards -->
        <div class="row g-3 mb-4">
          <div class="col-md-3 col-sm-6">
            <div
              class="stat-card bg-gradient-primary text-white p-4 rounded shadow"
            >
              <div class="stat-icon mb-2">
                <i class="fa-solid fa-book-open fa-2x"></i>
              </div>
              <div class="stat-value display-5 fw-bold">
                {{ readingStats.booksThisYear }}
              </div>
              <div class="stat-label opacity-75">S√°ch nƒÉm nay</div>
            </div>
          </div>
          <div class="col-md-3 col-sm-6">
            <div
              class="stat-card bg-gradient-success text-white p-4 rounded shadow"
            >
              <div class="stat-icon mb-2">
                <i class="fa-solid fa-calendar-day fa-2x"></i>
              </div>
              <div class="stat-value display-5 fw-bold">
                {{ readingStats.booksThisMonth }}
              </div>
              <div class="stat-label opacity-75">S√°ch th√°ng n√†y</div>
            </div>
          </div>
          <div class="col-md-3 col-sm-6">
            <div
              class="stat-card bg-gradient-warning text-white p-4 rounded shadow"
            >
              <div class="stat-icon mb-2">
                <i class="fa-solid fa-file-lines fa-2x"></i>
              </div>
              <div class="stat-value display-5 fw-bold">
                {{ readingStats.totalPages }}
              </div>
              <div class="stat-label opacity-75">Trang ∆∞·ªõc t√≠nh</div>
            </div>
          </div>
          <div class="col-md-3 col-sm-6">
            <div
              class="stat-card bg-gradient-info text-white p-4 rounded shadow"
            >
              <div class="stat-icon mb-2">
                <i class="fa-solid fa-chart-simple fa-2x"></i>
              </div>
              <div class="stat-value display-5 fw-bold">
                {{ readingStats.averagePerMonth }}
              </div>
              <div class="stat-label opacity-75">TB s√°ch/th√°ng</div>
            </div>
          </div>
        </div>

        <!-- Monthly Chart -->
        <div class="card bg-dark border-secondary text-light">
          <div class="card-header border-secondary fw-bold">
            <i class="fa-solid fa-chart-column me-2"></i> S√°ch M∆∞·ª£n Theo Th√°ng
            (12 th√°ng qua)
          </div>
          <div class="card-body">
            <div
              class="monthly-chart"
              *ngIf="readingStats.monthlyData.length > 0"
            >
              <div
                class="chart-bars d-flex align-items-end justify-content-around"
                style="height: 200px"
              >
                <div
                  class="chart-bar-wrapper text-center"
                  *ngFor="let data of readingStats.monthlyData"
                >
                  <div
                    class="chart-bar bg-primary"
                    [style.height.%]="(data.count / maxMonthlyCount) * 100"
                    [title]="data.month + ': ' + data.count + ' cu·ªën'"
                  >
                    <span class="chart-value" *ngIf="data.count > 0">{{
                      data.count
                    }}</span>
                  </div>
                  <div class="chart-label small mt-2">{{ data.month }}</div>
                </div>
              </div>
            </div>
            <div
              *ngIf="readingStats.monthlyData.length === 0"
              class="text-center py-4 text-muted"
            >
              Ch∆∞a c√≥ d·ªØ li·ªáu th·ªëng k√™
            </div>
          </div>
        </div>

        <!-- Gamification Stats (if available) -->
        <div
          class="card bg-dark border-secondary text-light mt-4"
          *ngIf="gamificationStats"
        >
          <div class="card-header border-secondary fw-bold">
            <i class="fa-solid fa-gamepad me-2"></i> Th√†nh T·ª±u
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-4">
                <div class="achievement-item">
                  <i class="fa-solid fa-medal text-warning fa-2x mb-2"></i>
                  <div class="h4 mb-0">{{ gamificationStats.badgeCount }}</div>
                  <small class="text-muted">Huy hi·ªáu</small>
                </div>
              </div>
              <div class="col-md-4">
                <div class="achievement-item">
                  <i class="fa-solid fa-fire text-danger fa-2x mb-2"></i>
                  <div class="h4 mb-0">{{ gamificationStats.streakDays }}</div>
                  <small class="text-muted">Ng√†y streak</small>
                </div>
              </div>
              <div class="col-md-4">
                <div class="achievement-item">
                  <i class="fa-solid fa-ranking-star text-info fa-2x mb-2"></i>
                  <div class="h4 mb-0">#{{ gamificationStats.rank }}</div>
                  <small class="text-muted">X·∫øp h·∫°ng</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 7. BADGES TAB -->
      <div *ngIf="currentTab === 'BADGES'" class="animate-fade-in">
        <h3 class="mb-4 fw-bold">üèÜ B·ªô S∆∞u T·∫≠p Huy Hi·ªáu</h3>

        <div class="row g-3 mb-4">
          <div class="col-md-6">
            <div class="stat-box bg-gradient-warning text-white p-3 rounded">
              <div class="h3 mb-0">
                {{ myBadges.length }} / {{ allBadges.length }}
              </div>
              <div class="small">Huy hi·ªáu ƒë√£ ƒë·∫°t ƒë∆∞·ª£c</div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="stat-box bg-gradient-info text-white p-3 rounded">
              <div class="h3 mb-0">
                {{
                  ((myBadges.length / (allBadges.length || 1)) * 100).toFixed(
                    0
                  )
                }}%
              </div>
              <div class="small">T·ªâ l·ªá ho√†n th√†nh</div>
            </div>
          </div>
        </div>

        <!-- Badge Grid -->
        <div class="badge-grid row g-3">
          <div class="col-md-4 col-sm-6" *ngFor="let badge of allBadges">
            <div
              class="badge-card"
              [class.badge-earned]="hasBadge(badge.code)"
              [class.badge-locked]="!hasBadge(badge.code)"
            >
              <div class="badge-icon-wrapper">
                <i class="fa-solid fa-trophy fa-3x"></i>
                <div class="badge-checkmark" *ngIf="hasBadge(badge.code)">
                  <i class="fa-solid fa-check"></i>
                </div>
                <div class="badge-lock" *ngIf="!hasBadge(badge.code)">
                  <i class="fa-solid fa-lock"></i>
                </div>
              </div>
              <h5 class="badge-name mt-3 mb-1">{{ badge.nameVi }}</h5>
              <p class="badge-description small text-muted mb-2">
                {{ badge.descriptionVi }}
              </p>
              <div class="badge-points">
                <i class="fa-solid fa-star text-warning"></i>
                +{{ badge.pointsReward }} ƒëi·ªÉm
              </div>
              <div
                class="badge-earned-date small text-muted mt-2"
                *ngIf="hasBadge(badge.code)"
              >
                <i class="fa-regular fa-calendar"></i>
                {{ getBadgeInfo(badge.code)?.earnedAt | date: "dd/MM/yyyy" }}
              </div>
            </div>
          </div>
        </div>

        <div *ngIf="allBadges.length === 0" class="text-center py-5 text-muted">
          <i class="fa-solid fa-trophy fa-3x mb-3"></i>
          <p>Ch∆∞a c√≥ huy hi·ªáu n√†o trong h·ªá th·ªëng</p>
        </div>
      </div>

      <!-- 8. SETTINGS TAB -->
      <div *ngIf="currentTab === 'SETTINGS'" class="animate-fade-in">
        <h3 class="mb-4 fw-bold">‚öôÔ∏è C√†i ƒê·∫∑t T√†i Kho·∫£n</h3>

        <!-- Change Password -->
        <div class="card bg-dark border-secondary text-light">
          <div class="card-header border-secondary fw-bold">
            <i class="fa-solid fa-lock me-2"></i> ƒê·ªïi M·∫≠t Kh·∫©u
          </div>
          <div class="card-body">
            <div class="alert alert-info bg-opacity-10 border-info mb-4">
              <i class="fa-solid fa-info-circle me-2"></i>
              M·∫≠t kh·∫©u m·∫°nh n√™n c√≥ √≠t nh·∫•t 8 k√Ω t·ª±, bao g·ªìm ch·ªØ hoa, ch·ªØ th∆∞·ªùng,
              s·ªë v√† k√Ω t·ª± ƒë·∫∑c bi·ªát.
            </div>
            <form (ngSubmit)="changePassword()" autocomplete="off">
              <div class="row g-3">
                <div class="col-md-4">
                  <label class="form-label">M·∫≠t kh·∫©u c≈© *</label>
                  <input
                    type="password"
                    class="form-control bg-dark text-light border-secondary"
                    [(ngModel)]="oldPassword"
                    name="oldPassword"
                    required
                    placeholder="Nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i"
                  />
                </div>
                <div class="col-md-4">
                  <label class="form-label">M·∫≠t kh·∫©u m·ªõi *</label>
                  <input
                    type="password"
                    class="form-control bg-dark text-light border-secondary"
                    [(ngModel)]="newPassword"
                    name="newPassword"
                    minlength="6"
                    required
                    placeholder="T·ªëi thi·ªÉu 6 k√Ω t·ª±"
                  />
                </div>
                <div class="col-md-4">
                  <label class="form-label">X√°c nh·∫≠n m·∫≠t kh·∫©u *</label>
                  <input
                    type="password"
                    class="form-control bg-dark text-light border-secondary"
                    [(ngModel)]="confirmPassword"
                    name="confirmPassword"
                    [class.is-invalid]="passwordsMismatch"
                    required
                    placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi"
                  />
                  <div
                    *ngIf="passwordsMismatch"
                    class="invalid-feedback d-block"
                  >
                    <i class="fa-solid fa-circle-exclamation me-1"></i>
                    M·∫≠t kh·∫©u x√°c nh·∫≠n ch∆∞a kh·ªõp.
                  </div>
                </div>
              </div>
              <button
                class="btn btn-primary mt-3"
                type="submit"
                [disabled]="changingPwd || passwordsMismatch"
              >
                <i class="fa-solid fa-key me-2"></i>
                {{ changingPwd ? "ƒêang ƒë·ªïi..." : "ƒê·ªïi m·∫≠t kh·∫©u" }}
              </button>
            </form>
          </div>
        </div>

        <!-- Transaction History -->
        <div
          class="card bg-dark border-secondary text-light mt-4"
          *ngIf="transactionHistory.length > 0"
        >
          <div class="card-header border-secondary fw-bold">
            <i class="fa-solid fa-receipt me-2"></i> L·ªãch S·ª≠ Giao D·ªãch
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-dark table-hover mb-0">
                <thead>
                  <tr>
                    <th>Ng√†y</th>
                    <th>M√¥ t·∫£</th>
                    <th class="text-end">S·ªë ti·ªÅn</th>
                    <th class="text-center">Tr·∫°ng th√°i</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let trans of transactionHistory">
                    <td>{{ trans.date | date: "dd/MM/yyyy" }}</td>
                    <td>{{ trans.description }}</td>
                    <td class="text-end text-danger">
                      {{ trans.amount | currency: "VND" : "symbol" : "1.0-0" }}
                    </td>
                    <td class="text-center">
                      <span class="badge bg-success">{{ trans.status }}</span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
