<div class="container mt-5">
  <div class="card p-4 mx-auto create-book-card">
    <div class="header-section">
      <h2>üìö T·∫°o S√°ch M·ªõi</h2>
      <button
        type="button"
        class="btn btn-outline-info btn-sm"
        (click)="goToBulkImport()"
      >
        <i class="fas fa-file-excel"></i> Import h√†ng lo·∫°t
      </button>
    </div>
    <hr />

    <form (ngSubmit)="saveBook(bookForm)" #bookForm="ngForm">
      <!-- ISBN v·ªõi Auto-fill Button -->
      <div class="mb-3">
        <label for="isbn" class="form-label">
          ISBN
          <small class="text-muted">(M√£ qu·ªëc t·∫ø)</small>
        </label>
        <div class="isbn-input-group">
          <input
            type="text"
            class="form-control"
            id="isbn"
            name="isbn"
            [(ngModel)]="book.isbn"
            placeholder="9780132350884"
            [disabled]="fetchingIsbn"
          />
          <button
            type="button"
            class="btn btn-magic"
            (click)="fetchBookDataByISBN()"
            [disabled]="fetchingIsbn || !book.isbn"
            title="T·ª± ƒë·ªông l·∫•y th√¥ng tin s√°ch t·ª´ Google Books"
          >
            <i
              class="fas"
              [ngClass]="fetchingIsbn ? 'fa-spinner fa-spin' : 'fa-magic'"
            ></i>
            {{ fetchingIsbn ? "ƒêang t·∫£i..." : "L·∫•y d·ªØ li·ªáu" }}
          </button>
        </div>
        <small class="form-text text-muted">
          üí° <strong>M·∫πo:</strong> Nh·∫≠p ISBN v√† b·∫•m "L·∫•y d·ªØ li·ªáu" ƒë·ªÉ t·ª± ƒë·ªông
          ƒëi·ªÅn th√¥ng tin s√°ch!
        </small>
      </div>

      <div class="mb-3">
        <label for="name" class="form-label"
          >T√™n S√°ch <span class="required">*</span></label
        >
        <input
          type="text"
          class="form-control"
          id="name"
          name="name"
          [(ngModel)]="book.name"
          required
          #name="ngModel"
        />
        <div
          *ngIf="name.invalid && (name.dirty || name.touched)"
          class="text-danger mt-1"
        >
          T√™n s√°ch l√† b·∫Øt bu·ªôc.
        </div>
      </div>

      <!-- Author v·ªõi Autocomplete Search -->
      <div class="mb-3">
        <label for="authorIds" class="form-label"
          >T√°c Gi·∫£ <span class="required">*</span></label
        >

        <!-- Search/Filter Input -->
        <div class="author-search-box mb-2">
          <i class="fas fa-search search-icon"></i>
          <input
            type="text"
            class="form-control"
            placeholder="üîç T√¨m t√°c gi·∫£..."
            [(ngModel)]="authorSearchQuery"
            (ngModelChange)="filterAuthors($event)"
            name="authorSearch"
          />
        </div>

        <select
          multiple
          class="form-select author-select"
          id="authorIds"
          name="authorIds"
          [(ngModel)]="book.authorIds"
          required
          #authorIds="ngModel"
          [size]="5"
        >
          <option *ngFor="let author of filteredAuthors" [ngValue]="author.id">
            {{ author.name }}
          </option>
          <option *ngIf="filteredAuthors.length === 0" disabled>
            Kh√¥ng t√¨m th·∫•y t√°c gi·∫£ ph√π h·ª£p
          </option>
        </select>
        <div
          *ngIf="authorIds.invalid && (authorIds.dirty || authorIds.touched)"
          class="text-danger mt-1"
        >
          Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 t√°c gi·∫£.
        </div>
        <div class="mt-2 d-flex gap-2">
          <button
            type="button"
            class="btn btn-outline-primary btn-sm"
            (click)="openAddAuthor()"
          >
            <i class="fas fa-plus"></i> Th√™m t√°c gi·∫£
          </button>
          <small class="text-muted align-self-center">
            <i class="fas fa-info-circle"></i> Gi·ªØ Ctrl ƒë·ªÉ ch·ªçn nhi·ªÅu t√°c gi·∫£
          </small>
        </div>
      </div>
      <!-- Add Author Modal -->
      <div class="modal-backdrop" *ngIf="showAddAuthorModal"></div>
      <div
        class="modal"
        tabindex="-1"
        *ngIf="showAddAuthorModal"
        style="display: block"
      >
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Th√™m T√°c Gi·∫£</h5>
              <button
                type="button"
                class="btn-close"
                (click)="closeAddAuthor()"
              ></button>
            </div>
            <div class="modal-body">
              <label for="newAuthorName" class="form-label">T√™n t√°c gi·∫£</label>
              <input
                id="newAuthorName"
                type="text"
                class="form-control"
                [(ngModel)]="newAuthorName"
                name="newAuthorName"
              />
              <div *ngIf="errorMessage" class="alert alert-danger mt-2">
                {{ errorMessage }}
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                (click)="closeAddAuthor()"
                [disabled]="savingAuthor"
              >
                ƒê√≥ng
              </button>
              <button
                type="button"
                class="btn btn-primary"
                (click)="saveNewAuthor()"
                [disabled]="savingAuthor"
              >
                <span
                  *ngIf="savingAuthor"
                  class="spinner-border spinner-border-sm"
                ></span>
                {{ savingAuthor ? "ƒêang l∆∞u..." : "L∆∞u" }}
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="mb-3">
        <label for="categoryIds" class="form-label">Th·ªÉ Lo·∫°i</label>
        <select
          multiple
          class="form-select"
          id="categoryIds"
          name="categoryIds"
          [(ngModel)]="book.categoryIds"
          required
          #categoryIds="ngModel"
          [size]="5"
        >
          <option
            *ngFor="let category of allCategories"
            [ngValue]="category.id"
          >
            {{ category.name }}
          </option>
        </select>
        <div
          *ngIf="
            categoryIds.invalid && (categoryIds.dirty || categoryIds.touched)
          "
          class="text-danger mt-1"
        >
          Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 th·ªÉ lo·∫°i.
        </div>
        <div class="mt-2 d-flex gap-2">
          <button
            type="button"
            class="btn btn-outline-primary btn-sm"
            (click)="openAddCategory()"
          >
            + Th√™m th·ªÉ lo·∫°i
          </button>
        </div>
      </div>
      <!-- Add Category Modal -->
      <div class="modal-backdrop" *ngIf="showAddCategoryModal"></div>
      <div
        class="modal"
        tabindex="-1"
        *ngIf="showAddCategoryModal"
        style="display: block"
      >
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Th√™m Th·ªÉ Lo·∫°i</h5>
              <button
                type="button"
                class="btn-close"
                (click)="closeAddCategory()"
              ></button>
            </div>
            <div class="modal-body">
              <label for="newCategoryName" class="form-label"
                >T√™n th·ªÉ lo·∫°i</label
              >
              <input
                id="newCategoryName"
                type="text"
                class="form-control"
                [(ngModel)]="newCategoryName"
                name="newCategoryName"
              />
              <div *ngIf="errorMessage" class="alert alert-danger mt-2">
                {{ errorMessage }}
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                (click)="closeAddCategory()"
                [disabled]="savingCategory"
              >
                ƒê√≥ng
              </button>
              <button
                type="button"
                class="btn btn-primary"
                (click)="saveNewCategory()"
                [disabled]="savingCategory"
              >
                <span
                  *ngIf="savingCategory"
                  class="spinner-border spinner-border-sm"
                ></span>
                {{ savingCategory ? "ƒêang l∆∞u..." : "L∆∞u" }}
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6 mb-3">
          <label for="numberOfCopiesAvailable" class="form-label"
            >S·ªë L∆∞·ª£ng B·∫£n Sao</label
          >
          <input
            type="number"
            class="form-control"
            id="numberOfCopiesAvailable"
            name="numberOfCopiesAvailable"
            [(ngModel)]="book.numberOfCopiesAvailable"
            required
            min="0"
            #noOfCopies="ngModel"
          />
          <div
            *ngIf="
              noOfCopies.invalid && (noOfCopies.dirty || noOfCopies.touched)
            "
            class="text-danger mt-1"
          >
            Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng b·∫£n sao h·ª£p l·ªá.
          </div>
        </div>
        <div class="col-md-6 mb-3">
          <label for="publishedYear" class="form-label">NƒÉm Xu·∫•t B·∫£n</label>
          <input
            type="number"
            class="form-control"
            id="publishedYear"
            name="publishedYear"
            [(ngModel)]="book.publishedYear"
          />
        </div>
      </div>
      <div class="mb-3">
        <label for="coverUrl" class="form-label">·∫¢nh B√¨a (Cover URL)</label>
        <div class="cover-input-section">
          <input
            type="url"
            class="form-control"
            id="coverUrl"
            name="coverUrl"
            [(ngModel)]="book.coverUrl"
            placeholder="https://example.com/cover.jpg"
            (ngModelChange)="coverPreviewError = false"
          />

          <!-- Live Preview -->
          <div class="cover-preview-container mt-3" *ngIf="book.coverUrl">
            <div class="preview-label">
              <i class="fas fa-eye"></i> Xem tr∆∞·ªõc ·∫£nh b√¨a:
            </div>
            <div class="cover-preview-box">
              <img
                *ngIf="!coverPreviewError"
                [src]="book.coverUrl"
                alt="Book cover preview"
                class="cover-preview-image"
                (error)="onCoverError()"
              />
              <div *ngIf="coverPreviewError" class="cover-error">
                <i class="fas fa-exclamation-triangle"></i>
                <p>Kh√¥ng th·ªÉ t·∫£i ·∫£nh. Vui l√≤ng ki·ªÉm tra URL.</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="mb-3">
        <label for="isbn" class="form-label">ISBN</label>
        <input
          type="text"
          class="form-control"
          id="isbn"
          name="isbn"
          [(ngModel)]="book.isbn"
        />
      </div>

      <div *ngIf="errorMessage" class="alert alert-danger">
        {{ errorMessage }}
      </div>

      <div class="action-buttons">
        <button
          class="btn btn-success"
          type="submit"
          [disabled]="submitting || bookForm.invalid"
        >
          <i
            class="fas"
            [ngClass]="submitting ? 'fa-spinner fa-spin' : 'fa-check'"
          ></i>
          {{ submitting ? "ƒêang l∆∞u..." : "T·∫°o s√°ch" }}
        </button>
        <button
          class="btn btn-outline-secondary"
          type="button"
          routerLink="/books"
        >
          <i class="fas fa-times"></i> H·ªßy
        </button>
      </div>
    </form>
  </div>
</div>
