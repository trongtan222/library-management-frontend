<div class="container mt-5">
  <div *ngIf="isLoading" class="text-center">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Đang tải...</span>
    </div>
  </div>

  <div *ngIf="errorMessage" class="alert alert-danger">
    {{ errorMessage }}
  </div>

  <div
    *ngIf="book && !isLoading"
    class="card book-details-card border-secondary shadow-sm"
    style="background-color: #161b22; color: #c9d1d9"
  >
    <div class="row g-0">
      <div class="col-md-4 text-center p-4 border-end border-secondary">
        <img
          [src]="book.coverUrl || 'assets/images/placeholder.png'"
          class="book-cover-img rounded shadow mb-4"
          style="
            max-width: 100%;
            height: auto;
            max-height: 400px;
            object-fit: cover;
          "
          alt="Bìa sách {{ book.name }}"
        />

        <div
          class="card mt-3 border-secondary"
          style="background-color: #0d1117"
        >
          <div class="card-body text-center">
            <h6 class="card-title text-warning mb-3 fw-bold">
              <i class="fa-solid fa-qrcode me-2"></i>Mã Sách (ID)
            </h6>
            <div class="bg-white p-2 d-inline-block rounded">
              <qrcode
                [qrdata]="book.id.toString()"
                [width]="150"
                [errorCorrectionLevel]="'M'"
              ></qrcode>
            </div>
            <p class="small text-muted mt-2 mb-0">Quét mã để mượn nhanh</p>
          </div>
        </div>
      </div>

      <div class="col-md-8">
        <div class="card-body p-4">
          <h2 class="card-title text-primary fw-bold mb-3">{{ book.name }}</h2>

          <h5 class="card-subtitle mb-3 text-muted">
            <i class="fa-solid fa-pen-nib me-2"></i>
            <span *ngFor="let a of book.authors; let last = last"
              >{{ a.name }}{{ !last ? ", " : "" }}</span
            >
          </h5>

          <p class="card-text mb-4">
            <span
              *ngFor="let c of book.categories"
              class="badge bg-secondary me-2"
              >{{ c.name }}</span
            >
            <span class="text-muted ms-2"
              ><i class="fa-solid fa-calendar-days me-1"></i> Xuất bản năm
              {{ book.publishedYear }}</span
            >
          </p>

          <!-- Social Sharing Buttons -->
          <div class="d-flex gap-2 mb-3 flex-wrap">
            <button
              class="btn btn-sm btn-outline-primary"
              (click)="shareOnFacebook()"
            >
              <i class="fab fa-facebook me-1"></i> Facebook
            </button>
            <button
              class="btn btn-sm btn-outline-info"
              (click)="shareOnTwitter()"
            >
              <i class="fab fa-twitter me-1"></i> Twitter
            </button>
            <button
              class="btn btn-sm btn-outline-success"
              (click)="downloadShareImage()"
            >
              <i class="fa-solid fa-download me-1"></i> Tải ảnh
            </button>
          </div>

          <hr class="border-secondary" />

          <div class="row mb-4">
            <div class="col-md-6">
              <p><strong>ISBN:</strong> {{ book.isbn }}</p>
              <p>
                <strong>Tình trạng:</strong>
                <span
                  [ngClass]="
                    book.numberOfCopiesAvailable > 0
                      ? 'text-success fw-bold'
                      : 'text-danger fw-bold'
                  "
                >
                  {{
                    book.numberOfCopiesAvailable > 0
                      ? "Còn " + book.numberOfCopiesAvailable + " cuốn"
                      : "Hết hàng"
                  }}
                </span>
              </p>
            </div>
          </div>

          <div
            class="description-box p-3 rounded mb-4"
            style="background-color: #21262d"
          >
            <h6 class="text-info mb-2">Mô tả nội dung:</h6>
            <p class="mb-0 text-muted">
              Đây là cuốn sách nổi tiếng thuộc thể loại
              {{ book.categories[0]?.name }}. Sách hiện đang có sẵn tại thư viện
              trường THCS Phương Tú.
            </p>
          </div>

          <div class="d-flex gap-3 flex-wrap">
            <button
              *ngIf="isUser && book.numberOfCopiesAvailable > 0"
              class="btn btn-primary px-4"
              (click)="navigateToBorrow()"
            >
              <i class="fa-solid fa-cart-plus me-2"></i> Mượn Sách Này
            </button>
            <button
              *ngIf="isUser && book.numberOfCopiesAvailable === 0"
              class="btn btn-warning px-4"
              (click)="navigateToReserve()"
            >
              <i class="fa-solid fa-clock me-2"></i> Đặt Trước
            </button>

            <!-- E-book Read Button -->
            <button
              *ngIf="hasEbook && availableEbooks.length > 0"
              class="btn btn-success px-4"
              (click)="openEbook(availableEbooks[0])"
              [disabled]="isCheckingEbook"
            >
              <span
                *ngIf="isCheckingEbook"
                class="spinner-border spinner-border-sm me-2"
              ></span>
              <i
                *ngIf="!isCheckingEbook"
                class="fa-solid fa-book-open me-2"
              ></i>
              {{ isCheckingEbook ? "Đang kiểm tra..." : "Đọc Online" }}
            </button>

            <button
              *ngIf="isUser"
              class="btn btn-outline-danger px-4"
              (click)="toggleWishlist()"
            >
              <i
                class="fa-heart me-2"
                [ngClass]="
                  book.isWishlisted ? 'fa-solid text-danger' : 'fa-regular'
                "
              ></i>
              {{ book.isWishlisted ? "Đã yêu thích" : "Thêm vào yêu thích" }}
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="book && !isLoading" class="reviews-section mt-5">
    <h4 class="mb-4 text-light border-bottom border-secondary pb-2">
      <i class="fa-solid fa-comments me-2"></i>Đánh giá từ độc giả
    </h4>

    <div
      *ngIf="reviewsSummary"
      class="average-rating mb-4 p-3 rounded"
      style="background-color: #21262d"
    >
      <ng-container *ngIf="reviewsSummary.averageRating > 0; else noReviews">
        <span class="h5 text-warning me-2"
          >{{ reviewsSummary.averageRating | number: "1.1-1" }}
          <i class="fa-solid fa-star"></i
        ></span>
        <span class="text-muted"
          >trên 5 ({{ reviewsSummary.reviews.length }} lượt đánh giá)</span
        >
      </ng-container>
      <ng-template #noReviews>
        <p class="text-muted mb-0">Chưa có đánh giá nào cho sách này.</p>
      </ng-template>
    </div>

    <div
      *ngIf="isUser && !isCheckingPermission && userCanReview"
      class="card mb-4 bg-dark border-secondary"
    >
      <div class="card-body">
        <h5 class="card-title text-light mb-3">Viết đánh giá của bạn</h5>
        <form (ngSubmit)="submitReview()">
          <div class="mb-3">
            <label class="form-label text-muted">Điểm số:</label>
            <div class="star-rating fs-3 text-warning" style="cursor: pointer">
              <span
                *ngFor="let star of [1, 2, 3, 4, 5]"
                (click)="newReview.rating = star"
              >
                <i
                  class="fa-star"
                  [ngClass]="
                    star <= newReview.rating ? 'fa-solid' : 'fa-regular'
                  "
                ></i>
              </span>
            </div>
          </div>
          <div class="mb-3">
            <textarea
              class="form-control bg-dark text-light border-secondary"
              [(ngModel)]="newReview.comment"
              name="comment"
              rows="3"
              placeholder="Chia sẻ cảm nhận của bạn về cuốn sách..."
            ></textarea>
          </div>
          <button type="submit" class="btn btn-primary">Gửi Đánh Giá</button>
        </form>
      </div>
    </div>

    <div
      *ngIf="isUser && !isCheckingPermission && !userCanReview"
      class="alert alert-info bg-dark border-info text-info"
    >
      <i class="fa-solid fa-check-circle me-2"></i> Bạn đã đánh giá sách này
      rồi. Cảm ơn bạn!
    </div>

    <div
      *ngIf="reviewsSummary && reviewsSummary.reviews.length > 0"
      class="review-list"
    >
      <div
        *ngFor="let review of reviewsSummary.reviews"
        class="card mb-3 bg-dark border-secondary review-item-card"
      >
        <div class="card-body">
          <div class="d-flex justify-content-between mb-2">
            <strong class="text-info">{{ review.userName }}</strong>
            <small class="text-muted">{{
              review.createdAt | date: "dd/MM/yyyy"
            }}</small>
          </div>
          <div class="mb-2 text-warning">
            <i
              class="fa-solid fa-star"
              *ngFor="let i of [].constructor(review.rating)"
            ></i>
          </div>
          <p class="card-text text-light mb-2">{{ review.comment }}</p>

          <!-- Image Gallery -->
          <div
            *ngIf="review.images && review.images.length > 0"
            class="review-images mb-3"
          >
            <div class="row g-2">
              <div *ngFor="let img of review.images" class="col-auto">
                <img
                  [src]="img"
                  alt="Review image"
                  class="review-img-thumbnail"
                />
              </div>
            </div>
          </div>

          <!-- Like & Comment Actions -->
          <div class="review-actions d-flex gap-3">
            <button
              class="btn btn-sm btn-outline-light"
              [class.liked]="review.currentUserLiked"
              (click)="toggleLike(review)"
              *ngIf="isUser"
            >
              <i class="fa-solid fa-thumbs-up me-1"></i>
              {{ review.likesCount || 0 }} Hữu ích
            </button>
            <button
              class="btn btn-sm btn-outline-light"
              (click)="toggleComments(review)"
            >
              <i class="fa-solid fa-comment me-1"></i>
              {{ review.commentsCount || 0 }} Bình luận
            </button>
          </div>

          <!-- Comments Section (Expandable) -->
          <div
            *ngIf="expandedReviewId === review.id"
            class="comments-section mt-3"
          >
            <div class="comments-list mb-3">
              <div
                *ngFor="let comment of reviewComments[review.id]"
                class="comment-item p-2 mb-2 bg-secondary rounded"
              >
                <div class="d-flex justify-content-between">
                  <strong class="text-light">{{ comment.userName }}</strong>
                  <small class="text-muted">{{
                    comment.createdAt | date: "dd/MM/yyyy HH:mm"
                  }}</small>
                </div>
                <p class="text-light mb-0">{{ comment.content }}</p>
              </div>
            </div>

            <div *ngIf="isUser" class="add-comment-form">
              <div class="input-group">
                <input
                  type="text"
                  class="form-control bg-dark text-light border-secondary"
                  [(ngModel)]="newCommentText[review.id]"
                  placeholder="Viết bình luận..."
                  (keyup.enter)="addComment(review.id)"
                />
                <button
                  class="btn btn-primary"
                  (click)="addComment(review.id)"
                  [disabled]="!newCommentText[review.id]?.trim()"
                >
                  <i class="fa-solid fa-paper-plane"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Related Books Section -->
  <div
    *ngIf="book && !isLoading && relatedBooks.length > 0"
    class="related-books-section mt-5"
  >
    <h4 class="mb-4 text-light border-bottom border-secondary pb-2">
      <i class="fa-solid fa-book-open me-2"></i>Có thể bạn cũng thích
    </h4>

    <div *ngIf="isLoadingRelated" class="text-center py-3">
      <div class="spinner-border text-primary spinner-border-sm" role="status">
        <span class="visually-hidden">Đang tải...</span>
      </div>
    </div>

    <div class="row g-3" *ngIf="!isLoadingRelated">
      <div
        *ngFor="let relatedBook of relatedBooks"
        class="col-md-2 col-sm-4 col-6"
      >
        <div class="card related-book-card border-secondary h-100">
          <a [routerLink]="['/book-details', relatedBook.id]">
            <img
              [src]="relatedBook.coverUrl || 'assets/images/placeholder.png'"
              class="card-img-top related-book-cover"
              [alt]="relatedBook.name"
            />
          </a>
          <div class="card-body p-2 bg-dark text-light">
            <h6 class="card-title text-truncate mb-1">
              <a
                [routerLink]="['/book-details', relatedBook.id]"
                class="text-decoration-none text-light"
                >{{ relatedBook.name }}</a
              >
            </h6>
            <p class="card-text text-muted small text-truncate mb-1">
              <span *ngFor="let a of relatedBook.authors; let last = last"
                >{{ a.name }}{{ !last ? ", " : "" }}</span
              >
            </p>
            <span
              *ngIf="relatedBook.numberOfCopiesAvailable > 0"
              class="badge bg-success small"
              >Còn {{ relatedBook.numberOfCopiesAvailable }} cuốn</span
            >
            <span
              *ngIf="relatedBook.numberOfCopiesAvailable === 0"
              class="badge bg-danger small"
              >Hết sách</span
            >
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Borrow Modal -->
<div
  class="modal fade"
  [class.show]="showBorrowModal"
  [style.display]="showBorrowModal ? 'block' : 'none'"
  tabindex="-1"
  role="dialog"
>
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header border-secondary">
        <h5 class="modal-title">
          <i class="fa-solid fa-book me-2"></i>Xác nhận mượn sách
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          (click)="closeBorrowModal()"
        ></button>
      </div>
      <div class="modal-body">
        <div *ngIf="book" class="mb-3">
          <p class="text-muted mb-2">
            <strong>Tên sách:</strong> {{ book.name }}
          </p>
          <p class="text-muted mb-3">
            <strong>Số lượng còn:</strong>
            <span class="text-success">{{ book.numberOfCopiesAvailable }}</span>
          </p>
        </div>

        <form>
          <div class="alert alert-info border-info">
            <i class="fa-solid fa-info-circle me-2"></i>
            <strong>Thông tin người mượn:</strong> Thông tin này được lấy từ tài
            khoản của bạn và không thể chỉnh sửa.
          </div>

          <div class="mb-3">
            <label class="form-label">Họ và tên</label>
            <input
              type="text"
              class="form-control bg-secondary text-light border-secondary"
              [value]="userFullProfile?.name || '---'"
              readonly
            />
          </div>
          <div class="mb-3">
            <label class="form-label">Lớp</label>
            <input
              type="text"
              class="form-control bg-secondary text-light border-secondary"
              [value]="
                userFullProfile?.className ||
                userFullProfile?.studentClass ||
                'Chưa cập nhật'
              "
              readonly
            />
          </div>
          <div class="mb-3">
            <label class="form-label">Số ngày mượn</label>
            <select
              class="form-select bg-dark text-light border-secondary"
              [(ngModel)]="borrowData.loanDays"
              name="loanDays"
            >
              <option [value]="7">7 ngày</option>
              <option [value]="14">14 ngày</option>
              <option [value]="21">21 ngày</option>
              <option [value]="30">30 ngày</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer border-secondary">
        <button
          type="button"
          class="btn btn-secondary"
          (click)="closeBorrowModal()"
          [disabled]="borrowLoading"
        >
          Hủy
        </button>
        <button
          type="button"
          class="btn btn-primary"
          (click)="confirmBorrow()"
          [disabled]="borrowLoading"
        >
          <span
            *ngIf="borrowLoading"
            class="spinner-border spinner-border-sm me-2"
          ></span>
          {{ borrowLoading ? "Đang xử lý..." : "Xác nhận mượn" }}
        </button>
      </div>
    </div>
  </div>
</div>
<div
  class="modal-backdrop fade"
  [class.show]="showBorrowModal"
  *ngIf="showBorrowModal"
  (click)="closeBorrowModal()"
></div>

<!-- Reservation Modal -->
<div
  class="modal fade"
  [class.show]="showReserveModal"
  [style.display]="showReserveModal ? 'block' : 'none'"
  tabindex="-1"
  role="dialog"
>
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header border-secondary bg-warning text-dark">
        <h5 class="modal-title">
          <i class="fa-solid fa-clock me-2"></i>Đặt trước sách
        </h5>
        <button
          type="button"
          class="btn-close"
          (click)="closeReserveModal()"
        ></button>
      </div>
      <div class="modal-body">
        <div *ngIf="book" class="mb-3">
          <div class="alert alert-warning border-warning">
            <i class="fa-solid fa-exclamation-triangle me-2"></i>
            <strong>Sách hiện đang hết!</strong> Bạn có thể đặt trước để được ưu
            tiên mượn khi có người trả sách.
          </div>
          <p class="text-muted mb-2">
            <strong>Tên sách:</strong> {{ book.name }}
          </p>
        </div>

        <div class="alert alert-info border-info mb-3">
          <i class="fa-solid fa-info-circle me-2"></i>
          <strong>Thông tin người đặt trước:</strong>
        </div>

        <div class="mb-3">
          <label class="form-label">Họ và tên</label>
          <input
            type="text"
            class="form-control bg-secondary text-light border-secondary"
            [value]="userFullProfile?.name || '---'"
            readonly
          />
        </div>
        <div class="mb-3">
          <label class="form-label">Lớp</label>
          <input
            type="text"
            class="form-control bg-secondary text-light border-secondary"
            [value]="
              userFullProfile?.className ||
              userFullProfile?.studentClass ||
              'Chưa cập nhật'
            "
            readonly
          />
        </div>

        <div class="alert alert-success border-success">
          <i class="fa-solid fa-bell me-2"></i>
          <small
            >Bạn sẽ nhận được <strong>Email/Thông báo</strong> khi sách có sẵn
            (thời gian giữ: 24 giờ).</small
          >
        </div>
      </div>
      <div class="modal-footer border-secondary">
        <button
          type="button"
          class="btn btn-secondary"
          (click)="closeReserveModal()"
          [disabled]="reserveLoading"
        >
          Hủy
        </button>
        <button
          type="button"
          class="btn btn-warning"
          (click)="confirmReserve()"
          [disabled]="reserveLoading"
        >
          <span
            *ngIf="reserveLoading"
            class="spinner-border spinner-border-sm me-2"
          ></span>
          {{ reserveLoading ? "Đang xử lý..." : "Xác nhận đặt trước" }}
        </button>
      </div>
    </div>
  </div>
</div>
<div
  class="modal-backdrop fade"
  [class.show]="showReserveModal"
  *ngIf="showReserveModal"
  (click)="closeReserveModal()"
></div>
