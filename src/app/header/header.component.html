<nav class="navbar navbar-expand-lg navbar-dark site-header">
  <div class="container-fluid">
    <!-- Logo -->
    <a
      class="navbar-brand d-flex align-items-center"
      routerLink="/"
      (click)="closeMobileMenu()"
    >
      <img
        src="assets/school-logo.png"
        alt="Logo THCS Ph∆∞∆°ng T√∫"
        class="me-2"
        style="height: 32px; width: auto; object-fit: contain"
      />
      <span class="d-none d-md-inline">
        <i class="fa-solid fa-book-atlas"></i>
        THCS Ph∆∞∆°ng T√∫
      </span>
    </a>

    <!-- Navigation Menu (Desktop) -->
    <div
      class="navbar-nav-menu d-none d-lg-flex align-items-center me-auto ms-3"
    >
      <!-- Admin Menu -->
      <div class="nav-item dropdown" *ngIf="isAdmin()">
        <a
          class="nav-link dropdown-toggle"
          href="#"
          id="adminDropdown"
          role="button"
          data-bs-toggle="dropdown"
          aria-expanded="false"
        >
          <i class="fa-solid fa-cogs"></i> Qu·∫£n L√Ω
        </a>
        <ul
          class="dropdown-menu dropdown-menu-dark"
          aria-labelledby="adminDropdown"
        >
          <li>
            <a class="dropdown-item" routerLink="/admin/dashboard">
              <i class="fa-solid fa-chart-pie"></i> B·∫£ng ƒêi·ªÅu Khi·ªÉn
            </a>
          </li>
          <li><hr class="dropdown-divider" /></li>
          <li>
            <a class="dropdown-item" routerLink="/users">
              <i class="fa-solid fa-users-cog"></i> Ng∆∞·ªùi D√πng
            </a>
          </li>
          <li>
            <a class="dropdown-item" routerLink="/books">
              <i class="fa-solid fa-book-medical"></i> S√°ch
            </a>
          </li>
          <li>
            <a class="dropdown-item" routerLink="/admin/loans">
              <i class="fa-solid fa-exchange-alt"></i> M∆∞·ª£n/Tr·∫£
            </a>
          </li>
          <li>
            <a class="dropdown-item" routerLink="/admin/fines">
              <i class="fa-solid fa-file-invoice-dollar"></i> Ph√≠ Ph·∫°t
            </a>
          </li>
          <li>
            <a class="dropdown-item" routerLink="/admin/reviews">
              <i class="fa-solid fa-star-half-alt"></i> ƒê√°nh Gi√°
            </a>
          </li>
          <li>
            <a class="dropdown-item" routerLink="/admin/scanner">
              <i class="fa-solid fa-qrcode"></i> Qu√©t M√£
            </a>
          </li>
          <li>
            <a class="dropdown-item" routerLink="/admin/settings">
              <i class="fa-solid fa-sliders"></i> C·∫•u H√¨nh
            </a>
          </li>
          <li>
            <a class="dropdown-item" routerLink="/admin/categories">
              <i class="fa-solid fa-tags"></i> Qu·∫£n L√Ω Th·ªÉ Lo·∫°i
            </a>
          </li>
          <li>
            <a class="dropdown-item" routerLink="/admin/authors">
              <i class="fa-solid fa-user"></i> Qu·∫£n L√Ω T√°c Gi·∫£
            </a>
          </li>
          <li>
            <a class="dropdown-item" routerLink="/admin/import-export">
              <i class="fa-solid fa-file-import"></i> Nh·∫≠p/Xu·∫•t
            </a>
          </li>
          <li>
            <a class="dropdown-item" routerLink="/admin/news">
              <i class="fa-solid fa-newspaper"></i> Tin T·ª©c
            </a>
          </li>
          <li>
            <a class="dropdown-item" routerLink="/admin/renewals">
              <i class="fa-solid fa-rotate-right"></i> Gia H·∫°n
            </a>
          </li>
          <li><hr class="dropdown-divider" /></li>
          <li>
            <a class="dropdown-item" routerLink="/admin/create-loan">
              <i class="fa-solid fa-file-signature text-warning"></i> T·∫°o Phi·∫øu
              M∆∞·ª£n
            </a>
          </li>
        </ul>
      </div>

      <!-- User Menu -->
      <ng-container *ngIf="isUser()">
        <div class="nav-item">
          <a class="nav-link" routerLink="/borrow-book">
            <i class="fa-solid fa-hand-holding-hand"></i> M∆∞·ª£n S√°ch
          </a>
        </div>
        <div class="nav-item">
          <a class="nav-link" routerLink="/return-book">
            <i class="fa-solid fa-undo"></i> Tr·∫£ S√°ch
          </a>
        </div>
      </ng-container>
    </div>

    <!-- Global Search Bar (Desktop/Tablet) -->
    <div class="global-search-container d-none d-lg-block">
      <div class="search-wrapper">
        <i class="fa-solid fa-search search-icon"></i>
        <input
          type="text"
          class="form-control global-search-input"
          placeholder="T√¨m s√°ch..."
          [(ngModel)]="globalSearchTerm"
          (input)="onGlobalSearch(globalSearchTerm)"
          (keyup.enter)="performFullSearch()"
        />
        <!-- Search Results Dropdown -->
        <div
          class="search-results-dropdown"
          *ngIf="showSearchResults && searchResults.length > 0"
        >
          <div
            class="search-result-item"
            *ngFor="let book of searchResults"
            (click)="selectSearchResult(book)"
          >
            <img
              [src]="book.coverUrl || 'assets/default-book-cover.png'"
              alt=""
              class="result-thumbnail"
            />
            <div class="result-info">
              <div class="result-title">{{ book.name }}</div>
              <div class="result-author">
                {{ book.authors?.[0] || "Kh√¥ng r√µ t√°c gi·∫£" }}
              </div>
            </div>
          </div>
          <div class="search-result-footer" (click)="performFullSearch()">
            <i class="fa-solid fa-search"></i> Xem t·∫•t c·∫£ k·∫øt qu·∫£
          </div>
        </div>
      </div>
    </div>

    <!-- Smart Widgets (Desktop) -->
    <div class="smart-widgets d-none d-lg-flex align-items-center gap-3">
      <!-- Language Switcher -->
      <div class="language-switcher position-relative">
        <button
          class="btn btn-icon"
          (click)="toggleLanguageDropdown()"
          aria-label="Chuy·ªÉn ng√¥n ng·ªØ"
        >
          <span class="flag-emoji">{{
            currentLanguage === "vi" ? "üáªüá≥" : "üá∫üá∏"
          }}</span>
          <i class="fa-solid fa-chevron-down ms-1"></i>
        </button>
        <div class="language-dropdown" *ngIf="showLanguageDropdown">
          <div class="dropdown-item" (click)="switchLanguage('vi')">
            <span class="flag-emoji">üáªüá≥</span> Ti·∫øng Vi·ªát
            <i
              class="fa-solid fa-check text-success ms-auto"
              *ngIf="currentLanguage === 'vi'"
            ></i>
          </div>
          <div class="dropdown-item" (click)="switchLanguage('en')">
            <span class="flag-emoji">üá∫üá∏</span> English
            <i
              class="fa-solid fa-check text-success ms-auto"
              *ngIf="currentLanguage === 'en'"
            ></i>
          </div>
        </div>
      </div>

      <!-- Theme Toggle -->
      <button
        class="theme-toggle"
        (click)="toggleTheme()"
        [class.is-dark]="currentTheme === 'dark'"
        aria-label="Chuy·ªÉn ch·∫ø ƒë·ªô s√°ng/t·ªëi"
      >
        <span class="icon sun"><i class="fa-solid fa-sun"></i></span>
        <span class="icon moon"><i class="fa-solid fa-moon"></i></span>
        <span class="toggle-handle"></span>
      </button>

      <ng-container *ngIf="isLoggedIn()">
        <!-- Wishlist -->
        <div class="wishlist-widget position-relative">
          <button
            class="btn btn-icon"
            (click)="navigateToWishlist()"
            aria-label="Danh s√°ch y√™u th√≠ch"
          >
            <i class="fa-solid fa-heart"></i>
            <span class="badge-count" *ngIf="wishlistCount > 0">{{
              wishlistCount
            }}</span>
          </button>
        </div>

        <!-- Notifications -->
        <div class="notification-widget position-relative">
          <button
            class="btn btn-icon"
            (click)="toggleNotificationDropdown()"
            aria-label="Th√¥ng b√°o"
          >
            <i class="fa-solid fa-bell"></i>
            <span class="badge-count pulse" *ngIf="unreadNotificationCount > 0">
              {{ unreadNotificationCount > 9 ? "9+" : unreadNotificationCount }}
            </span>
          </button>

          <!-- Notification Dropdown -->
          <div class="notification-dropdown" *ngIf="showNotificationDropdown">
            <div class="notification-header">
              <h6>Th√¥ng b√°o</h6>
              <button
                class="btn btn-sm btn-link"
                (click)="markAllNotificationsAsRead()"
              >
                ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc
              </button>
            </div>
            <div class="notification-list">
              <div
                *ngFor="let notification of notifications"
                class="notification-item"
                [class.unread]="!notification.isRead"
                (click)="markNotificationAsRead(notification)"
              >
                <div
                  class="notification-icon"
                  [ngClass]="'type-' + notification.type"
                >
                  <i
                    class="fa-solid"
                    [ngClass]="{
                      'fa-info-circle': notification.type === 'info',
                      'fa-exclamation-triangle':
                        notification.type === 'warning',
                      'fa-check-circle': notification.type === 'success',
                      'fa-times-circle': notification.type === 'error',
                    }"
                  ></i>
                </div>
                <div class="notification-content">
                  <div class="notification-title">{{ notification.title }}</div>
                  <div class="notification-message">
                    {{ notification.message }}
                  </div>
                  <div class="notification-time">
                    {{ notification.createdAt | date: "dd/MM/yyyy HH:mm" }}
                  </div>
                </div>
              </div>
              <div
                class="empty-notifications"
                *ngIf="notifications.length === 0"
              >
                <i class="fa-solid fa-bell-slash"></i>
                <p>Kh√¥ng c√≥ th√¥ng b√°o m·ªõi</p>
              </div>
            </div>
          </div>
        </div>

        <!-- User Profile with Gamification -->
        <div class="user-profile-widget dropdown">
          <button
            class="btn btn-user d-flex align-items-center gap-2"
            id="userProfileDropdown"
            data-bs-toggle="dropdown"
            aria-expanded="false"
          >
            <div class="user-avatar-box">
              <span class="user-avatar">{{ getUserInitial() }}</span>
              <span class="level-badge" [ngClass]="getLevelBadgeClass()">{{
                userLevel
              }}</span>
            </div>
            <div class="user-info d-none d-xl-block text-start">
              <div class="user-name">{{ getUserName() }}</div>
              <div class="user-level-name">
                <i class="fa-solid fa-trophy"></i>
                {{ getLevelName() }} - {{ userPoints }} ƒëi·ªÉm
              </div>
            </div>
            <i class="fa-solid fa-chevron-down"></i>
          </button>

          <ul
            class="dropdown-menu dropdown-menu-end dropdown-menu-dark"
            aria-labelledby="userProfileDropdown"
          >
            <li class="dropdown-header text-center">
              <div class="user-avatar-large">{{ getUserInitial() }}</div>
              <div class="mt-2">{{ getUserName() }}</div>
              <div class="level-info">
                <span class="level-badge-sm" [ngClass]="getLevelBadgeClass()">{{
                  userLevel
                }}</span>
                {{ getLevelName() }} - {{ userPoints }} ƒëi·ªÉm
              </div>
            </li>
            <li><hr class="dropdown-divider" /></li>
            <li *ngIf="isAdmin()">
              <a class="dropdown-item" routerLink="/admin/dashboard">
                <i class="fa-solid fa-chart-pie"></i> B·∫£ng ƒêi·ªÅu Khi·ªÉn
              </a>
            </li>
            <li *ngIf="isUser()">
              <a class="dropdown-item" routerLink="/my-account">
                <i class="fa-solid fa-user-circle"></i> T√†i Kho·∫£n
              </a>
            </li>
            <li *ngIf="isUser()">
              <a class="dropdown-item" routerLink="/gamification">
                <i class="fa-solid fa-trophy text-warning"></i> ƒêi·ªÉm Th∆∞·ªüng
              </a>
            </li>
            <li *ngIf="isUser()">
              <a class="dropdown-item" routerLink="/wishlist">
                <i class="fa-solid fa-heart text-danger"></i> Y√™u Th√≠ch
              </a>
            </li>
            <li><hr class="dropdown-divider" /></li>
            <li>
              <a class="dropdown-item text-danger" (click)="logout()">
                <i class="fa-solid fa-sign-out-alt"></i> ƒêƒÉng Xu·∫•t
              </a>
            </li>
          </ul>
        </div>
      </ng-container>

      <!-- Guest Actions -->
      <ng-container *ngIf="!isLoggedIn()">
        <button class="btn btn-outline-light btn-sm" routerLink="/register">
          ƒêƒÉng K√Ω
        </button>
        <button class="btn btn-primary btn-sm" routerLink="/login">
          <i class="fa-solid fa-sign-in-alt"></i> ƒêƒÉng Nh·∫≠p
        </button>
      </ng-container>
    </div>

    <!-- Mobile Hamburger Menu -->
    <button
      class="navbar-toggler d-lg-none"
      type="button"
      (click)="toggleMobileMenu()"
      aria-label="Toggle navigation"
    >
      <i
        class="fa-solid"
        [ngClass]="isMobileMenuOpen ? 'fa-times' : 'fa-bars'"
      ></i>
    </button>
  </div>
</nav>

<!-- Mobile Menu Overlay -->
<div
  class="mobile-menu-overlay"
  *ngIf="isMobileMenuOpen"
  (click)="closeMobileMenu()"
></div>

<!-- Mobile Menu Sidebar -->
<div class="mobile-menu-sidebar" [class.open]="isMobileMenuOpen">
  <div class="mobile-menu-header">
    <ng-container *ngIf="isLoggedIn()">
      <div class="mobile-user-profile">
        <div class="user-avatar-large">{{ getUserInitial() }}</div>
        <div class="mobile-user-info">
          <div class="user-name">{{ getUserName() }}</div>
          <div class="user-level">
            <span class="level-badge-sm" [ngClass]="getLevelBadgeClass()">{{
              userLevel
            }}</span>
            {{ getLevelName() }} - {{ userPoints }} ƒëi·ªÉm
          </div>
        </div>
      </div>
    </ng-container>
    <ng-container *ngIf="!isLoggedIn()">
      <div class="guest-actions">
        <button
          class="btn btn-primary btn-block w-100 mb-2"
          routerLink="/login"
          (click)="closeMobileMenu()"
        >
          <i class="fa-solid fa-sign-in-alt"></i> ƒêƒÉng Nh·∫≠p
        </button>
        <button
          class="btn btn-outline-primary btn-block w-100"
          routerLink="/register"
          (click)="closeMobileMenu()"
        >
          ƒêƒÉng K√Ω
        </button>
      </div>
    </ng-container>
  </div>

  <!-- Mobile Global Search -->
  <div class="mobile-search p-3" *ngIf="isLoggedIn()">
    <input
      type="text"
      class="form-control"
      placeholder="T√¨m s√°ch..."
      [(ngModel)]="globalSearchTerm"
      (keyup.enter)="performFullSearch(); closeMobileMenu()"
    />
  </div>

  <!-- Mobile Menu Items -->
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item" *ngIf="isLoggedIn()">
      <a routerLink="/" (click)="closeMobileMenu()">
        <i class="fa-solid fa-home"></i> Trang Ch·ªß
      </a>
    </li>

    <!-- Admin Menu -->
    <ng-container *ngIf="isAdmin()">
      <li class="mobile-menu-section-title">QU·∫¢N TR·ªä VI√äN</li>
      <li class="mobile-menu-item">
        <a routerLink="/admin/dashboard" (click)="closeMobileMenu()">
          <i class="fa-solid fa-chart-pie"></i> B·∫£ng ƒêi·ªÅu Khi·ªÉn
        </a>
      </li>
      <li class="mobile-menu-item">
        <a routerLink="/users" (click)="closeMobileMenu()">
          <i class="fa-solid fa-users-cog"></i> Ng∆∞·ªùi D√πng
        </a>
      </li>
      <li class="mobile-menu-item">
        <a routerLink="/books" (click)="closeMobileMenu()">
          <i class="fa-solid fa-book-medical"></i> S√°ch
        </a>
      </li>
      <li class="mobile-menu-item">
        <a routerLink="/admin/loans" (click)="closeMobileMenu()">
          <i class="fa-solid fa-exchange-alt"></i> M∆∞·ª£n/Tr·∫£
        </a>
      </li>
    </ng-container>

    <!-- User Menu -->
    <ng-container *ngIf="isUser()">
      <li class="mobile-menu-section-title">D·ªäCH V·ª§</li>
      <li class="mobile-menu-item">
        <a routerLink="/borrow-book" (click)="closeMobileMenu()">
          <i class="fa-solid fa-hand-holding-hand"></i> M∆∞·ª£n S√°ch
        </a>
      </li>
      <li class="mobile-menu-item">
        <a routerLink="/return-book" (click)="closeMobileMenu()">
          <i class="fa-solid fa-undo"></i> Tr·∫£ S√°ch
        </a>
      </li>
      <li class="mobile-menu-item">
        <a routerLink="/wishlist" (click)="closeMobileMenu()">
          <i class="fa-solid fa-heart text-danger"></i> Y√™u Th√≠ch
          <span class="badge bg-danger ms-auto" *ngIf="wishlistCount > 0">{{
            wishlistCount
          }}</span>
        </a>
      </li>
      <li class="mobile-menu-item">
        <a routerLink="/gamification" (click)="closeMobileMenu()">
          <i class="fa-solid fa-trophy text-warning"></i> ƒêi·ªÉm Th∆∞·ªüng
        </a>
      </li>
      <li class="mobile-menu-item">
        <a routerLink="/my-account" (click)="closeMobileMenu()">
          <i class="fa-solid fa-user-circle"></i> T√†i Kho·∫£n
        </a>
      </li>
    </ng-container>

    <li class="mobile-menu-section-title">C√ÄI ƒê·∫∂T</li>
    <li class="mobile-menu-item">
      <div class="d-flex justify-content-between align-items-center">
        <span>
          <i
            class="fa-solid"
            [ngClass]="currentTheme === 'dark' ? 'fa-moon' : 'fa-sun'"
          ></i>
          Ch·∫ø ƒë·ªô {{ currentTheme === "dark" ? "t·ªëi" : "s√°ng" }}
        </span>
        <button class="theme-toggle-mobile" (click)="toggleTheme()">
          <span
            class="toggle-handle-mobile"
            [class.active]="currentTheme === 'dark'"
          ></span>
        </button>
      </div>
    </li>
    <li class="mobile-menu-item">
      <div class="language-selector-mobile">
        <i class="fa-solid fa-language"></i> Ng√¥n ng·ªØ
        <div class="language-buttons">
          <button
            class="btn btn-sm"
            [class.btn-primary]="currentLanguage === 'vi'"
            [class.btn-outline-primary]="currentLanguage !== 'vi'"
            (click)="switchLanguage('vi')"
          >
            üáªüá≥ VI
          </button>
          <button
            class="btn btn-sm"
            [class.btn-primary]="currentLanguage === 'en'"
            [class.btn-outline-primary]="currentLanguage !== 'en'"
            (click)="switchLanguage('en')"
          >
            üá∫üá∏ EN
          </button>
        </div>
      </div>
    </li>

    <li class="mobile-menu-item" *ngIf="isLoggedIn()">
      <a (click)="logout(); closeMobileMenu()" class="text-danger">
        <i class="fa-solid fa-sign-out-alt"></i> ƒêƒÉng Xu·∫•t
      </a>
    </li>
  </ul>
</div>
