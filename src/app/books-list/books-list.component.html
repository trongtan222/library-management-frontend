<h2>Qu·∫£n L√≠ S√°ch</h2>

<!-- Advanced Filters -->
<div class="filters-bar mb-3 p-3 bg-light rounded border">
  <div class="row g-2 align-items-end">
    <div class="col-md-4">
      <label class="form-label small mb-1">üîç T√¨m ki·∫øm</label>
      <div class="input-group">
        <span class="input-group-text">üîé</span>
        <input
          class="form-control"
          type="text"
          placeholder="T√™n s√°ch, t√°c gi·∫£, ISBN..."
          [(ngModel)]="searchTerm"
          (ngModelChange)="onSearchChange()"
        />
        <button
          class="btn btn-outline-secondary"
          *ngIf="searchTerm"
          (click)="searchTerm = ''; loadBooks(1)"
        >
          ‚úï
        </button>
      </div>
    </div>

    <div class="col-md-2">
      <label class="form-label small mb-1">Tr·∫°ng th√°i</label>
      <select
        class="form-select"
        [(ngModel)]="filterStatus"
        (change)="onFilterChange()"
      >
        <option value="all">T·∫•t c·∫£</option>
        <option value="available">C√≤n h√†ng</option>
        <option value="outOfStock">H·∫øt h√†ng</option>
      </select>
    </div>

    <div class="col-md-2">
      <label class="form-label small mb-1">S·∫Øp x·∫øp nƒÉm</label>
      <select
        class="form-select"
        [(ngModel)]="filterYear"
        (change)="onFilterChange()"
      >
        <option value="all">M·∫∑c ƒë·ªãnh</option>
        <option value="newest">M·ªõi nh·∫•t</option>
        <option value="oldest">C≈© nh·∫•t</option>
      </select>
    </div>

    <div class="col-md-2">
      <label class="form-label small mb-1">Th·ªÉ lo·∫°i</label>
      <select
        class="form-select"
        [(ngModel)]="filterCategory"
        (change)="onFilterChange()"
      >
        <option value="">T·∫•t c·∫£</option>
        <option *ngFor="let cat of categories" [value]="cat">{{ cat }}</option>
      </select>
    </div>

    <div class="col-md-2">
      <button class="btn btn-outline-secondary w-100" (click)="resetFilters()">
        <i class="fa-solid fa-rotate-right"></i> ƒê·∫∑t l·∫°i
      </button>
    </div>
  </div>
</div>

<!-- Toolbar -->
<div
  class="d-flex align-items-center justify-content-between mb-3"
  style="gap: 12px"
>
  <div class="d-flex align-items-center gap-2">
    <button class="btn btn-outline-primary" (click)="navigateToImport()">
      <i class="fa-solid fa-file-import"></i> Nh·∫≠p Excel
    </button>

    <div class="btn-group" *ngIf="selectedBooks.size > 0">
      <button class="btn btn-outline-success" (click)="exportSelected()">
        <i class="fa-solid fa-download"></i> Xu·∫•t ({{ selectedBooks.size }})
      </button>
      <button class="btn btn-outline-danger" (click)="bulkDelete()">
        <i class="fa-solid fa-trash"></i> X√≥a ({{ selectedBooks.size }})
      </button>
    </div>

    <button
      class="btn btn-outline-secondary"
      (click)="toggleViewMode()"
      [title]="
        viewMode === 'table' ? 'Chuy·ªÉn sang d·∫°ng l∆∞·ªõi' : 'Chuy·ªÉn sang d·∫°ng b·∫£ng'
      "
    >
      <i
        [ngClass]="
          viewMode === 'table' ? 'fa-solid fa-grip' : 'fa-solid fa-table'
        "
      ></i>
    </button>
  </div>

  <div class="d-flex align-items-center" style="gap: 8px">
    <small class="text-muted me-2">
      {{ totalElements }} results ‚Ä¢ Page {{ page }} / {{ totalPages || "?" }}
    </small>
    <button
      class="btn btn-sm btn-outline-secondary"
      (click)="setPage(1)"
      [disabled]="page === 1"
      title="V·ªÅ trang ƒë·∫ßu"
    >
      ¬´ ƒê·∫ßu
    </button>
    <button
      class="btn btn-sm btn-outline-secondary"
      (click)="prevPage()"
      [disabled]="page === 1"
      title="Trang tr∆∞·ªõc"
    >
      ‚Äπ Tr∆∞·ªõc
    </button>
    <button
      class="btn btn-sm btn-outline-secondary"
      (click)="nextPage()"
      [disabled]="false"
      title="Trang ti·∫øp theo"
      style="min-width: 80px"
    >
      Ti·∫øp ‚Ä∫
    </button>
    <button
      class="btn btn-sm btn-outline-secondary"
      (click)="setPage(totalPages || 1)"
      [disabled]="page === totalPages && totalPages > 0"
      title="V·ªÅ trang cu·ªëi"
    >
      Cu·ªëi ¬ª
    </button>

    <select
      class="form-select form-select-sm ms-2"
      style="width: auto"
      [(ngModel)]="pageSize"
      (ngModelChange)="changePageSize($event)"
    >
      <option *ngFor="let s of pageSizes" [value]="s">{{ s }} / trang</option>
    </select>
  </div>
</div>

<!-- Table View -->
<div class="table-responsive" *ngIf="viewMode === 'table'">
  <table class="table table-hover align-middle">
    <thead>
      <tr>
        <th style="width: 40px">
          <input
            type="checkbox"
            class="form-check-input"
            [(ngModel)]="selectAllChecked"
            (change)="toggleSelectAll()"
          />
        </th>
        <th style="width: 60px">·∫¢nh</th>
        <th>ID</th>
        <th>T√™n</th>
        <th>T√°c Gi·∫£</th>
        <th>Th·ªÉ Lo·∫°i</th>
        <th>NƒÉm</th>
        <th>ISBN</th>
        <th>C√≤n</th>
        <th>H√†nh ƒê·ªông</th>
      </tr>
    </thead>
    <tbody *ngIf="listLoading">
      <tr *ngFor="let _ of skeletonRows">
        <td><div class="sk-circle"></div></td>
        <td><div class="sk-thumbnail"></div></td>
        <td><div class="sk-line w-60"></div></td>
        <td><div class="sk-line w-100"></div></td>
        <td><div class="sk-line w-90"></div></td>
        <td><div class="sk-line w-90"></div></td>
        <td><div class="sk-line w-50"></div></td>
        <td><div class="sk-line w-80"></div></td>
        <td><div class="sk-line w-40"></div></td>
        <td>
          <div class="d-flex gap-1">
            <div class="sk-circle"></div>
            <div class="sk-circle"></div>
            <div class="sk-circle"></div>
          </div>
        </td>
      </tr>
    </tbody>
    <tbody *ngIf="!listLoading">
      <tr *ngIf="books.length === 0">
        <td colspan="10" class="text-center text-muted py-4">
          Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ n√†o.
        </td>
      </tr>
      <tr *ngFor="let r of books; trackBy: trackByBookId">
        <td>
          <input
            type="checkbox"
            class="form-check-input"
            [checked]="isBookSelected(r.id)"
            (change)="toggleBookSelection(r.id)"
          />
        </td>
        <td>
          <img
            [src]="r.coverUrl || 'assets/images/placeholder.png'"
            class="book-thumbnail"
            [alt]="r.name"
          />
        </td>
        <td>{{ r.id }}</td>
        <td>
          <a
            [routerLink]="['/book-details', r.id]"
            class="text-decoration-none"
          >
            {{ r.name }}
          </a>
        </td>
        <td>
          <span *ngFor="let a of r.authors; let last = last">
            {{ a.name }}{{ !last ? ", " : "" }}
          </span>
        </td>
        <td>
          <span *ngFor="let c of r.categories; let last = last">
            {{ c.name }}{{ !last ? ", " : "" }}
          </span>
        </td>
        <td>{{ r.publishedYear || "-" }}</td>
        <td>{{ r.isbn || "-" }}</td>
        <td>
          <span
            class="badge"
            [ngClass]="
              r.numberOfCopiesAvailable > 0 ? 'bg-success' : 'bg-danger'
            "
          >
            {{ r.numberOfCopiesAvailable }}
          </span>
        </td>
        <td>
          <div class="btn-group">
            <button
              (click)="bookDetails(r.id)"
              class="btn btn-sm btn-outline-success"
            >
              Xem
            </button>
            <button
              (click)="updateBook(r.id)"
              class="btn btn-sm btn-outline-info"
            >
              S·ª≠a
            </button>
            <button
              (click)="deleteBook(r)"
              class="btn btn-sm btn-outline-danger"
            >
              X√≥a
            </button>
          </div>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<!-- Grid View -->
<div *ngIf="viewMode === 'grid'" class="books-grid">
  <!-- Skeleton Grid -->
  <div *ngIf="listLoading" class="row g-3">
    <div class="col-md-2 col-sm-4" *ngFor="let _ of skeletonRows">
      <div class="card book-grid-card">
        <div class="sk-thumbnail-large"></div>
        <div class="card-body">
          <div class="sk-line w-100 mb-2"></div>
          <div class="sk-line w-70"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Grid Books -->
  <div *ngIf="!listLoading" class="row g-3">
    <div
      class="col-md-2 col-sm-4 col-6"
      *ngFor="let book of books; trackBy: trackByBookId"
    >
      <div
        class="card book-grid-card h-100"
        [class.selected]="isBookSelected(book.id)"
      >
        <div class="position-relative">
          <input
            type="checkbox"
            class="form-check-input position-absolute top-0 start-0 m-2"
            style="z-index: 10"
            [checked]="isBookSelected(book.id)"
            (change)="toggleBookSelection(book.id)"
          />
          <img
            [src]="book.coverUrl || 'assets/images/placeholder.png'"
            class="card-img-top book-cover"
            [alt]="book.name"
            style="height: 240px; object-fit: cover; cursor: pointer"
            (click)="bookDetails(book.id)"
          />
          <span
            class="badge position-absolute top-0 end-0 m-2"
            [ngClass]="
              book.numberOfCopiesAvailable > 0 ? 'bg-success' : 'bg-danger'
            "
          >
            {{ book.numberOfCopiesAvailable }}
          </span>
        </div>
        <div class="card-body p-2">
          <h6 class="card-title mb-1 text-truncate" [title]="book.name">
            {{ book.name }}
          </h6>
          <div class="small text-muted text-truncate">
            {{ book.authors?.[0]?.name || "N/A" }}
          </div>
          <div class="d-flex gap-1 mt-2">
            <button
              class="btn btn-sm btn-outline-success flex-fill"
              (click)="bookDetails(book.id)"
              title="Xem"
            >
              <i class="fa-solid fa-eye"></i>
            </button>
            <button
              class="btn btn-sm btn-outline-info flex-fill"
              (click)="updateBook(book.id)"
              title="S·ª≠a"
            >
              <i class="fa-solid fa-pen"></i>
            </button>
            <button
              class="btn btn-sm btn-outline-danger flex-fill"
              (click)="deleteBook(book)"
              title="X√≥a"
            >
              <i class="fa-solid fa-trash"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="books.length === 0" class="col-12 text-center py-5 text-muted">
      <i class="fa-solid fa-box-open fa-3x mb-3 opacity-50"></i>
      <p>Kh√¥ng t√¨m th·∫•y s√°ch n√†o.</p>
    </div>
  </div>
</div>

<!-- Modals -->
<!-- Borrow Modal -->
<div class="modal-backdrop fade show" *ngIf="showBorrow"></div>
<div class="modal fade show d-block" tabindex="-1" *ngIf="showBorrow">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          üìö T·∫°o Phi·∫øu M∆∞·ª£n
          <div class="small text-muted mt-1">{{ borrowingBook?.name }}</div>
        </h5>
        <button
          type="button"
          class="btn-close"
          (click)="closeBorrow()"
        ></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label"
            >ID Th√†nh Vi√™n <span class="text-danger">*</span></label
          >
          <input
            type="number"
            class="form-control"
            [(ngModel)]="borrowForm.memberId"
            placeholder="Nh·∫≠p ID ng∆∞·ªùi m∆∞·ª£n"
            min="1"
          />
        </div>
        <div class="mb-3">
          <label class="form-label"
            >Ng√†y H·∫øt H·∫°n <span class="text-danger">*</span></label
          >
          <input
            type="date"
            class="form-control"
            [(ngModel)]="borrowForm.dueDate"
          />
        </div>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-secondary" (click)="closeBorrow()">
          H·ªßy
        </button>
        <button
          type="button"
          class="btn btn-primary"
          (click)="submitBorrow()"
          [disabled]="isLoading(borrowingBook!.id)"
        >
          <span
            *ngIf="isLoading(borrowingBook!.id)"
            class="spinner-border spinner-border-sm me-1"
          ></span>
          X√°c nh·∫≠n M∆∞·ª£n
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Reserve Modal -->
<div class="modal-backdrop fade show" *ngIf="showReserve"></div>
<div class="modal fade show d-block" tabindex="-1" *ngIf="showReserve">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          üîñ ƒê·∫∑t Tr∆∞·ªõc S√°ch
          <div class="small text-muted mt-1">{{ reservingBook?.name }}</div>
        </h5>
        <button
          type="button"
          class="btn-close"
          (click)="closeReserve()"
        ></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label"
            >ID Th√†nh Vi√™n <span class="text-danger">*</span></label
          >
          <input
            type="number"
            class="form-control"
            [(ngModel)]="reserveForm.memberId"
            placeholder="Nh·∫≠p ID ng∆∞·ªùi ƒë·∫∑t tr∆∞·ªõc"
            min="1"
          />
        </div>
        <div class="alert alert-info mb-0">
          <i class="fa-solid fa-info-circle me-2"></i>
          S√°ch s·∫Ω ƒë∆∞·ª£c gi·ªØ trong 24h khi c√≥ ng∆∞·ªùi tr·∫£.
        </div>
      </div>
      <div class="modal-footer border-0">
        <button
          type="button"
          class="btn btn-secondary"
          (click)="closeReserve()"
        >
          H·ªßy
        </button>
        <button
          type="button"
          class="btn btn-warning"
          (click)="submitReserve()"
          [disabled]="isLoading(reservingBook!.id)"
        >
          <span
            *ngIf="isLoading(reservingBook!.id)"
            class="spinner-border spinner-border-sm me-1"
          ></span>
          X√°c nh·∫≠n ƒê·∫∑t
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-backdrop fade show" *ngIf="bookToDelete"></div>
<div class="modal fade show d-block" tabindex="-1" *ngIf="bookToDelete">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">
          <i class="fa-solid fa-triangle-exclamation me-2"></i>X√°c nh·∫≠n x√≥a
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          (click)="bookToDelete = null"
        ></button>
      </div>
      <div class="modal-body">
        <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s√°ch:</p>
        <div class="alert alert-warning">
          <strong>{{ bookToDelete.name }}</strong>
          <div class="small text-muted">ID: {{ bookToDelete.id }}</div>
        </div>
        <p class="text-danger mb-0">
          <i class="fa-solid fa-warning me-1"></i>
          H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!
        </p>
      </div>
      <div class="modal-footer border-0">
        <button
          type="button"
          class="btn btn-secondary"
          (click)="bookToDelete = null"
        >
          H·ªßy
        </button>
        <button type="button" class="btn btn-danger" (click)="confirmDelete()">
          <i class="fa-solid fa-trash me-1"></i> X√≥a vƒ©nh vi·ªÖn
        </button>
      </div>
    </div>
  </div>
</div>
