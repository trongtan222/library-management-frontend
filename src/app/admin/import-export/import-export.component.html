<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h2 class="mb-0">
        <i class="fa-solid fa-file-import"></i> Nhập/Xuất Dữ Liệu
      </h2>
      <p class="text-muted mb-0">
        <strong>Mới:</strong> Kéo-thả file, Preview trước khi upload, Mapping
        cột tự động, Tải báo cáo lỗi Excel
      </p>
    </div>
    <div class="btn-group">
      <button
        class="btn btn-outline-info"
        (click)="downloadTemplate('users')"
        [disabled]="isDownloadingTemplate"
      >
        <i class="fa-solid fa-cloud-download-alt me-1"></i> Template Users
      </button>
      <button
        class="btn btn-outline-warning"
        (click)="downloadTemplate('books')"
        [disabled]="isDownloadingTemplate"
      >
        <i class="fa-solid fa-cloud-download-alt me-1"></i> Template Books
      </button>
    </div>
  </div>

  <div class="row g-4 mt-1">
    <!-- BOOKS SECTION -->
    <div class="col-lg-6">
      <div class="card shadow-sm border-0">
        <div
          class="card-header bg-light fw-bold d-flex justify-content-between align-items-center"
        >
          <span><i class="fa-solid fa-book me-2"></i>Sách</span>
          <small class="text-muted"
            >Cột: Tên sách, ISBN, Năm XB, Số lượng, Ảnh bìa</small
          >
        </div>
        <div class="card-body">
          <!-- DRAG & DROP ZONE -->
          <div
            class="drop-zone"
            [class.dragging]="isDraggingBooks"
            (dragover)="onDragOver($event, 'books')"
            (dragleave)="onDragLeave($event, 'books')"
            (drop)="onDrop($event, 'books')"
            (click)="booksFileInput.click()"
          >
            <i class="fa-solid fa-cloud-upload-alt fa-3x mb-3 text-muted"></i>
            <p class="mb-2 fw-bold">
              Kéo thả file Excel/CSV vào đây hoặc click để chọn
            </p>
            <p class="small text-muted mb-0">
              Hỗ trợ .xlsx, .xls, .csv (Max 10MB)
            </p>
            <input
              #booksFileInput
              type="file"
              class="d-none"
              accept=".csv,.xlsx,.xls"
              (change)="onFileChange($event, 'books')"
            />
          </div>

          <div *ngIf="booksFile" class="alert alert-success mt-3 mb-0">
            <i class="fa-solid fa-check-circle me-2"></i>
            Đã chọn: <strong>{{ booksFile.name }}</strong>
          </div>

          <!-- PREVIEW TABLE -->
          <div *ngIf="showBooksPreview" class="mt-3 animate-fade-in">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0 fw-bold">
                <i class="fa-solid fa-eye me-1"></i> Preview (5 dòng đầu)
              </h6>
              <button
                class="btn btn-sm btn-outline-secondary"
                (click)="toggleMapping('books')"
              >
                <i class="fa-solid fa-cog me-1"></i>
                {{ showBooksMapping ? "Ẩn" : "Hiện" }} Mapping
              </button>
            </div>
            <div class="table-responsive">
              <table class="table table-sm table-bordered mb-0">
                <thead class="table-light">
                  <tr>
                    <th *ngFor="let col of booksColumns">{{ col }}</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let row of booksPreviewData">
                    <td *ngFor="let col of booksColumns">{{ row[col] }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- COLUMN MAPPING -->
          <div
            *ngIf="showBooksMapping"
            class="mt-3 p-3 border rounded bg-light animate-fade-in"
          >
            <h6 class="fw-bold mb-3">
              <i class="fa-solid fa-exchange-alt me-1"></i> Column Mapping
            </h6>
            <div class="row g-2">
              <div class="col-md-6" *ngFor="let field of expectedBooksFields">
                <label class="form-label small mb-1">{{ field }}</label>
                <select
                  class="form-select form-select-sm"
                  [(ngModel)]="booksMapping[field]"
                >
                  <option [value]="undefined">-- Không map --</option>
                  <option *ngFor="let col of booksColumns" [value]="col">
                    {{ col }}
                  </option>
                </select>
              </div>
            </div>
          </div>

          <div class="d-flex flex-wrap gap-2 mt-3">
            <button
              class="btn btn-primary"
              [disabled]="isUploadingBooks || !booksFile"
              (click)="importBooks()"
            >
              <span
                *ngIf="isUploadingBooks"
                class="spinner-border spinner-border-sm me-1"
              ></span>
              <i class="fa-solid fa-upload me-1" *ngIf="!isUploadingBooks"></i>
              Nhập sách
            </button>
            <button
              class="btn btn-outline-secondary"
              [disabled]="isExportingBooks"
              (click)="exportBooks()"
            >
              <span
                *ngIf="isExportingBooks"
                class="spinner-border spinner-border-sm me-1"
              ></span>
              <i
                class="fa-solid fa-download me-1"
                *ngIf="!isExportingBooks"
              ></i>
              Xuất sách
            </button>
          </div>

          <!-- RESULT SUMMARY (ENHANCED) -->
          <div *ngIf="booksSummary" class="alert alert-info mt-3 mb-0">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="fw-bold">
                <i class="fa-solid fa-info-circle me-1"></i> Kết quả nhập sách
              </div>
              <button
                class="btn btn-sm btn-outline-danger"
                *ngIf="booksSummary.errors && booksSummary.errors.length > 0"
                (click)="downloadErrorReport('books')"
              >
                <i class="fa-solid fa-file-download me-1"></i> Tải báo cáo lỗi
              </button>
            </div>
            <div class="small">
              Thành công:
              <strong class="text-success">{{
                booksSummary.successCount
              }}</strong>
              | Lỗi:
              <strong class="text-danger">{{
                booksSummary.failedCount
              }}</strong>
              | Bỏ qua: {{ booksSummary.skippedCount }}
            </div>
            <div
              *ngIf="booksSummary.errors && booksSummary.errors.length > 0"
              class="mt-2"
            >
              <div class="small fw-bold">
                Chi tiết {{ booksSummary.errors.length }} lỗi (hiển thị tối đa
                3):
              </div>
              <ul class="small ps-3 mb-0 mt-1">
                <li *ngFor="let e of booksSummary.errors.slice(0, 3)">
                  {{ e }}
                </li>
                <li *ngIf="booksSummary.errors.length > 3">
                  <em
                    >... và {{ booksSummary.errors.length - 3 }} lỗi khác (Bấm
                    "Tải báo cáo" để xem đầy đủ)</em
                  >
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- USERS SECTION -->
    <div class="col-lg-6">
      <div class="card shadow-sm border-0">
        <div
          class="card-header bg-light fw-bold d-flex justify-content-between align-items-center"
        >
          <span><i class="fa-solid fa-users me-2"></i>Người dùng</span>
          <small class="text-muted">Cột: Mã SV, Tên, Email, Lớp</small>
        </div>
        <div class="card-body">
          <!-- DRAG & DROP ZONE -->
          <div
            class="drop-zone"
            [class.dragging]="isDraggingUsers"
            (dragover)="onDragOver($event, 'users')"
            (dragleave)="onDragLeave($event, 'users')"
            (drop)="onDrop($event, 'users')"
            (click)="usersFileInput.click()"
          >
            <i class="fa-solid fa-cloud-upload-alt fa-3x mb-3 text-muted"></i>
            <p class="mb-2 fw-bold">
              Kéo thả file Excel/CSV vào đây hoặc click để chọn
            </p>
            <p class="small text-muted mb-0">
              Hỗ trợ .xlsx, .xls, .csv (Max 10MB)
            </p>
            <input
              #usersFileInput
              type="file"
              class="d-none"
              accept=".csv,.xlsx,.xls"
              (change)="onFileChange($event, 'users')"
            />
          </div>

          <div *ngIf="usersFile" class="alert alert-success mt-3 mb-0">
            <i class="fa-solid fa-check-circle me-2"></i>
            Đã chọn: <strong>{{ usersFile.name }}</strong>
          </div>

          <!-- PREVIEW TABLE -->
          <div *ngIf="showUsersPreview" class="mt-3 animate-fade-in">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0 fw-bold">
                <i class="fa-solid fa-eye me-1"></i> Preview (5 dòng đầu)
              </h6>
              <button
                class="btn btn-sm btn-outline-secondary"
                (click)="toggleMapping('users')"
              >
                <i class="fa-solid fa-cog me-1"></i>
                {{ showUsersMapping ? "Ẩn" : "Hiện" }} Mapping
              </button>
            </div>
            <div class="table-responsive">
              <table class="table table-sm table-bordered mb-0">
                <thead class="table-light">
                  <tr>
                    <th *ngFor="let col of usersColumns">{{ col }}</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let row of usersPreviewData">
                    <td *ngFor="let col of usersColumns">{{ row[col] }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- COLUMN MAPPING -->
          <div
            *ngIf="showUsersMapping"
            class="mt-3 p-3 border rounded bg-light animate-fade-in"
          >
            <h6 class="fw-bold mb-3">
              <i class="fa-solid fa-exchange-alt me-1"></i> Column Mapping
            </h6>
            <div class="row g-2">
              <div class="col-md-6" *ngFor="let field of expectedUsersFields">
                <label class="form-label small mb-1">{{ field }}</label>
                <select
                  class="form-select form-select-sm"
                  [(ngModel)]="usersMapping[field]"
                >
                  <option [value]="undefined">-- Không map --</option>
                  <option *ngFor="let col of usersColumns" [value]="col">
                    {{ col }}
                  </option>
                </select>
              </div>
            </div>
          </div>

          <div class="d-flex flex-wrap gap-2 mt-3">
            <button
              class="btn btn-primary"
              [disabled]="isUploadingUsers || !usersFile"
              (click)="importUsers()"
            >
              <span
                *ngIf="isUploadingUsers"
                class="spinner-border spinner-border-sm me-1"
              ></span>
              <i class="fa-solid fa-upload me-1" *ngIf="!isUploadingUsers"></i>
              Nhập users
            </button>
            <button
              class="btn btn-outline-secondary"
              [disabled]="isExportingUsers"
              (click)="exportUsers()"
            >
              <span
                *ngIf="isExportingUsers"
                class="spinner-border spinner-border-sm me-1"
              ></span>
              <i
                class="fa-solid fa-download me-1"
                *ngIf="!isExportingUsers"
              ></i>
              Xuất users
            </button>
          </div>

          <!-- RESULT SUMMARY (ENHANCED) -->
          <div *ngIf="usersSummary" class="alert alert-info mt-3 mb-0">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="fw-bold">
                <i class="fa-solid fa-info-circle me-1"></i> Kết quả nhập người
                dùng
              </div>
              <button
                class="btn btn-sm btn-outline-danger"
                *ngIf="usersSummary.errors && usersSummary.errors.length > 0"
                (click)="downloadErrorReport('users')"
              >
                <i class="fa-solid fa-file-download me-1"></i> Tải báo cáo lỗi
              </button>
            </div>
            <div class="small">
              Thành công:
              <strong class="text-success">{{
                usersSummary.successCount
              }}</strong>
              | Lỗi:
              <strong class="text-danger">{{
                usersSummary.failedCount
              }}</strong>
              | Bỏ qua: {{ usersSummary.skippedCount }}
            </div>
            <div
              *ngIf="usersSummary.errors && usersSummary.errors.length > 0"
              class="mt-2"
            >
              <div class="small fw-bold">
                Chi tiết {{ usersSummary.errors.length }} lỗi (hiển thị tối đa
                3):
              </div>
              <ul class="small ps-3 mb-0 mt-1">
                <li *ngFor="let e of usersSummary.errors.slice(0, 3)">
                  {{ e }}
                </li>
                <li *ngIf="usersSummary.errors.length > 3">
                  <em
                    >... và {{ usersSummary.errors.length - 3 }} lỗi khác (Bấm
                    "Tải báo cáo" để xem đầy đủ)</em
                  >
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="alert alert-warning mt-4" role="alert">
    <div class="fw-bold mb-1">
      <i class="fa-solid fa-circle-info me-1"></i> Lưu ý nhanh
    </div>
    <ul class="mb-0 small ps-3">
      <li>
        User: mật khẩu tự sinh 10 ký tự, role mặc định ROLE_USER, bỏ qua trùng
        mã SV.
      </li>
      <li>
        Books: nếu ISBN đã tồn tại, hệ thống cộng thêm số lượng thay vì tạo bản
        ghi mới.
      </li>
      <li>File được đọc theo UTF-8; dùng template để tránh lệch cột.</li>
    </ul>
  </div>
</div>
