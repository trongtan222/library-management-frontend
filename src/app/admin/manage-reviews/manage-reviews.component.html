<div class="container-fluid mt-4">
  <h1 class="mb-4">Qu·∫£n L√Ω ƒê√°nh Gi√° S√°ch</h1>

  <!-- BULK ACTION BANNER -->
  <div
    *ngIf="canBulkAction()"
    class="alert alert-info d-flex align-items-center justify-content-between mb-3"
  >
    <span>
      <i class="fa-solid fa-check-double"></i>
      <strong>ƒê√£ ch·ªçn {{ getSelectedCount() }} ƒë√°nh gi√°</strong>
    </span>
    <div class="btn-group">
      <button class="btn btn-success btn-sm" (click)="bulkApprove()">
        <i class="fa-solid fa-check"></i> Duy·ªát t·∫•t c·∫£
      </button>
      <button class="btn btn-danger btn-sm" (click)="bulkDelete()">
        <i class="fa-solid fa-trash"></i> X√≥a t·∫•t c·∫£
      </button>
    </div>
  </div>

  <div *ngIf="isLoading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status"></div>
    <p class="mt-2">ƒêang t·∫£i...</p>
  </div>

  <div *ngIf="!isLoading">
    <!-- FILTERS -->
    <div class="d-flex align-items-center gap-2 mb-3">
      <input
        class="form-control"
        style="max-width: 300px"
        [(ngModel)]="search"
        placeholder="üîç T√¨m s√°ch/ng∆∞·ªùi d√πng/n·ªôi dung"
      />
      <select
        class="form-select"
        style="max-width: 180px"
        [(ngModel)]="statusFilter"
      >
        <option value="ALL">T·∫•t c·∫£</option>
        <option value="PENDING">Ch·ªù duy·ªát</option>
        <option value="APPROVED">ƒê√£ duy·ªát</option>
      </select>
    </div>

    <!-- TABLE -->
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead>
          <tr>
            <th style="width: 40px">
              <input
                type="checkbox"
                class="form-check-input"
                [checked]="
                  getSelectedCount() === filtered().length &&
                  filtered().length > 0
                "
                (change)="selectAll()"
              />
            </th>
            <th style="width: 60px"></th>
            <th>S√°ch</th>
            <th>Ng∆∞·ªùi ƒê√°nh Gi√°</th>
            <th style="width: 140px">ƒêi·ªÉm</th>
            <th style="width: 35%">B√¨nh Lu·∫≠n</th>
            <th style="width: 110px">Tr·∫°ng Th√°i</th>
            <th style="width: 150px">H√†nh ƒê·ªông</th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="let review of filtered()"
            [class.table-info]="isSelected(review.id)"
          >
            <!-- CHECKBOX -->
            <td>
              <input
                type="checkbox"
                class="form-check-input"
                [checked]="isSelected(review.id)"
                (change)="toggleSelection(review.id)"
              />
            </td>

            <!-- THUMBNAIL -->
            <td>
              <img
                [src]="review.bookCoverUrl || 'assets/books/placeholder.png'"
                alt="Cover"
                class="book-thumbnail"
                onerror="this.src = 'assets/books/placeholder.png'"
              />
            </td>

            <!-- BOOK NAME -->
            <td>
              <strong>{{ review.bookName }}</strong>
            </td>

            <!-- USER -->
            <td>{{ review.userName }}</td>

            <!-- STAR RATING -->
            <td>
              <span class="star-rating">
                <i
                  *ngFor="let filled of getStarArray(review.rating)"
                  class="fa-solid fa-star"
                  [class.text-warning]="filled"
                  [class.text-muted]="!filled"
                ></i>
              </span>
              <span class="text-muted ms-1">({{ review.rating }})</span>
            </td>

            <!-- COMMENT (TRUNCATED) -->
            <td>
              <div class="comment-wrapper">
                <p class="mb-1">{{ getTruncatedComment(review) }}</p>
                <button
                  *ngIf="isCommentLong(review.comment)"
                  class="btn btn-link btn-sm p-0 text-decoration-none"
                  (click)="toggleCommentExpansion(review.id)"
                >
                  {{ isCommentExpanded(review.id) ? "Thu g·ªçn" : "Xem th√™m" }}
                </button>

                <!-- ADMIN REPLY DISPLAY -->
                <div
                  *ngIf="review.adminReply && !replyingToReview"
                  class="admin-reply mt-2"
                >
                  <i class="fa-solid fa-shield-halved text-primary"></i>
                  <strong>Admin:</strong> {{ review.adminReply }}
                  <small class="text-muted d-block mt-1">
                    {{ review.adminReplyDate | date: "dd/MM/yyyy HH:mm" }}
                  </small>
                </div>

                <!-- INLINE REPLY FORM -->
                <div
                  *ngIf="replyingToReview?.id === review.id"
                  class="reply-form mt-2"
                >
                  <textarea
                    class="form-control form-control-sm mb-2"
                    rows="3"
                    [(ngModel)]="replyText"
                    placeholder="Nh·∫≠p tr·∫£ l·ªùi c·ªßa admin..."
                    maxlength="500"
                  ></textarea>
                  <div class="d-flex gap-2">
                    <button
                      class="btn btn-primary btn-sm"
                      (click)="saveReply()"
                    >
                      <i class="fa-solid fa-paper-plane"></i> G·ª≠i
                    </button>
                    <button
                      class="btn btn-outline-secondary btn-sm"
                      (click)="cancelReply()"
                    >
                      H·ªßy
                    </button>
                  </div>
                </div>
              </div>
            </td>

            <!-- STATUS -->
            <td>
              <span
                class="badge"
                [ngClass]="
                  review.approved ? 'bg-success' : 'bg-warning text-dark'
                "
              >
                {{ review.approved ? "ƒê√£ Duy·ªát" : "Ch·ªù Duy·ªát" }}
              </span>
            </td>

            <!-- ACTIONS -->
            <td>
              <div class="btn-group-vertical btn-group-sm" role="group">
                <button
                  *ngIf="!review.approved"
                  class="btn btn-outline-success"
                  (click)="approve(review)"
                  title="Ph√™ duy·ªát"
                >
                  <i class="fa-solid fa-check"></i> Duy·ªát
                </button>
                <button
                  class="btn btn-outline-primary"
                  (click)="openReplyForm(review)"
                  title="Tr·∫£ l·ªùi"
                >
                  <i class="fa-solid fa-reply"></i> Tr·∫£ l·ªùi
                </button>
                <button
                  class="btn btn-outline-danger"
                  (click)="delete(review)"
                  title="X√≥a"
                >
                  <i class="fa-solid fa-trash"></i> X√≥a
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div *ngIf="filtered().length === 0" class="text-center text-muted py-5">
      <i class="fa-solid fa-inbox fa-3x mb-3"></i>
      <p>Kh√¥ng c√≥ ƒë√°nh gi√° n√†o ph√π h·ª£p</p>
    </div>
  </div>
</div>
