<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">üìã Trung t√¢m ƒëi·ªÅu h√†nh Phi·∫øu m∆∞·ª£n</h1>
    <button
      class="btn btn-success"
      (click)="exportToExcel()"
      [disabled]="filteredLoans.length === 0"
    >
      <i class="fa-solid fa-file-excel me-2"></i> Xu·∫•t Excel
    </button>
  </div>

  <!-- Status Filter Pills -->
  <div class="nav nav-pills mb-3">
    <button
      class="nav-link"
      [class.active]="currentFilter === 'ALL'"
      (click)="applyFilter('ALL')"
    >
      T·∫•t C·∫£ <span class="badge bg-secondary ms-1">{{ allLoans.length }}</span>
    </button>
    <button
      class="nav-link"
      [class.active]="currentFilter === 'ACTIVE'"
      (click)="applyFilter('ACTIVE')"
    >
      ƒêang M∆∞·ª£n
    </button>
    <button
      class="nav-link"
      [class.active]="currentFilter === 'OVERDUE'"
      (click)="applyFilter('OVERDUE')"
    >
      Qu√° H·∫°n
    </button>
    <button
      class="nav-link"
      [class.active]="currentFilter === 'RETURNED'"
      (click)="applyFilter('RETURNED')"
    >
      ƒê√£ Tr·∫£
    </button>
  </div>

  <!-- Advanced Filters: Date Range + Search -->
  <div class="card bg-dark border-secondary mb-4">
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-md-3">
          <label class="form-label small text-muted">T·ª´ ng√†y</label>
          <input
            type="date"
            class="form-control form-control-sm"
            [(ngModel)]="dateFrom"
            (change)="onDateRangeChange()"
          />
        </div>
        <div class="col-md-3">
          <label class="form-label small text-muted">ƒê·∫øn ng√†y</label>
          <input
            type="date"
            class="form-control form-control-sm"
            [(ngModel)]="dateTo"
            (change)="onDateRangeChange()"
          />
        </div>
        <div class="col-md-4">
          <label class="form-label small text-muted"
            >T√¨m ki·∫øm (T√™n s√°ch, Ng∆∞·ªùi d√πng, ID)</label
          >
          <input
            type="text"
            class="form-control form-control-sm"
            placeholder="Nh·∫≠p t·ª´ kh√≥a..."
            [(ngModel)]="searchText"
            (input)="onSearchChange()"
          />
        </div>
        <div class="col-md-2">
          <button
            class="btn btn-sm btn-outline-warning w-100"
            (click)="
              dateFrom = ''; dateTo = ''; searchText = ''; applyAllFilters()
            "
          >
            <i class="fa-solid fa-rotate-right me-1"></i> Reset
          </button>
        </div>
      </div>
      <div
        class="small text-muted mt-2"
        *ngIf="filteredLoans.length !== allLoans.length"
      >
        ƒêang hi·ªÉn th·ªã
        <strong class="text-warning">{{ filteredLoans.length }}</strong> /
        {{ allLoans.length }} phi·∫øu
      </div>
    </div>
  </div>

  <div *ngIf="isLoading" class="text-center my-5">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>
  <div *ngIf="errorMessage" class="alert alert-danger">{{ errorMessage }}</div>

  <div *ngIf="!isLoading && !errorMessage" class="table-responsive">
    <table class="table table-hover align-middle">
      <thead>
        <tr>
          <th class="sortable" (click)="sortColumn('loanId')">
            ID M∆∞·ª£n
            <i class="fa-solid ms-1" [ngClass]="getSortIcon('loanId')"></i>
          </th>
          <th class="sortable" (click)="sortColumn('bookName')">
            T√™n S√°ch
            <i class="fa-solid ms-1" [ngClass]="getSortIcon('bookName')"></i>
          </th>
          <th class="sortable" (click)="sortColumn('userName')">
            T√™n Ng∆∞·ªùi D√πng
            <i class="fa-solid ms-1" [ngClass]="getSortIcon('userName')"></i>
          </th>
          <th class="sortable" (click)="sortColumn('loanDate')">
            Ng√†y M∆∞·ª£n
            <i class="fa-solid ms-1" [ngClass]="getSortIcon('loanDate')"></i>
          </th>
          <th class="sortable" (click)="sortColumn('dueDate')">
            Ng√†y H·∫øt H·∫°n
            <i class="fa-solid ms-1" [ngClass]="getSortIcon('dueDate')"></i>
          </th>
          <th>Ng√†y Tr·∫£</th>
          <th class="sortable" (click)="sortColumn('status')">
            Tr·∫°ng Th√°i
            <i class="fa-solid ms-1" [ngClass]="getSortIcon('status')"></i>
          </th>
          <th style="min-width: 200px">H√†nh ƒê·ªông</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngIf="filteredLoans.length === 0">
          <td colspan="8" class="text-center text-muted py-4">
            <i class="fa-solid fa-inbox fa-3x mb-3 opacity-50"></i>
            <div>Kh√¥ng t√¨m th·∫•y phi·∫øu m∆∞·ª£n n√†o cho b·ªô l·ªçc n√†y.</div>
          </td>
        </tr>
        <tr *ngFor="let loan of filteredLoans">
          <td>{{ loan.loanId }}</td>
          <td>
            <span class="book-name-hover" [title]="loan.bookName">
              {{
                loan.bookName.length > 30
                  ? (loan.bookName | slice: 0 : 30) + "..."
                  : loan.bookName
              }}
            </span>
          </td>
          <td>
            <span class="user-name-hover" [title]="loan.userName">
              {{ loan.userName }}
            </span>
          </td>
          <td>{{ loan.loanDate | date: "dd/MM/yyyy" }}</td>
          <td>
            <span [class.text-danger]="loan.status === 'OVERDUE'">
              {{ loan.dueDate | date: "dd/MM/yyyy" }}
            </span>
          </td>
          <td>
            {{ loan.returnDate ? (loan.returnDate | date: "dd/MM/yyyy") : "-" }}
          </td>
          <td>
            <span
              class="badge"
              [ngClass]="{
                'bg-success': loan.status === 'ACTIVE',
                'bg-danger': loan.status === 'OVERDUE',
                'bg-secondary': loan.status === 'RETURNED',
              }"
              >{{ loan.status }}</span
            >
          </td>
          <td>
            <div class="btn-group btn-group-sm" role="group">
              <!-- G·ª≠i Nh·∫Øc Nh·ªü (OVERDUE only) -->
              <button
                *ngIf="loan.status === 'OVERDUE'"
                class="btn btn-outline-warning"
                (click)="sendReminder(loan.loanId)"
                title="G·ª≠i email nh·∫Øc tr·∫£ s√°ch"
              >
                <i class="fa-solid fa-bell"></i>
              </button>

              <!-- Gia h·∫°n (ACTIVE only) -->
              <button
                *ngIf="loan.status === 'ACTIVE'"
                class="btn btn-outline-info"
                (click)="renewLoan(loan.loanId)"
                title="Gia h·∫°n th√™m 7 ng√†y"
              >
                <i class="fa-solid fa-rotate"></i>
              </button>

              <!-- Tr·∫£ s√°ch (ACTIVE or OVERDUE) -->
              <button
                *ngIf="loan.status === 'ACTIVE' || loan.status === 'OVERDUE'"
                class="btn btn-outline-success"
                (click)="markAsReturned(loan.loanId)"
                title="ƒê√°nh d·∫•u ƒë√£ tr·∫£"
              >
                <i class="fa-solid fa-check"></i>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
