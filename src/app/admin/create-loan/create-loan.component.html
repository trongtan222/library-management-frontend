<div class="container mt-4">
  <div class="card shadow-lg border-0 bg-dark text-white">
    <div
      class="card-header bg-primary text-white d-flex justify-content-between align-items-center"
    >
      <div>
        <h3 class="mb-0">
          <i class="fa-solid fa-file-signature me-2"></i>T·∫°o Phi·∫øu M∆∞·ª£n (Admin)
        </h3>
        <small class="text-white-50"
          >‚å®Ô∏è Ph√≠m t·∫Øt: Ctrl+S (Scanner) | F2 (X√≥a gi·ªè) | F3 (User) | F4 (S√°ch)
          | Ctrl+Enter (Submit)</small
        >
      </div>
      <div class="d-flex gap-2">
        <button
          class="btn btn-outline-light btn-sm"
          type="button"
          (click)="downloadBulkTemplate()"
        >
          <i class="fa-solid fa-download me-1"></i>T·∫£i file m·∫´u CSV
        </button>
        <label class="btn btn-warning btn-sm mb-0">
          <i class="fa-solid fa-file-import me-1"></i>Import CSV
          <input
            type="file"
            accept=".csv"
            (change)="onBulkImportFile($event)"
            style="display: none"
          />
        </label>
      </div>
    </div>
    <div class="card-body p-4">
      <div class="row g-4">
        <!-- C·ªòT 1: CH·ªåN NG∆Ø·ªúI D√ôNG -->
        <div class="col-md-6 border-end border-secondary">
          <h5
            class="text-info mb-3 d-flex align-items-center justify-content-between"
          >
            <span
              ><i class="fa-solid fa-user me-2"></i>B∆∞·ªõc 1: Ch·ªçn ƒê·ªôc Gi·∫£</span
            >
            <div class="d-flex gap-2">
              <button
                class="btn btn-sm btn-outline-info"
                type="button"
                (click)="toggleRecentUsers()"
                *ngIf="recentUsers.length > 0"
              >
                <i class="fa-solid fa-clock-rotate-left me-1"></i>
                {{ showRecentUsers ? "·∫®n" : "Hi·ªán" }} g·∫ßn ƒë√¢y ({{
                  recentUsers.length
                }})
              </button>
              <button
                class="btn btn-sm btn-outline-danger"
                type="button"
                (click)="clearRecentUsers()"
                *ngIf="recentUsers.length > 0"
              >
                <i class="fa-solid fa-trash me-1"></i>X√≥a l·ªãch s·ª≠
              </button>
            </div>
          </h5>

          <!-- Recent Users List -->
          <div
            class="list-group mb-3 shadow"
            *ngIf="showRecentUsers && recentUsers.length > 0"
          >
            <div class="list-group-item bg-secondary text-white small fw-bold">
              üìå Ng∆∞·ªùi d√πng g·∫ßn ƒë√¢y ({{ recentUsers.length }})
            </div>
            <button
              type="button"
              class="list-group-item list-group-item-action bg-dark border-secondary d-flex justify-content-between align-items-center"
              *ngFor="let u of recentUsers"
              (click)="selectUser(u)"
            >
              <div>
                <strong>{{ u.name }}</strong>
                <div class="small text-muted">
                  Username: {{ u.username }} ‚Ä¢ ID: {{ u.userId }}
                </div>
              </div>
              <span class="badge bg-info text-dark">{{
                u.role || u.roles[0] || "User"
              }}</span>
            </button>
          </div>

          <!-- Input T√¨m ki·∫øm -->
          <div class="position-relative mb-3" *ngIf="!selectedUser">
            <div class="input-group input-group-lg shadow-sm">
              <span
                class="input-group-text bg-secondary text-white border-secondary"
              >
                <i class="fa-solid fa-magnifying-glass"></i>
              </span>
              <input
                type="text"
                class="form-control bg-dark text-white border-secondary"
                placeholder="Nh·∫≠p t√™n ho·∫∑c username..."
                [ngModel]="userSearchTerm"
                (ngModelChange)="onUserSearchChange($event)"
                autocomplete="off"
              />
            </div>

            <!-- List g·ª£i √Ω -->
            <div
              class="list-group position-absolute w-100 mt-1 shadow"
              style="z-index: 1000"
              *ngIf="users.length > 0"
            >
              <button
                type="button"
                class="list-group-item list-group-item-action bg-dark border-secondary d-flex justify-content-between align-items-center"
                *ngFor="let u of users"
                (click)="selectUser(u)"
              >
                <div>
                  <strong>{{ u.name }}</strong>
                  <div class="small text-muted">
                    Username: {{ u.username }} ‚Ä¢ ID: {{ u.userId }}
                  </div>
                </div>
                <span class="badge bg-info text-dark">{{
                  u.role || u.roles[0] || "User"
                }}</span>
              </button>
            </div>
          </div>

          <!-- Th·∫ª User ƒë√£ ch·ªçn + Smart validation -->
          <div
            class="selected-card p-3 rounded border border-success bg-dark text-white"
            *ngIf="selectedUser"
          >
            <div class="d-flex justify-content-between align-items-start">
              <div class="me-3">
                <h5 class="mb-1 text-success">{{ selectedUser.name }}</h5>
                <p class="mb-0 small">
                  Username:
                  <span class="fw-bold">{{ selectedUser.username }}</span> | ID:
                  <span class="fw-bold">{{ selectedUser.userId }}</span>
                </p>
                <p class="mb-0 small" *ngIf="selectedUser.email">
                  Email: <span class="fw-bold">{{ selectedUser.email }}</span>
                </p>
                <p class="mb-0 small">
                  Vai tr√≤:
                  <span class="fw-bold">{{
                    selectedUser.role || selectedUser.roles[0] || "User"
                  }}</span>
                </p>
                <div *ngIf="selectedUser.role === 'Student'" class="mt-2">
                  <label class="form-label text-white">L·ªõp h·ªçc:</label>
                  <input
                    type="text"
                    class="form-control form-control-sm bg-dark text-white border-secondary"
                    [(ngModel)]="selectedUser.className"
                    placeholder="Nh·∫≠p l·ªõp h·ªçc..."
                  />
                </div>
              </div>
              <div class="grow">
                <div
                  class="alert"
                  [ngClass]="
                    userSummary.blocked ? 'alert-danger' : 'alert-secondary'
                  "
                >
                  <div
                    class="d-flex justify-content-between align-items-center mb-2"
                  >
                    <span class="fw-bold">Ki·ªÉm tra ƒëi·ªÅu ki·ªán m∆∞·ª£n</span>
                    <span
                      class="badge"
                      [ngClass]="
                        userSummary.blocked ? 'bg-danger' : 'bg-success'
                      "
                    >
                      {{ userSummary.blocked ? "Ch·∫∑n m∆∞·ª£n" : "ƒê·ªß ƒëi·ªÅu ki·ªán" }}
                    </span>
                  </div>
                  <div class="d-flex flex-wrap gap-2 small">
                    <span class="badge bg-dark border border-secondary"
                      >ƒêang m∆∞·ª£n: {{ userSummary.activeLoans }}/{{
                        userSummary.maxLoans
                      }}</span
                    >
                    <span
                      class="badge"
                      [ngClass]="
                        userSummary.overdueCount > 0
                          ? 'bg-danger'
                          : 'bg-secondary'
                      "
                      >Qu√° h·∫°n: {{ userSummary.overdueCount }}</span
                    >
                    <span
                      class="badge"
                      [ngClass]="
                        userSummary.totalFine > 0
                          ? 'bg-warning text-dark'
                          : 'bg-secondary'
                      "
                    >
                      Ph√≠ ph·∫°t: {{ userSummary.totalFine | number: "1.0-0" }} ƒë
                    </span>
                  </div>
                  <div
                    *ngIf="userSummary.blocked"
                    class="mt-2 text-danger small fw-bold"
                  >
                    ‚ö†Ô∏è {{ userSummary.blockReason }}
                  </div>
                  <div *ngIf="selectedUser.loanHistory?.length" class="mt-2">
                    <span class="small text-info">L·ªãch s·ª≠ g·∫ßn ƒë√¢y:</span>
                    <ul class="list-group list-group-flush mt-1">
                      <li
                        class="list-group-item bg-dark text-white border-secondary"
                        *ngFor="let l of selectedUser.loanHistory"
                      >
                        <span class="fw-bold">{{ l.bookName }}</span>
                        <span class="text-info"
                          >({{ l.loanDate | date: "dd/MM/yyyy" }})</span
                        >
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
              <button
                class="btn btn-outline-danger btn-sm ms-2"
                (click)="clearSelectedUser()"
              >
                <i class="fa-solid fa-times"></i> B·ªè ch·ªçn
              </button>
            </div>
          </div>
        </div>

        <!-- C·ªòT 2: CH·ªåN S√ÅCH -->
        <div class="col-md-6">
          <h5
            class="text-warning mb-3 d-flex align-items-center justify-content-between"
          >
            <span class="d-flex align-items-center gap-2">
              <i class="fa-solid fa-book me-1"></i>
              <span>B∆∞·ªõc 2: Qu√©t/Ch·ªçn S√°ch (POS)</span>
              <span class="badge bg-info text-dark"
                >{{ cartCount }} trong gi·ªè</span
              >
            </span>
            <button
              class="btn btn-outline-info btn-sm"
              type="button"
              (click)="openScanner()"
            >
              <i class="fa-solid fa-barcode me-1"></i> Scan Barcode
            </button>
          </h5>

          <!-- Input T√¨m ki·∫øm -->
          <div class="position-relative mb-3" *ngIf="!selectedBook">
            <div class="input-group input-group-lg shadow-sm">
              <span
                class="input-group-text bg-secondary text-white border-secondary"
              >
                <i class="fa-solid fa-magnifying-glass"></i>
              </span>
              <input
                type="text"
                class="form-control bg-dark text-white border-secondary"
                placeholder="Nh·∫≠p t√™n s√°ch ho·∫∑c ISBN..."
                [ngModel]="bookSearchTerm"
                (ngModelChange)="onBookSearchChange($event)"
                autocomplete="off"
              />
            </div>

            <!-- List g·ª£i √Ω -->
            <div
              class="list-group position-absolute w-100 mt-1 shadow"
              style="z-index: 1000"
              *ngIf="books.length > 0"
            >
              <button
                type="button"
                class="list-group-item list-group-item-action bg-dark text-white border-secondary book-suggestion-item"
                *ngFor="let b of books"
                (click)="selectBook(b)"
                [disabled]="b.numberOfCopiesAvailable === 0"
                [title]="b.numberOfCopiesAvailable === 0 ? 'S√°ch ƒë√£ h·∫øt' : ''"
              >
                <div class="d-flex align-items-center">
                  <img
                    [src]="b.coverUrl || 'assets/images/placeholder.png'"
                    style="width: 40px; height: 55px; object-fit: cover"
                    class="me-2 rounded"
                  />
                  <div>
                    <div class="fw-bold">{{ b.name }}</div>
                    <small class="text-muted"
                      >ISBN: {{ b.isbn || "N/A" }}</small
                    >
                    <div class="small">
                      <span
                        [ngClass]="
                          b.numberOfCopiesAvailable > 0
                            ? 'text-success'
                            : 'text-danger'
                        "
                        >C√≤n: {{ b.numberOfCopiesAvailable }}</span
                      >
                    </div>
                  </div>
                </div>
              </button>
            </div>
          </div>

          <!-- Gi·ªè s√°ch ƒë√£ qu√©t/ch·ªçn -->
          <div
            class="selected-card p-3 rounded border border-warning bg-dark text-white"
            *ngIf="cartCount > 0"
          >
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="fw-bold text-warning">
                Danh s√°ch ƒëang m∆∞·ª£n ({{ cartCount }})
              </div>
              <button
                class="btn btn-sm btn-outline-light"
                type="button"
                (click)="resetBooksOnly()"
              >
                <i class="fa-solid fa-rotate-left me-1"></i>Xo√° s·∫°ch gi·ªè
              </button>
            </div>
            <div class="list-group list-group-flush bg-dark">
              <div
                class="list-group-item bg-dark text-white border-secondary d-flex align-items-center justify-content-between"
                *ngFor="let b of cartBooks"
              >
                <div class="d-flex align-items-center">
                  <img
                    [src]="b.coverUrl || 'assets/images/placeholder.png'"
                    style="width: 42px; height: 60px; object-fit: cover"
                    class="me-2 rounded"
                  />
                  <div>
                    <div class="fw-bold">{{ b.name }}</div>
                    <div class="small text-muted">
                      ISBN: {{ b.isbn || "N/A" }} | C√≤n:
                      {{ b.numberOfCopiesAvailable }}
                    </div>
                  </div>
                </div>
                <div class="d-flex align-items-center gap-2">
                  <span class="badge bg-secondary">ID {{ b.id }}</span>
                  <button
                    class="btn btn-outline-danger btn-sm"
                    (click)="removeBookFromCart(b.id)"
                  >
                    <i class="fa-solid fa-times"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Th·∫ª S√°ch ƒë√£ ch·ªçn (preview cu·ªëi) -->
          <div
            class="selected-card p-3 rounded border border-warning bg-dark text-white"
            *ngIf="selectedBook"
          >
            <div class="d-flex align-items-start">
              <img
                [src]="selectedBook.coverUrl || 'assets/images/placeholder.png'"
                style="width: 70px; height: 100px; object-fit: cover"
                class="me-3 rounded shadow-sm"
              />
              <div class="grow">
                <h5 class="mb-1 text-warning">{{ selectedBook.name }}</h5>
                <p class="mb-1 small">
                  T√°c gi·∫£:
                  <span
                    *ngFor="let a of selectedBook.authors"
                    class="fw-bold text-info me-1"
                    >{{ a.name }}</span
                  >
                </p>
                <span class="badge bg-secondary"
                  >ID: {{ selectedBook.id }}</span
                >
                <p class="mb-1 small">
                  NƒÉm XB:
                  <span class="fw-bold">{{ selectedBook.publishedYear }}</span>
                </p>
                <p class="mb-1 small">
                  ISBN: <span class="fw-bold">{{ selectedBook.isbn }}</span>
                </p>
                <p class="mb-1 small">
                  S·ªë l∆∞·ª£ng c√≤n:
                  <span
                    [ngClass]="
                      selectedBook.numberOfCopiesAvailable > 0
                        ? 'text-success fw-bold'
                        : 'text-danger fw-bold'
                    "
                    >{{ selectedBook.numberOfCopiesAvailable }}</span
                  >
                </p>
                <div
                  *ngIf="selectedBook.numberOfCopiesAvailable === 0"
                  class="alert alert-danger p-2 mt-2 text-white"
                >
                  S√°ch ƒë√£ h·∫øt, kh√¥ng th·ªÉ c·∫•p!
                </div>
                <div
                  class="mt-3 p-2 rounded border border-secondary bg-opacity-50 bg-black"
                >
                  <div
                    class="d-flex justify-content-between align-items-center"
                  >
                    <span class="text-info fw-bold">AI G·ª£i √Ω</span>
                    <span
                      *ngIf="aiLoading"
                      class="spinner-border spinner-border-sm text-info"
                    ></span>
                  </div>
                  <p class="mb-0 small" [class.text-muted]="!aiSuggestion">
                    {{
                      aiSuggestion ||
                        "ƒêang ch·ªù ch·ªçn ng∆∞·ªùi d√πng & s√°ch ƒë·ªÉ g·ª£i √Ω..."
                    }}
                  </p>
                </div>
              </div>
              <button
                class="btn btn-outline-danger btn-sm"
                (click)="clearSelectedBook()"
              >
                <i class="fa-solid fa-times"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <hr class="border-secondary my-4" />

      <!-- B∆Ø·ªöC 3: C·∫§U H√åNH & SUBMIT -->
      <form #loanForm="ngForm" (ngSubmit)="createLoan()">
        <div class="row align-items-end">
          <div class="col-md-4">
            <label class="form-label">Th·ªùi h·∫°n m∆∞·ª£n (Ng√†y)</label>
            <select
              class="form-select bg-dark text-white border-secondary"
              name="loanDays"
              [(ngModel)]="loanDays"
            >
              <option [ngValue]="7">7 Ng√†y (1 tu·∫ßn)</option>
              <option [ngValue]="14">14 Ng√†y (2 tu·∫ßn)</option>
              <option [ngValue]="30">30 Ng√†y (1 th√°ng)</option>
            </select>
          </div>
          <div class="col-md-8 text-end">
            <button
              class="btn btn-outline-secondary btn-lg me-2"
              type="button"
              (click)="cancel()"
            >
              <i class="fa-solid fa-arrow-left me-2"></i> Hu·ª∑
            </button>
            <button
              class="btn btn-lg btn-success px-5"
              type="submit"
              [disabled]="
                !selectedUser ||
                cartCount === 0 ||
                isLoading ||
                userSummary.blocked
              "
            >
              <span
                *ngIf="isLoading"
                class="spinner-border spinner-border-sm me-2"
              ></span>
              <i class="fa-solid fa-check-circle me-2" *ngIf="!isLoading"></i>
              X√°c Nh·∫≠n {{ cartCount }} S√°ch
            </button>
            <div *ngIf="userSummary.blocked" class="text-danger small mt-2">
              N√∫t b·ªã kho√°: {{ userSummary.blockReason }}
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Bulk Import Progress Modal -->
<div
  class="modal fade show d-block"
  *ngIf="showBulkModal"
  tabindex="-1"
  style="background-color: rgba(0, 0, 0, 0.7)"
>
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content bg-dark text-light border-warning">
      <div class="modal-header border-warning">
        <h5 class="modal-title">
          <i class="fa-solid fa-file-import text-warning me-2"></i>
          Nh·∫≠p phi·∫øu m∆∞·ª£n h√†ng lo·∫°t
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          (click)="closeBulkModal()"
          [disabled]="bulkImporting"
        ></button>
      </div>
      <div class="modal-body">
        <div *ngIf="bulkImporting" class="text-center py-4">
          <div
            class="spinner-border text-warning mb-3"
            style="width: 3rem; height: 3rem"
          ></div>
          <p class="h5">
            ƒêang x·ª≠ l√Ω... {{ bulkResults.success }}/{{ bulkResults.total }}
          </p>
        </div>

        <div *ngIf="!bulkImporting && bulkResults.total > 0">
          <div class="alert alert-success">
            <h6 class="mb-2">
              <i class="fa-solid fa-check-circle me-2"></i>
              Ho√†n t·∫•t: {{ bulkResults.success }}/{{ bulkResults.total }} th√†nh
              c√¥ng
            </h6>
            <div class="progress" style="height: 25px">
              <div
                class="progress-bar bg-success"
                [style.width.%]="
                  (bulkResults.success / bulkResults.total) * 100
                "
              >
                {{
                  ((bulkResults.success / bulkResults.total) * 100).toFixed(1)
                }}%
              </div>
            </div>
          </div>

          <div *ngIf="bulkResults.errors.length > 0" class="alert alert-danger">
            <h6 class="mb-2">
              <i class="fa-solid fa-exclamation-triangle me-2"></i>
              L·ªói ({{ bulkResults.errors.length }})
            </h6>
            <div class="overflow-auto" style="max-height: 250px">
              <ul class="mb-0 small">
                <li *ngFor="let err of bulkResults.errors">{{ err }}</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer border-warning">
        <button
          type="button"
          class="btn btn-secondary"
          (click)="closeBulkModal()"
          [disabled]="bulkImporting"
        >
          {{ bulkImporting ? "ƒêang x·ª≠ l√Ω..." : "ƒê√≥ng" }}
        </button>
      </div>
    </div>
  </div>
</div>
