<div class="container-fluid mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">üí∞ Qu·∫£n L√Ω T√†i Ch√≠nh Ph·∫°t</h1>
  </div>

  <!-- Daily Summary Banner -->
  <div *ngIf="dailySummary && activeTab === 'unpaid'" class="alert alert-info">
    <div class="row">
      <div class="col-md-6">
        <h5>
          <i class="fa-solid fa-calendar-day me-2"></i>T·ªïng k·∫øt h√¥m nay ({{
            selectedDate | date: "dd/MM/yyyy"
          }})
        </h5>
      </div>
      <div class="col-md-6 text-end">
        <strong>{{ dailySummary.totalAmount | currency: "VND" }}</strong>
        <span class="text-muted"
          >({{ dailySummary.totalCount }} giao d·ªãch)</span
        >
      </div>
    </div>
    <div
      *ngIf="dailySummary.byMethod && dailySummary.byMethod.length > 0"
      class="mt-2"
    >
      <span
        *ngFor="let m of dailySummary.byMethod"
        class="badge bg-secondary me-2"
      >
        {{ getPaymentMethodLabel(m.method) }}:
        {{ m.amount | currency: "VND" }} ({{ m.count }})
      </span>
    </div>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-tabs mb-3">
    <li class="nav-item">
      <a
        class="nav-link"
        [class.active]="activeTab === 'unpaid'"
        (click)="switchTab('unpaid')"
        style="cursor: pointer"
      >
        <i class="fa-solid fa-exclamation-circle me-1"></i>
        Ch∆∞a thu ({{ unpaidFines.length }})
      </a>
    </li>
    <li class="nav-item">
      <a
        class="nav-link"
        [class.active]="activeTab === 'paid'"
        (click)="switchTab('paid')"
        style="cursor: pointer"
      >
        <i class="fa-solid fa-check-circle me-1"></i>
        L·ªãch s·ª≠ ƒë√£ thu
      </a>
    </li>
  </ul>

  <!-- Bulk Payment Button (only on unpaid tab) -->
  <div
    *ngIf="activeTab === 'unpaid' && selectedFineIds.size > 0"
    class="alert alert-success d-flex justify-content-between align-items-center"
  >
    <div>
      <i class="fa-solid fa-check-double me-2"></i>
      <strong>ƒê√£ ch·ªçn {{ selectedFineIds.size }} kho·∫£n</strong> - T·ªïng:
      <strong>{{ getTotalSelected() | currency: "VND" }}</strong>
    </div>
    <div>
      <button class="btn btn-success me-2" (click)="openBulkPaymentModal()">
        <i class="fa-solid fa-money-bill-wave me-1"></i> Thanh to√°n t·∫•t c·∫£
      </button>
      <button class="btn btn-secondary" (click)="selectedFineIds.clear()">
        <i class="fa-solid fa-xmark me-1"></i> B·ªè ch·ªçn
      </button>
    </div>
  </div>
  <!-- Unpaid Fines Table -->
  <div *ngIf="activeTab === 'unpaid'">
    <div *ngIf="isLoading" class="text-center">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
    <table *ngIf="!isLoading" class="table table-hover">
      <thead>
        <tr>
          <th style="width: 50px">
            <input
              type="checkbox"
              class="form-check-input"
              [checked]="
                selectedFineIds.size === unpaidFines.length &&
                unpaidFines.length > 0
              "
              (change)="toggleAllSelection()"
            />
          </th>
          <th>ID M∆∞·ª£n</th>
          <th>T√™n Ng∆∞·ªùi D√πng</th>
          <th>T√™n S√°ch</th>
          <th>S·ªë Ng√†y Qu√° H·∫°n</th>
          <th>S·ªë Ti·ªÅn Ph·∫°t</th>
          <th style="width: 250px">H√†nh ƒê·ªông</th>
        </tr>
      </thead>
      <tbody>
        <tr
          *ngFor="let fine of unpaidFines"
          [class.table-info]="isSelected(fine.loanId)"
        >
          <td>
            <input
              type="checkbox"
              class="form-check-input"
              [checked]="isSelected(fine.loanId)"
              (change)="toggleSelection(fine.loanId)"
            />
          </td>
          <td>{{ fine.loanId }}</td>
          <td>{{ fine.userName }}</td>
          <td>{{ fine.bookName }}</td>
          <td>{{ fine.overdueDays }}</td>
          <td>
            <strong>{{ fine.fineAmount | currency: "VND" }}</strong>
          </td>
          <td>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-success" (click)="openPaymentModal(fine)">
                <i class="fa-solid fa-money-bill"></i> ƒê√£ thu
              </button>
              <button
                class="btn btn-info"
                (click)="isWaiving = true; openPaymentModal(fine)"
              >
                <i class="fa-solid fa-hand-holding-heart"></i> Mi·ªÖn gi·∫£m
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
    <div
      *ngIf="!isLoading && unpaidFines.length === 0"
      class="text-center text-muted py-5"
    >
      <i class="fa-solid fa-inbox fa-3x mb-3"></i>
      <p>Kh√¥ng c√≥ ph√≠ ph·∫°t ch∆∞a thu n√†o</p>
    </div>
  </div>

  <!-- Paid Fines Table (Transaction History) -->
  <div *ngIf="activeTab === 'paid'">
    <!-- Filters -->
    <div class="card mb-3">
      <div class="card-body">
        <h5 class="card-title">
          <i class="fa-solid fa-filter me-2"></i>B·ªô l·ªçc
        </h5>
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label">T·ª´ ng√†y</label>
            <input
              type="date"
              class="form-control"
              [(ngModel)]="filterStartDate"
            />
          </div>
          <div class="col-md-3">
            <label class="form-label">ƒê·∫øn ng√†y</label>
            <input
              type="date"
              class="form-control"
              [(ngModel)]="filterEndDate"
            />
          </div>
          <div class="col-md-3">
            <label class="form-label">T√¨m ng∆∞·ªùi d√πng</label>
            <input
              type="text"
              class="form-control"
              [(ngModel)]="filterUser"
              placeholder="T√™n ng∆∞·ªùi d√πng"
            />
          </div>
          <div class="col-md-2">
            <label class="form-label">Ph∆∞∆°ng th·ª©c</label>
            <select class="form-select" [(ngModel)]="filterMethod">
              <option value="">T·∫•t c·∫£</option>
              <option value="CASH">Ti·ªÅn m·∫∑t</option>
              <option value="TRANSFER">Chuy·ªÉn kho·∫£n</option>
              <option value="WAIVED">Mi·ªÖn gi·∫£m</option>
              <option value="OTHER">Kh√°c</option>
            </select>
          </div>
          <div class="col-md-1 d-flex align-items-end">
            <button class="btn btn-primary me-2" (click)="applyFilters()">
              <i class="fa-solid fa-search"></i>
            </button>
            <button class="btn btn-secondary" (click)="clearFilters()">
              <i class="fa-solid fa-rotate-left"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="isLoading" class="text-center">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
    <table *ngIf="!isLoading" class="table table-hover">
      <thead>
        <tr>
          <th>ID M∆∞·ª£n</th>
          <th>Ng∆∞·ªùi n·ªôp</th>
          <th>T√™n S√°ch</th>
          <th>S·ªë ti·ªÅn</th>
          <th>Ph∆∞∆°ng th·ª©c</th>
          <th>Ng√†y thu</th>
          <th>Ng∆∞·ªùi thu</th>
          <th>Ghi ch√∫</th>
          <th>H√†nh ƒë·ªông</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let fine of getFilteredPaidFines()">
          <td>{{ fine.loanId }}</td>
          <td>{{ fine.userName }}</td>
          <td>{{ fine.bookName }}</td>
          <td>
            <strong>{{ fine.fineAmount | currency: "VND" }}</strong>
          </td>
          <td>
            <span
              class="badge"
              [class.bg-success]="fine.paymentMethod === 'CASH'"
              [class.bg-primary]="fine.paymentMethod === 'TRANSFER'"
              [class.bg-warning]="fine.paymentMethod === 'WAIVED'"
              [class.bg-secondary]="fine.paymentMethod === 'OTHER'"
            >
              {{ getPaymentMethodLabel(fine.paymentMethod || "") }}
            </span>
          </td>
          <td>{{ fine.paymentDate | date: "dd/MM/yyyy HH:mm" }}</td>
          <td>{{ fine.paidBy || "-" }}</td>
          <td>
            <small>{{ fine.paymentNote || "-" }}</small>
          </td>
          <td>
            <button
              class="btn btn-sm btn-outline-secondary"
              (click)="printReceipt(fine)"
            >
              <i class="fa-solid fa-print"></i> In bi√™n lai
            </button>
          </td>
        </tr>
      </tbody>
    </table>
    <div
      *ngIf="!isLoading && getFilteredPaidFines().length === 0"
      class="text-center text-muted py-5"
    >
      <i class="fa-solid fa-inbox fa-3x mb-3"></i>
      <p>Kh√¥ng c√≥ l·ªãch s·ª≠ giao d·ªãch n√†o</p>
    </div>
  </div>

  <!-- Payment Method Modal -->
  <div class="modal-backdrop-custom" *ngIf="isPaymentModalOpen">
    <div class="modal-dialog-custom">
      <div class="modal-content-custom">
        <div class="modal-header-custom">
          <h5 class="modal-title">
            <ng-container *ngIf="!isWaiving"
              >X√°c nh·∫≠n ƒë√£ thu ti·ªÅn ph·∫°t</ng-container
            >
            <ng-container *ngIf="isWaiving">Mi·ªÖn gi·∫£m ph√≠ ph·∫°t</ng-container>
          </h5>
        </div>
        <div class="modal-body-custom">
          <div *ngIf="selectedFine" class="mb-3">
            <div class="alert alert-info">
              <strong>{{ selectedFine.userName }}</strong> -
              {{ selectedFine.bookName }}<br />
              <strong
                >S·ªë ti·ªÅn:
                {{ selectedFine.fineAmount | currency: "VND" }}</strong
              >
            </div>
          </div>
          <div class="form-group mb-3" *ngIf="!isWaiving">
            <label for="paymentMethod">Ph∆∞∆°ng th·ª©c thanh to√°n</label>
            <select
              id="paymentMethod"
              class="form-control"
              [(ngModel)]="selectedPaymentMethod"
            >
              <option value="CASH">Ti·ªÅn m·∫∑t</option>
              <option value="TRANSFER">Chuy·ªÉn kho·∫£n</option>
              <option value="OTHER">Kh√°c</option>
            </select>
          </div>
          <div class="form-group mb-3">
            <label for="paymentNote">{{
              isWaiving ? "L√Ω do mi·ªÖn gi·∫£m (b·∫Øt bu·ªôc)" : "Ghi ch√∫ (t√πy ch·ªçn)"
            }}</label>
            <textarea
              id="paymentNote"
              class="form-control"
              rows="3"
              [(ngModel)]="paymentNote"
              [placeholder]="
                isWaiving
                  ? 'VD: H·ªçc sinh ·ªëm n·∫∑ng c√≥ gi·∫•y x√°c nh·∫≠n...'
                  : 'VD: M√£ giao d·ªãch, s·ªë bi√™n lai...'
              "
            ></textarea>
          </div>
        </div>
        <div class="modal-footer-custom">
          <button
            class="btn btn-secondary"
            (click)="closePaymentModal(); isWaiving = false"
          >
            H·ªßy
          </button>
          <button
            class="btn"
            [class.btn-primary]="!isWaiving"
            [class.btn-warning]="isWaiving"
            (click)="confirmPayment()"
          >
            <ng-container *ngIf="!isWaiving">
              <i class="fa-solid fa-check me-1"></i> X√°c nh·∫≠n ƒë√£ thu
            </ng-container>
            <ng-container *ngIf="isWaiving">
              <i class="fa-solid fa-hand-holding-heart me-1"></i> X√°c nh·∫≠n mi·ªÖn
              gi·∫£m
            </ng-container>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Payment Modal -->
  <div class="modal-backdrop-custom" *ngIf="isBulkPaymentModalOpen">
    <div class="modal-dialog-custom">
      <div class="modal-content-custom">
        <div class="modal-header-custom">
          <h5 class="modal-title">
            Thanh to√°n g·ªôp {{ selectedFineIds.size }} kho·∫£n
          </h5>
        </div>
        <div class="modal-body-custom">
          <div class="alert alert-success mb-3">
            <strong
              >T·ªïng ti·ªÅn: {{ getTotalSelected() | currency: "VND" }}</strong
            ><br />
            S·ªë kho·∫£n: {{ selectedFineIds.size }}
          </div>
          <div class="form-group mb-3">
            <label for="bulkPaymentMethod">Ph∆∞∆°ng th·ª©c thanh to√°n</label>
            <select
              id="bulkPaymentMethod"
              class="form-control"
              [(ngModel)]="bulkPaymentMethod"
            >
              <option value="CASH">Ti·ªÅn m·∫∑t</option>
              <option value="TRANSFER">Chuy·ªÉn kho·∫£n</option>
              <option value="OTHER">Kh√°c</option>
            </select>
          </div>
          <div class="form-group mb-3">
            <label for="bulkPaymentNote">Ghi ch√∫ chung (t√πy ch·ªçn)</label>
            <textarea
              id="bulkPaymentNote"
              class="form-control"
              rows="3"
              [(ngModel)]="bulkPaymentNote"
              placeholder="VD: Thu g·ªôp cu·ªëi th√°ng, m√£ giao d·ªãch..."
            ></textarea>
          </div>
        </div>
        <div class="modal-footer-custom">
          <button class="btn btn-secondary" (click)="closeBulkPaymentModal()">
            H·ªßy
          </button>
          <button class="btn btn-success" (click)="confirmBulkPayment()">
            <i class="fa-solid fa-check-double me-1"></i> X√°c nh·∫≠n thanh to√°n
            t·∫•t c·∫£
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
