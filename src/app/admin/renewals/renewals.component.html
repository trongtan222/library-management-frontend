<div class="container py-4">
  <h2 class="mb-3">Yêu cầu gia hạn mượn sách</h2>

  <!-- BULK ACTION BANNER -->
  <div
    *ngIf="canBulkAction()"
    class="alert alert-info d-flex align-items-center justify-content-between mb-3"
  >
    <span>
      <i class="fa-solid fa-check-double"></i>
      <strong>Đã chọn {{ getSelectedCount() }} yêu cầu</strong>
    </span>
    <div class="btn-group">
      <button class="btn btn-success btn-sm" (click)="bulkApprove()">
        <i class="fa-solid fa-check"></i> Duyệt tất cả
      </button>
      <button class="btn btn-danger btn-sm" (click)="bulkReject()">
        <i class="fa-solid fa-times"></i> Từ chối tất cả
      </button>
    </div>
  </div>

  <!-- FILTER -->
  <div class="mb-3">
    <select
      class="form-select w-auto d-inline"
      [(ngModel)]="filter"
      (change)="load()"
    >
      <option value="PENDING">Đang chờ</option>
      <option value="APPROVED">Đã duyệt</option>
      <option value="REJECTED">Từ chối</option>
      <option value="ALL">Tất cả</option>
    </select>
  </div>

  <!-- LOADING -->
  <div *ngIf="loading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status"></div>
    <p class="mt-2">Đang tải...</p>
  </div>

  <!-- TABLE -->
  <div *ngIf="!loading" class="table-responsive">
    <table class="table table-dark table-striped table-bordered align-middle">
      <thead>
        <tr>
          <th style="width: 40px">
            <input
              type="checkbox"
              class="form-check-input"
              [checked]="isAllSelected()"
              (change)="selectAll()"
              [disabled]="getPendingCount() === 0"
            />
          </th>
          <th style="width: 50px">ID</th>
          <th style="width: 60px"></th>
          <th style="width: 20%">Sách</th>
          <th style="width: 20%">Người mượn</th>
          <th style="width: 80px">Thêm ngày</th>
          <th style="width: 25%">Lý do</th>
          <th style="width: 120px">Gợi ý</th>
          <th style="width: 100px">Trạng thái</th>
          <th style="width: 100px">Thời gian</th>
          <th style="width: 150px">Thao tác</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let r of items" [class.table-info]="isSelected(r.id)">
          <!-- CHECKBOX -->
          <td>
            <input
              type="checkbox"
              class="form-check-input"
              [checked]="isSelected(r.id)"
              (change)="toggleSelection(r.id)"
              [disabled]="r.status !== 'PENDING'"
            />
          </td>

          <!-- ID -->
          <td>{{ r.id }}</td>

          <!-- BOOK THUMBNAIL -->
          <td>
            <img
              [src]="r.bookCoverUrl || 'assets/books/placeholder.png'"
              alt="Cover"
              class="book-thumbnail"
              onerror="this.src = 'assets/books/placeholder.png'"
            />
          </td>

          <!-- BOOK INFO -->
          <td>
            <div class="book-info">
              <strong>{{ r.bookTitle || "Sách #" + r.loanId }}</strong>
              <div *ngIf="getBookWarning(r)" class="mt-1">
                <span class="badge bg-warning text-dark">
                  {{ getBookWarning(r) }}
                </span>
              </div>
            </div>
          </td>

          <!-- USER INFO -->
          <td>
            <div class="user-info">
              <strong>{{ r.memberName || "User #" + r.memberId }}</strong>
              <div *ngIf="r.memberClass" class="text-muted small">
                {{ r.memberClass }}
              </div>
              <div *ngIf="getUserWarning(r)" class="mt-1">
                <span class="badge bg-danger">
                  {{ getUserWarning(r) }}
                </span>
              </div>
            </div>
          </td>

          <!-- EXTRA DAYS -->
          <td>
            <span class="badge bg-primary">+{{ r.extraDays }} ngày</span>
          </td>

          <!-- REASON -->
          <td>
            <div class="reason-box" *ngIf="r.reason; else noReason">
              <i class="fa-solid fa-quote-left text-muted"></i>
              {{ r.reason }}
            </div>
            <ng-template #noReason>
              <span class="text-muted fst-italic">Không có lý do</span>
            </ng-template>
          </td>

          <!-- SMART SUGGESTION -->
          <td>
            <span
              *ngIf="getSuggestionBadge(r) as suggestion"
              [class]="suggestion.class"
            >
              {{ suggestion.text }}
            </span>
          </td>

          <!-- STATUS -->
          <td>
            <span
              [ngClass]="{
                'badge bg-secondary': r.status === 'PENDING',
                'badge bg-success': r.status === 'APPROVED',
                'badge bg-danger': r.status === 'REJECTED',
              }"
            >
              {{
                r.status === "PENDING"
                  ? "Chờ duyệt"
                  : r.status === "APPROVED"
                    ? "Đã duyệt"
                    : "Từ chối"
              }}
            </span>
          </td>

          <!-- TIME -->
          <td>
            <small>{{ r.createdAt | date: "dd/MM HH:mm" }}</small>
          </td>

          <!-- ACTIONS -->
          <td>
            <div class="btn-group-vertical btn-group-sm" role="group">
              <button
                class="btn btn-success"
                (click)="approve(r.id)"
                [disabled]="r.status !== 'PENDING'"
                title="Phê duyệt"
              >
                <i class="fa-solid fa-check"></i> Duyệt
              </button>
              <button
                class="btn btn-outline-danger"
                (click)="reject(r.id)"
                [disabled]="r.status !== 'PENDING'"
                title="Từ chối"
              >
                <i class="fa-solid fa-times"></i> Từ chối
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- EMPTY STATE -->
    <div *ngIf="items.length === 0" class="text-center text-muted py-5">
      <i class="fa-solid fa-inbox fa-3x mb-3"></i>
      <p>Không có yêu cầu gia hạn nào</p>
    </div>
  </div>
</div>
