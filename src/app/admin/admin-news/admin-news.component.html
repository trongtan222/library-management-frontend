<div class="container py-3">
  <h2><i class="fa-solid fa-newspaper"></i> Tin Tức Hệ Thống</h2>

  <!-- CREATE FORM -->
  <div class="card mt-3">
    <div class="card-header bg-primary text-white">
      <i class="fa-solid fa-plus"></i> Tạo tin mới
    </div>
    <div class="card-body">
      <!-- Title -->
      <div class="mb-3">
        <label class="form-label fw-bold"
          >Tiêu đề <span class="text-danger">*</span></label
        >
        <input
          class="form-control"
          [(ngModel)]="newItem.title"
          placeholder="Nhập tiêu đề tin tức"
        />
      </div>

      <!-- Cover Image Upload -->
      <div class="mb-3">
        <label class="form-label fw-bold">Ảnh bìa</label>
        <div class="input-group">
          <input
            type="file"
            class="form-control"
            accept="image/*"
            (change)="onImageSelect($event, false)"
            [disabled]="uploadingImage"
          />
          <button
            class="btn btn-outline-secondary"
            type="button"
            (click)="removeImage(false)"
            [disabled]="!previewImageUrl"
          >
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <div *ngIf="previewImageUrl" class="mt-2">
          <img
            [src]="getImageUrl(previewImageUrl)"
            alt="Preview"
            class="img-thumbnail"
            style="max-height: 200px"
          />
        </div>
        <small class="text-muted"
          >Khuyến nghị: 1200x630px, định dạng JPG/PNG</small
        >
      </div>

      <!-- Content (Rich Text Editor) -->
      <div class="mb-3">
        <label class="form-label fw-bold">Nội dung</label>
        <quill-editor
          [(ngModel)]="newItem.content"
          [modules]="quillConfig"
          placeholder="Nhập nội dung tin tức..."
          [styles]="{ height: '250px' }"
        ></quill-editor>
      </div>

      <!-- Status & Scheduling -->
      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label fw-bold">Trạng thái</label>
          <select class="form-select" [(ngModel)]="newItem.status">
            <option value="PUBLISHED">Công khai ngay</option>
            <option value="DRAFT">Lưu nháp</option>
          </select>
        </div>
        <div class="col-md-6" *ngIf="newItem.status === 'DRAFT'">
          <label class="form-label fw-bold">Hẹn giờ đăng</label>
          <input
            type="datetime-local"
            class="form-control"
            [(ngModel)]="newItem.publishedAt"
          />
          <small class="text-muted">Để trống = không tự động đăng</small>
        </div>
      </div>

      <!-- Pinned Checkbox -->
      <div class="form-check mb-3">
        <input
          class="form-check-input"
          type="checkbox"
          id="pinNewItem"
          [(ngModel)]="newItem.isPinned"
        />
        <label class="form-check-label" for="pinNewItem">
          <i class="fa-solid fa-thumbtack text-warning"></i>
          <strong>Ghim tin này lên đầu</strong>
        </label>
      </div>

      <!-- Email Notification -->
      <div class="form-check mb-3">
        <input
          class="form-check-input"
          type="checkbox"
          id="sendEmailCreate"
          [(ngModel)]="sendEmailOnCreate"
        />
        <label class="form-check-label" for="sendEmailCreate">
          <i class="fa-solid fa-envelope"></i>
          Gửi email thông báo đến tất cả người dùng
        </label>
      </div>

      <!-- Action Buttons -->
      <div class="d-flex gap-2">
        <button
          class="btn btn-primary"
          (click)="createWithCheck()"
          [disabled]="uploadingImage"
        >
          <i class="fa-solid fa-paper-plane"></i>
          {{ newItem.status === "DRAFT" ? "Lưu nháp" : "Đăng tin" }}
        </button>
        <button
          class="btn btn-outline-secondary"
          (click)="sendTestEmail(newItem)"
          *ngIf="sendEmailOnCreate"
        >
          <i class="fa-solid fa-flask"></i> Gửi thử cho tôi
        </button>
      </div>
    </div>
  </div>

  <!-- LOADING STATE -->
  <div class="mt-4 text-center" *ngIf="isLoading">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Đang tải...</span>
    </div>
  </div>

  <!-- NEWS LIST -->
  <div class="mt-4" *ngIf="!isLoading">
    <h4 class="mb-3">
      <i class="fa-solid fa-list"></i> Danh sách tin tức ({{ items.length }})
    </h4>

    <div class="list-group">
      <div
        class="list-group-item"
        *ngFor="let item of items"
        [class.border-warning]="item.isPinned"
        [class.border-3]="item.isPinned"
      >
        <!-- VIEW MODE -->
        <div *ngIf="!editing || editing.id !== item.id; else editTpl">
          <!-- Status & Pin Badges -->
          <div class="d-flex gap-2 mb-2">
            <span
              class="badge bg-warning text-dark"
              *ngIf="item.isPinned"
              title="Tin ghim"
            >
              <i class="fa-solid fa-thumbtack"></i> Ghim
            </span>
            <span
              class="badge bg-secondary"
              *ngIf="item.status === 'DRAFT'"
              title="Nháp"
            >
              <i class="fa-solid fa-file"></i> Nháp
            </span>
            <span
              class="badge bg-success"
              *ngIf="item.status === 'PUBLISHED'"
              title="Đã công khai"
            >
              <i class="fa-solid fa-check"></i> Công khai
            </span>
            <span
              class="badge bg-info text-dark"
              *ngIf="item.publishedAt && item.status === 'DRAFT'"
              title="Hẹn giờ đăng"
            >
              <i class="fa-regular fa-clock"></i>
              {{ item.publishedAt | date: "dd/MM/yyyy HH:mm" }}
            </span>
          </div>

          <!-- Cover Image -->
          <img
            *ngIf="item.coverImageUrl"
            [src]="getImageUrl(item.coverImageUrl)"
            alt="Cover"
            class="img-fluid rounded mb-3"
            style="max-height: 300px; object-fit: cover; width: 100%"
          />

          <!-- Title & Content -->
          <h5 class="mb-2">
            <i class="fa-solid fa-bookmark text-primary"></i>
            {{ item.title }}
          </h5>
          <div
            class="mb-2 news-content"
            [innerHTML]="item.content"
            style="max-height: 150px; overflow: hidden"
          ></div>

          <!-- Metadata -->
          <small class="text-muted">
            <i class="fa-regular fa-calendar"></i>
            Tạo lúc: {{ item.createdAt | date: "dd/MM/yyyy HH:mm" }}
          </small>

          <!-- Actions -->
          <div class="mt-3 d-flex gap-2">
            <button
              class="btn btn-sm btn-outline-primary"
              (click)="startEdit(item)"
            >
              <i class="fa-solid fa-pen"></i> Sửa
            </button>
            <button
              class="btn btn-sm btn-outline-danger"
              (click)="delete(item)"
            >
              <i class="fa-solid fa-trash"></i> Xóa
            </button>
          </div>
        </div>

        <!-- EDIT MODE -->
        <ng-template #editTpl>
          <div class="border-start border-4 border-primary ps-3">
            <h6 class="text-primary mb-3">
              <i class="fa-solid fa-pen"></i> Chỉnh sửa tin tức
            </h6>

            <!-- Title -->
            <div class="mb-3">
              <label class="form-label fw-bold">Tiêu đề</label>
              <input class="form-control" [(ngModel)]="editing!.title" />
            </div>

            <!-- Cover Image -->
            <div class="mb-3">
              <label class="form-label fw-bold">Ảnh bìa</label>
              <div class="input-group">
                <input
                  type="file"
                  class="form-control"
                  accept="image/*"
                  (change)="onImageSelect($event, true)"
                  [disabled]="uploadingImage"
                />
                <button
                  class="btn btn-outline-secondary"
                  type="button"
                  (click)="removeImage(true)"
                  [disabled]="!editingImageUrl"
                >
                  <i class="fa-solid fa-xmark"></i>
                </button>
              </div>
              <div *ngIf="editingImageUrl" class="mt-2">
                <img
                  [src]="getImageUrl(editingImageUrl)"
                  alt="Preview"
                  class="img-thumbnail"
                  style="max-height: 200px"
                />
              </div>
            </div>

            <!-- Content -->
            <div class="mb-3">
              <label class="form-label fw-bold">Nội dung</label>
              <quill-editor
                [(ngModel)]="editing!.content"
                [modules]="quillConfig"
                [styles]="{ height: '250px' }"
              ></quill-editor>
            </div>

            <!-- Status & Scheduling -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label fw-bold">Trạng thái</label>
                <select class="form-select" [(ngModel)]="editing!.status">
                  <option value="PUBLISHED">Công khai</option>
                  <option value="DRAFT">Nháp</option>
                </select>
              </div>
              <div class="col-md-6" *ngIf="editing!.status === 'DRAFT'">
                <label class="form-label fw-bold">Hẹn giờ đăng</label>
                <input
                  type="datetime-local"
                  class="form-control"
                  [(ngModel)]="editing!.publishedAt"
                />
              </div>
            </div>

            <!-- Pinned -->
            <div class="form-check mb-3">
              <input
                class="form-check-input"
                type="checkbox"
                id="pinEditItem"
                [(ngModel)]="editing!.isPinned"
              />
              <label class="form-check-label" for="pinEditItem">
                <i class="fa-solid fa-thumbtack text-warning"></i>
                <strong>Ghim tin này</strong>
              </label>
            </div>

            <!-- Email Notification -->
            <div class="form-check mb-3">
              <input
                class="form-check-input"
                type="checkbox"
                id="sendEmailUpdate"
                [(ngModel)]="sendEmailOnUpdate"
              />
              <label class="form-check-label" for="sendEmailUpdate">
                <i class="fa-solid fa-envelope"></i>
                Gửi email thông báo bản cập nhật này
              </label>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex gap-2">
              <button
                class="btn btn-sm btn-primary"
                (click)="saveEditWithCheck()"
                [disabled]="uploadingImage"
              >
                <i class="fa-solid fa-save"></i> Lưu
              </button>
              <button
                class="btn btn-sm btn-outline-secondary"
                (click)="sendTestEmail(editing!)"
                *ngIf="sendEmailOnUpdate"
              >
                <i class="fa-solid fa-flask"></i> Gửi thử
              </button>
              <button class="btn btn-sm btn-secondary" (click)="cancelEdit()">
                <i class="fa-solid fa-xmark"></i> Hủy
              </button>
            </div>
          </div>
        </ng-template>
      </div>

      <div class="text-center text-muted py-5" *ngIf="items.length === 0">
        <i class="fa-regular fa-newspaper fa-3x mb-3 d-block"></i>
        <p>Chưa có tin tức nào</p>
      </div>
    </div>
  </div>

  <!-- Email Preview Modal -->
  <app-email-preview-modal
    [show]="showEmailPreview"
    [htmlContent]="emailPreviewHtml"
    [emailSubject]="'Tin tức mới: ' + (previewingItem?.title || '')"
    [recipientCount]="recipientCount"
    [loading]="emailPreviewLoading"
    (confirmed)="onEmailPreviewConfirmed()"
    (cancelled)="onEmailPreviewCancelled()"
  ></app-email-preview-modal>
</div>
