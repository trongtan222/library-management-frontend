<div class="container mt-5">
  <div class="d-flex align-items-center justify-content-between mb-4">
    <div class="d-flex align-items-center">
      <h2 class="text-danger fw-bold mb-0">
        <i class="fa-solid fa-heart me-2"></i>Danh Sách Yêu Thích
      </h2>
      <span class="badge bg-secondary ms-3 fs-6" *ngIf="!isLoading">
        {{ wishlistItems.length }} cuốn sách
      </span>
    </div>

    <!-- Sorting Dropdown -->
    <div class="dropdown" *ngIf="!isLoading && wishlistItems.length > 0">
      <button
        class="btn btn-outline-secondary dropdown-toggle"
        type="button"
        data-bs-toggle="dropdown"
      >
        <i class="fa-solid fa-sort me-1"></i>Sắp xếp
      </button>
      <ul class="dropdown-menu">
        <li>
          <a
            class="dropdown-item"
            (click)="loadWishlist('recent')"
            [class.active]="currentSort === 'recent'"
          >
            <i class="fa-solid fa-clock me-2"></i>Mới nhất
          </a>
        </li>
        <li>
          <a
            class="dropdown-item"
            (click)="loadWishlist('name')"
            [class.active]="currentSort === 'name'"
          >
            <i class="fa-solid fa-arrow-down-a-z me-2"></i>Tên sách A-Z
          </a>
        </li>
      </ul>
    </div>
  </div>

  <!-- Skeleton Loading -->
  <div *ngIf="isLoading" class="row g-4">
    <div class="col-md-3 col-sm-6" *ngFor="let i of [1, 2, 3, 4]">
      <div class="card h-100 shadow-sm border-0">
        <div class="skeleton skeleton-image" style="height: 300px"></div>
        <div class="card-body">
          <div class="skeleton skeleton-text mb-2"></div>
          <div class="skeleton skeleton-text" style="width: 60%"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div
    *ngIf="!isLoading && wishlistItems.length === 0"
    class="text-center py-5 bg-light rounded border"
  >
    <i class="fa-regular fa-heart fa-4x text-muted mb-3"></i>
    <h4 class="text-muted">Danh sách yêu thích đang trống</h4>
    <p class="mb-4">
      Hãy thêm những cuốn sách bạn quan tâm vào đây để xem lại sau.
    </p>
    <a routerLink="/borrow-book" class="btn btn-primary">
      <i class="fa-solid fa-search me-2"></i>Tìm Sách Ngay
    </a>
  </div>

  <!-- Wishlist Items -->
  <div class="row g-4" *ngIf="!isLoading && wishlistItems.length > 0">
    <div class="col-md-3 col-sm-6" *ngFor="let item of wishlistItems">
      <div class="card h-100 shadow-sm border-0 hover-card">
        <div class="position-relative">
          <a [routerLink]="['/books', item.bookId]">
            <img
              [src]="item.coverUrl || 'assets/images/placeholder.png'"
              class="card-img-top"
              alt="{{ item.bookName }}"
              style="height: 300px; object-fit: cover"
            />
          </a>

          <!-- Availability Badge -->
          <span
            [class]="getAvailabilityClass(item.availableCopies)"
            class="position-absolute top-0 start-0 m-2"
          >
            {{ getAvailabilityText(item.availableCopies) }}
          </span>

          <button
            class="btn btn-danger btn-sm position-absolute top-0 end-0 m-2 rounded-circle shadow"
            (click)="remove(item.bookId)"
            title="Bỏ thích"
          >
            <i class="fa-solid fa-times"></i>
          </button>
        </div>

        <div class="card-body d-flex flex-column">
          <h6 class="card-title text-truncate">
            <a
              [routerLink]="['/books', item.bookId]"
              class="text-decoration-none text-dark fw-bold"
            >
              {{ item.bookName }}
            </a>
          </h6>

          <small class="mb-2" *ngIf="item.authorName">
            <i class="fa-solid fa-pen-nib me-1"></i> {{ item.authorName }}
          </small>

          <small class="mb-3 text-muted" *ngIf="item.categoryName">
            <i class="fa-solid fa-tag me-1"></i> {{ item.categoryName }}
          </small>

          <!-- Notes Section -->
          <div class="mb-3 grow">
            <div *ngIf="!editingNotes[item.bookId]">
              <small class="text-muted d-block mb-1">
                <i class="fa-solid fa-note-sticky me-1"></i>Ghi chú:
              </small>
              <p class="small text-secondary fst-italic" *ngIf="item.notes">
                {{ item.notes }}
              </p>
              <p class="small text-muted fst-italic" *ngIf="!item.notes">
                Chưa có ghi chú
              </p>
              <button
                class="btn btn-link btn-sm p-0 text-decoration-none"
                (click)="startEditNotes(item)"
              >
                <i class="fa-solid fa-edit me-1"></i
                >{{ item.notes ? "Sửa" : "Thêm ghi chú" }}
              </button>
            </div>
            <div *ngIf="editingNotes[item.bookId]">
              <textarea
                class="form-control form-control-sm mb-2"
                rows="2"
                [(ngModel)]="tempNotes[item.bookId]"
                placeholder="Ví dụ: Thầy A gợi ý đọc cho đồ án"
              ></textarea>
              <div class="d-flex gap-2">
                <button
                  class="btn btn-success btn-sm"
                  (click)="saveNotes(item)"
                >
                  <i class="fa-solid fa-check"></i> Lưu
                </button>
                <button
                  class="btn btn-secondary btn-sm"
                  (click)="cancelEditNotes(item.bookId)"
                >
                  Hủy
                </button>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="d-flex gap-2 mt-auto">
            <button
              class="btn btn-primary btn-sm grow"
              (click)="borrowBook(item)"
              [disabled]="item.availableCopies <= 0"
            >
              <i class="fa-solid fa-book me-1"></i>
              {{ item.availableCopies > 0 ? "Mượn ngay" : "Đã hết" }}
            </button>
            <a
              [routerLink]="['/books', item.bookId]"
              class="btn btn-outline-secondary btn-sm"
            >
              <i class="fa-solid fa-info-circle"></i>
            </a>
          </div>
        </div>

        <div class="card-footer bg-white text-muted small border-0">
          <i class="fa-regular fa-clock me-1"></i>
          <span>{{ item.addedDate | date: "dd/MM/yyyy" }}</span>
        </div>
      </div>
    </div>
  </div>
</div>
